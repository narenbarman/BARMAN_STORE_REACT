import { useState, useEffect } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { Package, ShoppingCart, Users, TrendingUp, LogOut, Plus, Edit, Trash2, X, FolderOpen, CreditCard, FileText, Truck, ShoppingBag, History, BarChart2, Gift, KeyRound, Eye } from 'lucide-react';
import { statsApi, productsApi, ordersApi, usersApi } from '../services/api';
import ProductForm from './ProductForm';
import CategoryManagement from './CategoryManagement';
import DistributorManagement from './DistributorManagement';
import PurchaseManagement from './PurchaseManagement';
import StockLedgerHistory from './StockLedgerHistory';
import CreditAgingReport from './CreditAgingReport';
import UserEditModal from './UserEditModal';
import BillingTab from './BillingTab';
import BillsViewer from './BillsViewer';
import OfferManagement from './OfferManagement';
import PasswordResetRequests from './PasswordResetRequests';
import './Admin.css';

// Currency formatter with Indian Rupee symbol
const formatCurrency = (amount) => {
  return new Intl.NumberFormat('en-IN', {
    style: 'currency',
    currency: 'INR',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(amount);
};

  const openApproveModal = async (orderId) => {
    try {
      setModalLoading(true);
      const order = await ordersApi.getById(orderId);
      setModalOrder(order);
      setModalItems(order.items || []);
      setShowApproveModal(true);
    } catch (err) {
      showNotification(err.message || 'Failed to load order details', 'error');
    } finally {
      setModalLoading(false);
    }
  };

  const confirmApprove = async () => {
    if (!modalOrder) return;
    try {
      setModalLoading(true);
      await ordersApi.updateStatus(modalOrder.id, 'confirmed');
      setShowApproveModal(false);
      // refresh list
      const updatedOrders = await ordersApi.getAll();
      setOrders(updatedOrders);
      const statsData = await statsApi.orders();
      setStats(statsData);
      showNotification('Order approved and stock applied', 'success');
      // notify customer (simple in-app notification saved to messages table)
      await fetch(`/api/notify-order/${modalOrder.id}`, { method: 'POST' }).catch(() => {});
    } catch (err) {
      showNotification(err.message || 'Failed to approve order', 'error');
    } finally {
      setModalLoading(false);
    }
  };

  const handleUpdateOrderStatus = async (id, status) => {
    if (status === 'cancelled' && !window.confirm('Are you sure you want to cancel this order?')) return;
    if (status === 'confirmed' && !window.confirm('Approve this order and apply stock?')) return;
    try {
      await ordersApi.updateStatus(id, status);
      const updatedOrders = await ordersApi.getAll();
      setOrders(updatedOrders);
      const statsData = await statsApi.orders();
      setStats(statsData);
      showNotification(`Order ${status} successfully`, 'success');
    } catch (error) {
      console.error('Failed to update order status', error);
      showNotification(error.message || 'Failed to update order status', 'error');
    }
  };

  

// Currency formatter with conditional color styling
const formatCurrencyColored = (amount) => {
  const formatted = formatCurrency(Math.abs(amount));
  const isPositive = amount >= 0;
  return <span className={isPositive ? 'amount-positive' : 'amount-negative'}>{formatted}</span>;
};

function Admin({ user }) {
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('dashboard');
  const [stats, setStats] = useState({ totalOrders: 0, totalRevenue: 0, pendingOrders: 0 });
  const [products, setProducts] = useState([]);
  const [orders, setOrders] = useState([]);
  const [users, setUsers] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showProductForm, setShowProductForm] = useState(false);
  const [editingProduct, setEditingProduct] = useState(null);
  const [showCategoryManagement, setShowCategoryManagement] = useState(false);
  const [editingUser, setEditingUser] = useState(null);
  const [showUserForm, setShowUserForm] = useState(false);
  const [isCreatingUser, setIsCreatingUser] = useState(false);
  const [notification, setNotification] = useState(null);
  const [showApproveModal, setShowApproveModal] = useState(false);
  const [modalOrder, setModalOrder] = useState(null);
  const [modalItems, setModalItems] = useState([]);
  const [modalLoading, setModalLoading] = useState(false);

  useEffect(() => {
    // Check if user is admin
    if (user && user.role !== 'admin') {
      navigate('/');
      return;
    }

    fetchData();
  }, [user, navigate]);

  const fetchData = async () => {
    try {
      const [statsData, productsData, ordersData, usersData] = await Promise.all([
        statsApi.orders(),
        productsApi.getAll(),
        ordersApi.getAll(),
        usersApi.getAll()
      ]);

      setStats(statsData);
      setProducts(productsData);
      setOrders(ordersData);
      setUsers(usersData);
    } catch (error) {
      console.error('Error fetching data:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleDeleteProduct = async (id) => {
    if (!window.confirm('Are you sure you want to delete this product?')) return;
    
    try {
      await productsApi.delete(id);
      setProducts(products.filter(p => p.id !== id));
      showNotification('Product deleted successfully', 'success');
      
      // Refresh stats
      const statsData = await statsApi.orders();
      setStats(statsData);
    } catch (error) {
      showNotification('Failed to delete product', 'error');
    }
  };

  const handleDeleteUser = async (id) => {
    if (!window.confirm('Are you sure you want to delete this customer?')) return;
    
    try {
      await usersApi.delete(id);
      setUsers(users.filter(u => u.id !== id));
      showNotification('Customer deleted successfully', 'success');
    } catch (error) {
      showNotification(error.message || 'Failed to delete customer', 'error');
    }
  };

  const handleEditProduct = (product) => {
    setEditingProduct(product);
    setShowProductForm(true);
  };

  const handleAddProduct = () => {
    setEditingProduct(null);
    setShowProductForm(true);
  };

  const handleProductSave = async () => {
    try {
      const updatedProducts = await productsApi.getAll();
      setProducts(updatedProducts);
      
      // Refresh stats
      const statsData = await statsApi.orders();
      setStats(statsData);
      
      showNotification(editingProduct ? 'Product updated successfully' : 'Product added successfully', 'success');
    } catch (error) {
      showNotification('Failed to refresh products', 'error');
    }
  };

  const showNotification = (message, type) => {
    setNotification({ message, type });
    setTimeout(() => setNotification(null), 3000);
  };

  const closeNotification = () => {
    setNotification(null);
  };

  const handleEditUser = (user) => {
    setEditingUser(user);
  };

  const handleUserSave = async () => {
    try {
      const updatedUsers = await usersApi.getAll();
      setUsers(updatedUsers);
      showNotification('User updated successfully', 'success');
    } catch (error) {
      showNotification('Failed to refresh users', 'error');
    }
  };

  const handleAddUser = () => {
    setEditingUser(null);
    setIsCreatingUser(true);
    setShowUserForm(true);
  };

  const handleCreateUser = async () => {
    try {
      const updatedUsers = await usersApi.getAll();
      setUsers(updatedUsers);
      showNotification('User created successfully', 'success');
    } catch (error) {
      showNotification('Failed to refresh users', 'error');
    }
  };

  if (!user || user.role !== 'admin') {
    return (
      <div className="admin-page">
        <div className="admin-container">
          <h1>Access Denied</h1>
          <p>You must be an admin to access this page.</p>
          <Link to="/login" className="admin-btn">Go to Login</Link>
        </div>
      </div>
    );
  }

  return (
    <div className="admin-page">
      {/* Notification */}
      {notification && (
        <div className={`notification ${notification.type}`}>
          <span>{notification.message}</span>
          <button onClick={closeNotification}><X size={16} /></button>
        </div>
      )}

      <div className="admin-sidebar">
        <h2>Admin Panel</h2>
        <nav>
          <button 
            className={activeTab === 'dashboard' ? 'active' : ''}
            onClick={() => setActiveTab('dashboard')}
          >
            <TrendingUp size={20} /> Dashboard
          </button>
          <button 
            className={activeTab === 'products' ? 'active' : ''}
            onClick={() => setActiveTab('products')}
          >
            <Package size={20} /> Products
          </button>
          <button 
            className={activeTab === 'orders' ? 'active' : ''}
            onClick={() => setActiveTab('orders')}
          >
            <ShoppingCart size={20} /> Orders
          </button>
          <button 
            className={activeTab === 'categories' ? 'active' : ''}
            onClick={() => setActiveTab('categories')}
          >
            <FolderOpen size={20} /> Categories
          </button>
          <button 
            className={activeTab === 'users' ? 'active' : ''}
            onClick={() => setActiveTab('users')}
          >
            <Users size={20} /> Users
          </button>
          <button 
            className={activeTab === 'billing' ? 'active' : ''}
            onClick={() => setActiveTab('billing')}
          >
            <FileText size={20} /> Billing
          </button>
          <button 
            className={activeTab === 'view-bills' ? 'active' : ''}
            onClick={() => setActiveTab('view-bills')}
          >
            <Eye size={20} /> View Bills
          </button>
          <button 
            className={activeTab === 'distributors' ? 'active' : ''}
            onClick={() => setActiveTab('distributors')}
          >
            <Truck size={20} /> Distributors
          </button>
          <button 
            className={activeTab === 'purchases' ? 'active' : ''}
            onClick={() => setActiveTab('purchases')}
          >
            <ShoppingBag size={20} /> Purchases
          </button>
          <button 
            className={activeTab === 'stock-ledger' ? 'active' : ''}
            onClick={() => setActiveTab('stock-ledger')}
          >
            <History size={20} /> Stock History
          </button>
          <button 
            className={activeTab === 'credit-aging' ? 'active' : ''}
            onClick={() => setActiveTab('credit-aging')}
          >
            <BarChart2 size={20} /> Credit Aging
          </button>
          <button
            className={activeTab === 'offers' ? 'active' : ''}
            onClick={() => setActiveTab('offers')}
          >
            <Gift size={20} /> Offers
          </button>
          <button
            className={activeTab === 'password-resets' ? 'active' : ''}
            onClick={() => setActiveTab('password-resets')}
          >
            <KeyRound size={20} /> Password Resets
          </button>
          <Link to="/" className="logout-link">
            <LogOut size={20} /> Back to Site
          </Link>
        </nav>
      </div>

      <div className="admin-content">
        {activeTab === 'dashboard' && (
          <div className="dashboard">
            <h1>Dashboard</h1>
            <div className="stats-grid">
              <div className="stat-card">
                <ShoppingCart size={40} />
                <div>
                  <h3>{stats.totalOrders}</h3>
                  <p>Total Orders</p>
                </div>
              </div>
              <div className="stat-card">
                <TrendingUp size={40} />
                <div>
                  <h3>{formatCurrencyColored(stats.totalRevenue)}</h3>
                  <p>Total Revenue</p>
                </div>
              </div>
              <div className="stat-card">
                <Package size={40} />
                <div>
                  <h3>{products.length}</h3>
                  <p>Products</p>
                </div>
              </div>
              <div className="stat-card">
                <Users size={40} />
                <div>
                  <h3>{users.length}</h3>
                  <p>Users</p>
                </div>
              </div>
            </div>
          </div>
        )}

        {activeTab === 'products' && (
          <div className="products-management">
            <div className="section-header">
              <h1>Products Management</h1>
              <button className="admin-btn primary" onClick={handleAddProduct}>
                <Plus size={20} /> Add Product
              </button>
            </div>
            <div className="products-table">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Image</th>
                    <th>Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {products.map(product => (
                    <tr key={product.id}>
                      <td>{product.id}</td>
                      <td>
                        <img 
                          src={product.image} 
                          alt={product.name}
                          className="product-thumbnail"
                          onError={(e) => e.target.src = '/logo.png'}
                        />
                      </td>
                      <td>{product.name}</td>
                      <td>{product.category}</td>
                      <td>{formatCurrencyColored(product.price)}</td>
                      <td>
                        <span className={product.stock < 10 ? 'low-stock' : ''}>
                          {product.stock}
                        </span>
                      </td>
                      <td>
                        <button className="action-btn edit" onClick={() => handleEditProduct(product)}>
                          <Edit size={16} />
                        </button>
                        <button className="action-btn delete" onClick={() => handleDeleteProduct(product.id)}>
                          <Trash2 size={16} />
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === 'orders' && (
          <div className="orders-management">
            <h1>Orders Management</h1>
            <div className="orders-table">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Customer</th>
                    <th>Email</th>
                    <th>Amount</th>
                    <th>Status</th>
                    <th>Actions</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody>
                  {orders.map(order => (
                    <tr key={order.id}>
                      <td>{order.id}</td>
                      <td>{order.customer_name}</td>
                      <td>{order.customer_email}</td>
                      <td>{formatCurrencyColored(order.total_amount)}</td>
                      <td>
                        <span className={`status ${order.status}`}>{order.status}</span>
                      </td>
                      <td>
                        {order.status === 'pending' ? (
                          <div style={{ display: 'flex', gap: '0.5rem' }}>
                            <button className="admin-btn" onClick={() => openApproveModal(order.id)}>Approve</button>
                            <button className="admin-btn" onClick={() => handleUpdateOrderStatus(order.id, 'cancelled')}>Cancel</button>
                          </div>
                        ) : (
                          <span style={{ opacity: 0.8 }}>—</span>
                        )}
                      </td>
                      <td>{new Date(order.created_at).toLocaleDateString()}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === 'categories' && (
          <div className="categories-management">
            <div className="section-header">
              <h1>Categories Management</h1>
              <button className="admin-btn primary" onClick={() => setShowCategoryManagement(true)}>
                <Plus size={20} /> Manage Categories
              </button>
            </div>
            <div className="categories-info">
              <p>Click "Manage Categories" to create, edit, or delete product categories.</p>
            </div>
          </div>
        )}

        {activeTab === 'users' && (
          <div className="users-management">
            <div className="section-header">
              <h1>Users Management</h1>
              <button className="admin-btn primary" onClick={handleAddUser}>
                <Plus size={20} /> Add Customer
              </button>
            </div>
            <div className="users-table">
              <table>
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Role</th>
                    <th>Joined</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {users.map(u => (
                    <tr key={u.id}>
                      <td>{u.id}</td>
                      <td>{u.name}</td>
                      <td>{u.email || '-'}</td>
                      <td>{u.phone || '-'}</td>
                      <td>
                        <span className={`role ${u.role}`}>{u.role}</span>
                      </td>
                      <td>{new Date(u.created_at).toLocaleDateString()}</td>
                      <td>
                        {u.role !== 'admin' ? (
                          <>
                            <Link 
                              to={`/admin/users/${u.id}/credit`}
                              className="action-btn credit"
                              title="Credit History"
                            >
                              <CreditCard size={16} />
                            </Link>
                            <button 
                              className="action-btn edit" 
                              onClick={() => handleEditUser(u)}
                              title="Edit user"
                            >
                              <Edit size={16} />
                            </button>
                            <button 
                              className="action-btn delete" 
                              onClick={() => handleDeleteUser(u.id)}
                              title="Delete user"
                            >
                              <Trash2 size={16} />
                            </button>
                          </>
                        ) : (
                          <span className="admin-badge">Admin</span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === 'billing' && <BillingTab />}
        {activeTab === 'view-bills' && <BillsViewer />}

        {activeTab === 'distributors' && (
          <DistributorManagement user={user} />
        )}

        {activeTab === 'purchases' && (
          <PurchaseManagement user={user} />
        )}

        {activeTab === 'stock-ledger' && (
          <StockLedgerHistory user={user} />
        )}

        {activeTab === 'credit-aging' && (
          <CreditAgingReport user={user} />
        )}
        {activeTab === 'offers' && <OfferManagement />}
        {activeTab === 'password-resets' && <PasswordResetRequests />}
      </div>

      {/* Product Form Modal */}
      {showProductForm && (
        <ProductForm
          product={editingProduct}
          onClose={() => {
            setShowProductForm(false);
            setEditingProduct(null);
          }}
          onSave={handleProductSave}
        />
      )}
    {showApproveModal && modalOrder && (
      <div className="modal-backdrop">
        <div className="modal-card">
          <h2>Approve Order {modalOrder.order_number || `#${modalOrder.id}`}</h2>
          {modalLoading ? (
            <p>Loading...</p>
          ) : (
            <>
              <p>Customer: {modalOrder.customer_name} ({modalOrder.customer_email})</p>
              <div style={{ maxHeight: 300, overflow: 'auto', marginTop: 8 }}>
                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                  <thead>
                    <tr>
                      <th>Product</th>
                      <th>Qty</th>
                      <th>Stock</th>
                    </tr>
                  </thead>
                  <tbody>
                    {modalItems.map(it => (
                      <tr key={it.id}>
                        <td style={{ padding: 6 }}>{it.product_name || it.name}</td>
                        <td style={{ padding: 6 }}>{it.quantity}</td>
                        <td style={{ padding: 6 }}>{/* we will fetch current stock via server when loading */}
                          {it.stock !== undefined ? it.stock : '—'}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div style={{ display: 'flex', gap: 8, marginTop: 12, justifyContent: 'flex-end' }}>
                <button className="admin-btn" onClick={() => setShowApproveModal(false)} disabled={modalLoading}>Close</button>
                <button className="admin-btn primary" onClick={confirmApprove} disabled={modalLoading}>Confirm Approve</button>
              </div>
            </>
          )}
        </div>
      </div>
    )}
      {/* Category Management Modal */}
      {showCategoryManagement && (
        <CategoryManagement
          onClose={() => setShowCategoryManagement(false)}
        />
      )}
      {/* User Edit Modal */}
      {editingUser && (
        <UserEditModal
          user={editingUser}
          onClose={() => {
            setEditingUser(null);
            setShowUserForm(false);
            setIsCreatingUser(false);
          }}
          onSave={handleUserSave}
        />
      )}
      {/* User Create Modal */}
      {showUserForm && isCreatingUser && (
        <UserEditModal
          isCreate={true}
          onClose={() => {
            setShowUserForm(false);
            setIsCreatingUser(false);
          }}
          onSave={handleCreateUser}
        />
      )}
    </div>
  );
}

export default Admin;
