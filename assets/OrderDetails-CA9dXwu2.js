import{B as T,r as i,e as k,j as e,o as l}from"./index-B15Jacgc.js";import{f as p}from"./formatters-C_RfwIqz.js";function F(){const{id:c}=T(),[r,f]=i.useState(null),[b,u]=i.useState(!0),[x,y]=i.useState(null),[g,w]=i.useState([]),[o,d]=i.useState(!1),v=k(),m=()=>{try{return JSON.parse(localStorage.getItem("user")||"{}")}catch{return{}}},a=async()=>{const t=await l.getById(c),n=m(),_=(n==null?void 0:n.role)==="admin",h=(t==null?void 0:t.user_id)??(t==null?void 0:t.customer_id),O=h!=null,S=Number(n==null?void 0:n.id)===Number(h);if(!_&&O&&!S)throw new Error("You are not authorized to view this order");f(t);const N=await l.getHistory(c).catch(()=>[]);w(N||[])};if(i.useEffect(()=>{(async()=>{u(!0),y(null);try{await a()}catch(n){y(n.message||"Failed to load order")}finally{u(!1)}})()},[c]),b)return e.jsx("div",{style:{padding:20},children:"Loading order..."});if(x)return e.jsx("div",{style:{padding:20},className:"error-message",children:x});if(!r)return e.jsx("div",{style:{padding:20},children:"Order not found"});const s=m(),j=(s==null?void 0:s.role)==="admin",C=(r==null?void 0:r.user_id)??(r==null?void 0:r.customer_id),A=!j&&Number(s==null?void 0:s.id)===Number(C)&&r.status==="pending";return e.jsxs("div",{style:{padding:20},children:[e.jsxs("h1",{children:["Order ",r.order_number||`#${r.id}`]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Customer:"})," ",r.customer_name," (",r.customer_email,")"]}),j&&e.jsxs("div",{style:{marginTop:8},children:[e.jsx("button",{onClick:async()=>{if(window.confirm("Approve this order and apply stock?"))try{d(!0),await l.updateStatus(r.id,"confirmed","Approved via details page",s.id),await a(),alert("Order approved")}catch(t){alert(t.message||"Failed to approve")}finally{d(!1)}},className:"admin-btn",disabled:o,children:"Approve"}),e.jsx("button",{onClick:async()=>{if(window.confirm("Cancel this order?"))try{d(!0),await l.updateStatus(r.id,"cancelled","Cancelled via details page",s.id),await a(),alert("Order cancelled")}catch(t){alert(t.message||"Failed to cancel")}finally{d(!1)}},style:{marginLeft:8},className:"admin-btn",disabled:o,children:"Cancel"})]}),A&&e.jsx("div",{style:{marginTop:8},children:e.jsx("button",{onClick:async()=>{if(window.confirm("Cancel this pending order?"))try{d(!0),await l.cancel(r.id,"Cancelled by customer from order details",s.id),await a(),alert("Order cancelled")}catch(t){alert(t.message||"Failed to cancel order")}finally{d(!1)}},className:"admin-btn",disabled:o,children:"Cancel Order"})}),e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",r.status," Â  ",e.jsx("strong",{children:"Payment:"})," ",r.payment_status]}),e.jsx("h3",{children:"Items"}),e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:8},children:"Product"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Qty"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Price"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Total"})]})}),e.jsx("tbody",{children:r.items&&r.items.map(t=>e.jsxs("tr",{style:{borderTop:"1px solid #eee"},children:[e.jsx("td",{style:{padding:8},children:t.product_name}),e.jsx("td",{style:{padding:8},children:t.quantity}),e.jsx("td",{style:{padding:8},children:p(t.price)}),e.jsx("td",{style:{padding:8},children:p(t.total)})]},t.id))})]}),e.jsxs("div",{style:{marginTop:12},children:[e.jsx("strong",{children:"Total:"})," ",p(r.total_amount)]}),e.jsxs("div",{style:{marginTop:20},children:[e.jsx("h3",{children:"Order History"}),g.length===0?e.jsx("p",{children:"No history available"}):e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:8},children:"When"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Status"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"By"}),e.jsx("th",{style:{textAlign:"left",padding:8},children:"Note"})]})}),e.jsx("tbody",{children:g.map(t=>e.jsxs("tr",{style:{borderTop:"1px solid #eee"},children:[e.jsx("td",{style:{padding:8},children:new Date(t.created_at).toLocaleString()}),e.jsx("td",{style:{padding:8},children:t.status}),e.jsx("td",{style:{padding:8},children:t.created_by_name||t.created_by||"System"}),e.jsx("td",{style:{padding:8},children:t.description||"-"})]},t.id))})]})]}),e.jsx("div",{style:{marginTop:12},children:e.jsx("button",{onClick:()=>v(-1),className:"admin-btn",children:"Back"})})]})}export{F as default};
