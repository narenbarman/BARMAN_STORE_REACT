import{c as X,d as Q,r as n,m as b,j as e,U as q,F as $}from"./index-DzGHLpa5.js";import{A as K}from"./arrow-left-SKDE9rNF.js";import{A as B}from"./alert-circle-BCZKslQ1.js";import{C as Z}from"./check-circle-CQyckcTV.js";import{T as ee}from"./trash-2-DnurnG26.js";import{M as se}from"./mail-CGPebitt.js";import{P as ae}from"./phone-C54juCtE.js";import{M as ie}from"./map-pin-CczOKtuj.js";import{S as te}from"./save-BTZwz_kZ.js";const re=X("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]);function he(){const m=Q(),[o,j]=n.useState(null),[D,J]=n.useState(!0),[z,I]=n.useState(!1),[U,p]=n.useState(null),[E,h]=n.useState(null),[w,v]=n.useState(!1),[S,M]=n.useState(!1),[_,k]=n.useState(""),[t,y]=n.useState({name:"",email:"",phone:"",profile_image:"",street:"",city:"",state:"",zip:"",country:"India"}),[d,F]=n.useState([]);n.useEffect(()=>{M(!1)},[t.profile_image]),n.useEffect(()=>{let s=!1,a=null;return(async()=>{if(S||!t.profile_image){k("");return}const r=await $(t.profile_image);if(s){r.revoke&&r.src&&URL.revokeObjectURL(r.src);return}k(r.src||""),a=r.revoke?r.src:null})(),()=>{s=!0,a&&URL.revokeObjectURL(a)}},[t.profile_image,S]),n.useEffect(()=>{T()},[]);const T=async()=>{try{const s=localStorage.getItem("user");if(!s){m("/login");return}let a=null;try{a=JSON.parse(s)}catch{localStorage.removeItem("user"),m("/login");return}j(a);const i=await b.getById(a.id);let r={};if(i.address)try{r=JSON.parse(i.address)}catch{}y({name:i.name||"",email:i.email||"",phone:i.phone||"",profile_image:i.profile_image||"",...r}),L(i,r)}catch(s){p(s.message)}finally{J(!1)}},L=(s,a)=>{const i=[];(!s.phone||s.phone.trim().length<10)&&i.push({field:"phone",message:"Phone number is required (min 10 digits)"}),a.street||i.push({field:"street",message:"Street address is required"}),a.city||i.push({field:"city",message:"City is required"}),a.state||i.push({field:"state",message:"State is required"}),a.zip||i.push({field:"zip",message:"Postal code is required"}),F(i)},f=s=>{const{name:a,value:i}=s.target;y(r=>({...r,[a]:i})),d.find(r=>r.field===a)&&F(r=>r.filter(l=>l.field!==a))},V=async s=>{s.preventDefault(),I(!0),p(null),h(null);try{const a={street:t.street,city:t.city,state:t.state,zip:t.zip,country:t.country};await b.update(o.id,{name:t.name,email:t.email,phone:t.phone,profile_image:t.profile_image||null,address:JSON.stringify(a)});const i={...o,name:t.name,email:t.email,phone:t.phone,profile_image:t.profile_image||null,address:JSON.stringify(a)};localStorage.setItem("user",JSON.stringify(i)),window.dispatchEvent(new Event("user-updated")),j(i),h("Profile updated successfully!"),L({...t,phone:t.phone},a)}catch(a){p(a.message)}finally{I(!1)}},R=2*1024*1024,O=s=>{const a=String(s||"").split(",")[1]||"",i=a.endsWith("==")?2:a.endsWith("=")?1:0;return Math.max(0,Math.floor(a.length*3/4)-i)},W=s=>new Promise((a,i)=>{const r=URL.createObjectURL(s),l=new Image;l.onload=()=>{URL.revokeObjectURL(r),a(l)},l.onerror=()=>{URL.revokeObjectURL(r),i(new Error("Failed to read image file"))},l.src=r}),Y=async s=>{const a=await W(s),i=document.createElement("canvas"),r=i.getContext("2d");if(!r)throw new Error("Image optimization is not supported in this browser");const l=a.width,g=a.height,u=Math.min(l,g),N=Math.max(0,Math.floor((l-u)/2)),C=Math.max(0,Math.floor((g-u)/2.4));let c=Math.min(1200,u),P=.9,x="";for(let A=0;A<8;A+=1){if(i.width=c,i.height=c,r.clearRect(0,0,c,c),r.fillStyle="#ffffff",r.fillRect(0,0,c,c),r.drawImage(a,N,C,u,u,0,0,c,c),x=i.toDataURL("image/jpeg",P),O(x)<=R)return x;P>.62?P-=.08:c=Math.floor(c*.85)}if(O(x)>R)throw new Error("Image is too large even after optimization. Please choose a smaller photo.");return x},G=async s=>{var r;const a=(r=s.target.files)==null?void 0:r[0];if(!a||!(o!=null&&o.id))return;if(p(null),h(null),!new Set(["image/jpeg","image/png","image/webp"]).has(a.type)){p("Please choose a JPEG, PNG, or WEBP image.");return}v(!0);try{const l=await Y(a),g=await b.uploadProfileImage(o.id,l),u=(g==null?void 0:g.profile_image)||"";y(C=>({...C,profile_image:u}));const N={...o,profile_image:u};j(N),localStorage.setItem("user",JSON.stringify(N)),window.dispatchEvent(new Event("user-updated")),h("Profile image updated.")}catch(l){p(l.message||"Failed to upload profile image")}finally{v(!1),s.target.value=""}},H=async()=>{if(o!=null&&o.id){p(null),h(null),v(!0);try{await b.update(o.id,{profile_image:null}),y(a=>({...a,profile_image:""}));const s={...o,profile_image:null};j(s),localStorage.setItem("user",JSON.stringify(s)),window.dispatchEvent(new Event("user-updated")),h("Profile image removed.")}catch(s){p(s.message||"Failed to remove profile image")}finally{v(!1)}}};return D?e.jsx("div",{className:"profile-page",children:e.jsxs("div",{className:"loading-container",children:[e.jsx(q,{size:40,className:"spinning"}),e.jsx("p",{children:"Loading profile..."})]})}):e.jsxs("div",{className:"profile-page",children:[e.jsxs("div",{className:"profile-header fade-in-up",children:[e.jsxs("button",{className:"back-btn",onClick:()=>m("/"),children:[e.jsx(K,{size:20})," Back"]}),e.jsx("h1",{children:"My Profile"}),e.jsx("p",{children:"Manage your account information"})]}),d.length>0&&e.jsxs("div",{className:"validation-warning fade-in-up",children:[e.jsx(B,{size:24}),e.jsxs("div",{className:"warning-content",children:[e.jsx("h3",{children:"Complete Your Profile for Orders"}),e.jsx("p",{children:"The following information is required to place orders:"}),e.jsx("ul",{className:"issues-list",children:d.map((s,a)=>e.jsxs("li",{children:[e.jsx("span",{className:"issue-icon",children:"â€¢"}),s.message]},a))})]})]}),E&&e.jsxs("div",{className:"success-alert fade-in-up",children:[e.jsx(Z,{size:20}),e.jsx("span",{children:E})]}),U&&e.jsxs("div",{className:"error-alert fade-in-up",children:[e.jsx(B,{size:20}),e.jsx("span",{children:U})]}),e.jsxs("div",{className:"profile-content",children:[e.jsxs("form",{onSubmit:V,className:"profile-form slide-in-up",children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(q,{size:20})," Personal Information"]}),e.jsxs("div",{className:"profile-image-section",children:[e.jsx("div",{className:"profile-image-preview",children:_&&!S?e.jsx("img",{src:_,alt:"Profile",onError:()=>M(!0)}):e.jsx("span",{children:(t.name||"U").slice(0,1).toUpperCase()})}),e.jsxs("div",{className:"profile-image-actions",children:[e.jsxs("label",{className:"image-upload-btn",children:[e.jsx(re,{size:16}),w?"Uploading...":"Upload Photo",e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/webp",onChange:G,disabled:w,style:{display:"none"}})]}),e.jsx("span",{className:"image-adjust-note",children:"Auto-cropped and optimized below 2MB"}),t.profile_image&&e.jsxs("button",{type:"button",className:"image-remove-btn",onClick:H,disabled:w,children:[e.jsx(ee,{size:16})," Remove"]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Full Name *"}),e.jsx("input",{type:"text",id:"name",name:"name",value:t.name,onChange:f,required:!0,placeholder:"Your full name",className:d.find(s=>s.field==="name")?"error-field":""})]}),e.jsxs("div",{className:"form-row two-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"email",children:[e.jsx(se,{size:16})," Email Address"]}),e.jsx("input",{type:"email",id:"email",name:"email",value:t.email,onChange:f,placeholder:"your@email.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"phone",children:[e.jsx(ae,{size:16})," Phone Number *"]}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:t.phone,onChange:f,required:!0,placeholder:"+91 98765 43210",className:d.find(s=>s.field==="phone")?"error-field":""})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(ie,{size:20})," Shipping Address"]}),e.jsx("p",{className:"section-help",children:"This address will be used for all orders"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"street",children:"Street Address *"}),e.jsx("input",{type:"text",id:"street",name:"street",value:t.street,onChange:f,placeholder:"123 Main Street, Apartment 4B",className:d.find(s=>s.field==="street")?"error-field":""})]}),e.jsxs("div",{className:"form-row three-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"city",children:"City *"}),e.jsx("input",{type:"text",id:"city",name:"city",value:t.city,onChange:f,placeholder:"Mumbai",className:d.find(s=>s.field==="city")?"error-field":""})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"state",children:"State/Region *"}),e.jsx("input",{type:"text",id:"state",name:"state",value:t.state,onChange:f,placeholder:"Maharashtra",className:d.find(s=>s.field==="state")?"error-field":""})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"zip",children:"Postal Code *"}),e.jsx("input",{type:"text",id:"zip",name:"zip",value:t.zip,onChange:f,placeholder:"400001",className:d.find(s=>s.field==="zip")?"error-field":""})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"country",children:"Country"}),e.jsx("input",{type:"text",id:"country",name:"country",value:t.country,onChange:f,placeholder:"India"})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>m("/"),children:"Cancel"}),e.jsxs("button",{type:"submit",className:"save-btn",disabled:z,children:[e.jsx(te,{size:18}),z?"Saving...":"Save Changes"]})]})]}),e.jsxs("div",{className:"quick-actions slide-in-up",children:[e.jsx("h3",{children:"Quick Actions"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/my-orders"),children:"View My Orders"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/cart"),children:"View Cart"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/change-password"),children:"Change Password"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/my-credit"),children:"View Credit History"})]})]})]})}export{he as default};
