import{u as le,d as me,r as t,o as L,e as k,j as e,P as de,a as ue,U as he,C as T}from"./index-DzGHLpa5.js";import{f as u}from"./formatters-C_RfwIqz.js";import{C as pe}from"./check-circle-CQyckcTV.js";import{A as U}from"./alert-circle-BCZKslQ1.js";import{S as xe}from"./search-DON9pjVo.js";import{M as je}from"./map-pin-CczOKtuj.js";const fe=()=>"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);function be(){var O,D;const[v]=le(),p=me(),[N,J]=t.useState([]),[$,B]=t.useState(!0),[P,w]=t.useState(!1),[A,x]=t.useState(null),[G,Q]=t.useState(!1),[S,W]=t.useState(null),[l,H]=t.useState(null),[K,X]=t.useState(!1),[Y,Z]=t.useState(!1),[m,z]=t.useState(!1),[j,q]=t.useState(""),[M,V]=t.useState([]),[C,ee]=t.useState(null),[se,E]=t.useState(!1),[n,f]=t.useState({customer_name:"",customer_email:"",customer_phone:"",street:"",city:"",state:"",zip:"",country:"India"}),[d,g]=t.useState(null),[_,h]=t.useState(!1),[b,F]=t.useState("cash"),re=v.get("session_id")||localStorage.getItem("checkout_session")||fe();t.useEffect(()=>{ae()},[]),t.useEffect(()=>{m&&j.length>=2&&ne()},[j]);const ae=async()=>{try{const r=v.get("retry");let s=[];if(r)try{const a=await L.getById(r);s=(Array.isArray(a==null?void 0:a.items)?a.items:[]).map(c=>{const I=Number(c.quantity||0),R=Number(c.price||0);return{id:c.product_id||c.id,name:c.product_name||c.name||"Item",image:c.product_image||c.image||"/logo.png",category:c.category||"",uom:c.uom||"pcs",stock:Number(c.stock||I||1),quantity:I>0?I:1,price:R>0?R:0}}).filter(c=>c.id&&c.price>=0&&c.quantity>0),s.length>0&&localStorage.setItem("barman_cart",JSON.stringify(s))}catch(a){console.error("Retry order load failed:",a)}if(s.length===0){const a=localStorage.getItem("barman_cart");if(!a){p("/cart");return}s=JSON.parse(a)}if(!Array.isArray(s)||s.length===0){p("/products");return}J(s);const o=localStorage.getItem("user");if(o){const a=JSON.parse(o);H(a),X(!0),Z(a.role==="admin"),a.role==="admin"&&v.get("admin")==="true"?z(!0):await te(a.id)}localStorage.setItem("checkout_session",re)}catch(r){x(r.message)}finally{B(!1)}},te=async r=>{try{const s=await k.validateForOrder(r);s.valid?s.profile&&f(o=>({...o,customer_name:s.profile.name||"",customer_email:s.profile.email||"",customer_phone:s.profile.phone||"",...s.profile.address||{}})):(g(s),h(!0),s.profile&&f(o=>({...o,customer_name:s.profile.name||"",customer_email:s.profile.email||"",customer_phone:s.profile.phone||"",...s.profile.address||{}})))}catch(s){console.error("Profile validation error:",s)}},ne=async()=>{try{const r=await k.search(j);V(r),E(!0)}catch(r){console.error("Customer search error:",r)}},ce=async r=>{ee(r),q(r.name),E(!1);try{const s=await k.getProfile(r.id);f({customer_name:s.name||"",customer_email:s.email||"",customer_phone:s.phone||"",...s.address||{}}),s.profileComplete.complete?(h(!1),g(null)):(g(s.profileComplete),h(!0))}catch(s){console.error("Error loading customer profile:",s)}},i=r=>{const{name:s,value:o}=r.target;f(a=>({...a,[s]:o})),_&&(h(!1),g(null))},y=()=>N.reduce((r,s)=>r+s.price*s.quantity,0),oe=async r=>{r.preventDefault(),w(!0),x(null);try{const s={items:N.map(a=>({product_id:a.id,quantity:a.quantity,price:a.price})),customer_name:n.customer_name,customer_email:n.customer_email,customer_phone:n.customer_phone,shipping_address:{street:n.street,city:n.city,state:n.state,zip:n.zip,country:n.country},payment_method:b,payment_data:null,is_admin_order:m,selected_customer_id:(C==null?void 0:C.id)||(l==null?void 0:l.id)},o=await L.createValidated(s);W(o),Q(!0),localStorage.removeItem("barman_cart"),localStorage.removeItem("checkout_session")}catch(s){x(s.message),(s.message.includes("PROFILE_INCOMPLETE")||s.message.includes("INCOMPLETE_PROFILE"))&&(h(!0),x("Please complete your profile information before placing an order."))}finally{w(!1)}},ie=()=>{p("/profile")};return $?e.jsx("div",{className:"checkout-page",children:e.jsxs("div",{className:"loading-container",children:[e.jsx(de,{size:40,className:"spinning"}),e.jsx("p",{children:"Loading checkout..."})]})}):G&&S?e.jsx("div",{className:"checkout-page",children:e.jsxs("div",{className:"order-success fade-in-up",children:[e.jsx("div",{className:"success-icon",children:e.jsx(pe,{size:100})}),e.jsx("h1",{children:"Order Placed Successfully!"}),e.jsxs("p",{className:"order-number",children:["Order #",S.orderNumber]}),e.jsxs("p",{className:"success-message",children:["Thank you for your purchase! A confirmation email has been sent to ",n.customer_email]}),e.jsx("div",{className:"order-details",children:e.jsxs("p",{children:["Total Amount: ",e.jsx("strong",{children:u(S.totalAmount)})]})}),e.jsx("button",{className:"back-home-btn",onClick:()=>p("/products"),children:"Continue Shopping"})]})}):e.jsxs("div",{className:"checkout-page",children:[e.jsxs("div",{className:"checkout-header fade-in-up",children:[e.jsx("h1",{children:"Checkout"}),e.jsx("p",{children:K?`Welcome, ${(l==null?void 0:l.name)||"Customer"}`:"Guest Checkout"}),Y&&e.jsx("div",{className:"admin-mode-toggle",children:e.jsxs("button",{className:`toggle-btn ${m?"active":""}`,onClick:()=>z(!m),children:[e.jsx(ue,{size:16}),m?"Admin: Select Customer":"Switch to Admin Mode"]})})]}),_&&e.jsxs("div",{className:"profile-warning fade-in-up",children:[e.jsx(U,{size:24}),e.jsxs("div",{className:"warning-content",children:[e.jsx("h3",{children:"Profile Information Incomplete"}),e.jsx("p",{children:"Please fill in all required fields marked with * to complete your order."}),(O=d==null?void 0:d.issues)==null?void 0:O.map((r,s)=>e.jsxs("p",{className:"issue-item",children:["- ",r.message]},s))]}),e.jsx("button",{className:"update-profile-btn",onClick:ie,children:"Update Profile"})]}),A&&!_&&e.jsxs("div",{className:"error-alert fade-in-up",children:[e.jsx(U,{size:20}),e.jsx("span",{children:A})]}),e.jsxs("div",{className:"checkout-content",children:[e.jsx("div",{className:"checkout-form-container slide-in-left",children:e.jsxs("form",{onSubmit:oe,className:"checkout-form",children:[m&&e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(xe,{size:20})," Select Customer"]}),e.jsxs("div",{className:"customer-search-container",children:[e.jsx("input",{type:"text",placeholder:"Search customers by name, email, or phone...",value:j,onChange:r=>q(r.target.value),className:"customer-search-input"}),se&&M.length>0&&e.jsx("div",{className:"customer-dropdown",children:M.map(r=>e.jsxs("div",{className:"customer-option",onClick:()=>ce(r),children:[e.jsxs("div",{className:"customer-info",children:[e.jsx("span",{className:"customer-name",children:r.name}),e.jsx("span",{className:"customer-email",children:r.email})]}),e.jsx("span",{className:"customer-phone",children:r.phone})]},r.id))})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(he,{size:20})," Customer Information"]}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"customer_name",children:"Full Name *"}),e.jsx("input",{type:"text",id:"customer_name",name:"customer_name",value:n.customer_name,onChange:i,required:!0,placeholder:"John Doe",className:(D=d==null?void 0:d.issues)!=null&&D.find(r=>r.field==="name")?"error-field":""})]})}),e.jsxs("div",{className:"form-row two-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"customer_email",children:"Email Address *"}),e.jsx("input",{type:"email",id:"customer_email",name:"customer_email",value:n.customer_email,onChange:i,required:!0,placeholder:"john@example.com"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"customer_phone",children:"Phone Number *"}),e.jsx("input",{type:"tel",id:"customer_phone",name:"customer_phone",value:n.customer_phone,onChange:i,required:!0,placeholder:"+91 98765 43210"})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(je,{size:20})," Shipping Address"]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"street",children:"Street Address *"}),e.jsx("input",{type:"text",id:"street",name:"street",value:n.street,onChange:i,required:!0,placeholder:"123 Main Street, Apartment 4B"})]}),e.jsxs("div",{className:"form-row three-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"city",children:"City *"}),e.jsx("input",{type:"text",id:"city",name:"city",value:n.city,onChange:i,required:!0,placeholder:"Mumbai"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"state",children:"State/Region *"}),e.jsx("input",{type:"text",id:"state",name:"state",value:n.state,onChange:i,required:!0,placeholder:"Maharashtra"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"zip",children:"Postal Code *"}),e.jsx("input",{type:"text",id:"zip",name:"zip",value:n.zip,onChange:i,required:!0,placeholder:"400001"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"country",children:"Country"}),e.jsx("input",{type:"text",id:"country",name:"country",value:n.country,onChange:i,placeholder:"India"})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(T,{size:20})," Payment Method"]}),e.jsxs("p",{className:"payment-note",children:[e.jsx(T,{size:16}),"Choose cash payment or use store credit."]}),e.jsxs("div",{className:"payment-methods",children:[e.jsxs("label",{className:"payment-option",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"cash",checked:b==="cash",onChange:r=>F(r.target.value)}),e.jsx("span",{children:"Cash"})]}),e.jsxs("label",{className:"payment-option",children:[e.jsx("input",{type:"radio",name:"paymentMethod",value:"credit",checked:b==="credit",onChange:r=>F(r.target.value)}),e.jsx("span",{children:"Store Credit"})]})]})]}),e.jsx("button",{type:"submit",className:"place-order-btn",disabled:P,children:P?"Processing...":`Place Order - ${u(y()*1.1)}`})]})}),e.jsxs("div",{className:"order-summary slide-in-right",children:[e.jsx("h2",{children:"Order Summary"}),e.jsx("div",{className:"order-items",children:N.map(r=>e.jsxs("div",{className:"summary-item",children:[e.jsx("div",{className:"summary-item-image",children:e.jsx("img",{src:r.image,alt:r.name})}),e.jsxs("div",{className:"summary-item-details",children:[e.jsx("h4",{children:r.name}),e.jsxs("p",{children:["Qty: ",r.quantity]})]}),e.jsx("div",{className:"summary-item-price",children:u(r.price*r.quantity)})]},r.id))}),e.jsxs("div",{className:"summary-totals",children:[e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:u(y())})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Shipping"}),e.jsx("span",{children:"Free"})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Tax (10%)"}),e.jsx("span",{children:u(y()*.1)})]}),e.jsx("div",{className:"summary-divider"}),e.jsxs("div",{className:"summary-total",children:[e.jsx("span",{children:"Total"}),e.jsx("span",{children:u(y()*1.1)})]})]})]})]})]})}export{be as default};
