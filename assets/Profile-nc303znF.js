import{c as fe,e as _e,r as o,q as M,j as e,U as oe,d as Ee,g as q}from"./index-B15Jacgc.js";import{i as ce,n as L,P as F}from"./phone-CMmRihHV.js";import{A as Pe}from"./arrow-left-B3UQ9Gym.js";import{A as de,M as ke}from"./map-pin-ChjTJwgu.js";import{C as ze}from"./check-circle-CYoLxoFM.js";import{T as Ve}from"./trash-2-Cj6RQxxF.js";import{M as Ue,P as Ie}from"./phone-O8duDAfg.js";const Me=fe("Camera",[["path",{d:"M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z",key:"1tc9qg"}],["circle",{cx:"12",cy:"13",r:"3",key:"1vg3eu"}]]),qe=fe("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]),me=m=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(m||"").trim());function Te(){const m=_e(),[l,y]=o.useState(null),[he,pe]=o.useState(!0),[X,P]=o.useState(!1),[Q,r]=o.useState(null),[K,d]=o.useState(null),[O,k]=o.useState(!1),[R,Z]=o.useState(!1),[ee,ie]=o.useState(""),[b,A]=o.useState(!1),[N,B]=o.useState(!1),[ae,D]=o.useState(""),[te,T]=o.useState(""),[p,u]=o.useState(""),[x,J]=o.useState(null),[S,W]=o.useState(null),[s,z]=o.useState({name:"",email:"",phone:"",profile_image:"",street:"",city:"",state:"",zip:"",country:"India"}),[f,se]=o.useState([]);o.useEffect(()=>{Z(!1)},[s.profile_image]),o.useEffect(()=>{let a=!1,i=null;return(async()=>{if(R||!s.profile_image){ie("");return}const t=await Ee(s.profile_image);if(a){t.revoke&&t.src&&URL.revokeObjectURL(t.src);return}ie(t.src||""),i=t.revoke?t.src:null})(),()=>{a=!0,i&&URL.revokeObjectURL(i)}},[s.profile_image,R]),o.useEffect(()=>{ue()},[]);const ue=async()=>{try{const a=localStorage.getItem("user");if(!a){m("/login");return}let i=null;try{i=JSON.parse(a)}catch{localStorage.removeItem("user"),m("/login");return}y(i);const n=await M.getById(i.id);let t={};if(n.address)try{t=JSON.parse(n.address)}catch{}z({name:n.name||"",email:n.email||"",phone:n.phone||"",profile_image:n.profile_image||"",...t}),A(!!n.email_verified),B(!!n.phone_verified),V(n,t)}catch(a){r(a.message)}finally{pe(!1)}},V=(a,i)=>{const n=[];a.email&&!me(a.email)&&n.push({field:"email",message:"Enter a valid email or keep it blank"}),(!a.phone||!ce(a.phone))&&n.push({field:"phone",message:F}),!a.email_verified&&!a.phone_verified&&n.push({field:"verification",message:"Verify at least one contact method (email or phone)"}),i.street||n.push({field:"street",message:"Street address is required"}),i.city||n.push({field:"city",message:"City is required"}),i.state||n.push({field:"state",message:"State is required"}),i.zip||n.push({field:"zip",message:"Postal code is required"}),se(n)},g=a=>{const{name:i,value:n}=a.target;z(t=>({...t,[i]:n})),f.find(t=>t.field===i)&&se(t=>t.filter(c=>c.field!==i))},ge=async a=>{a.preventDefault(),P(!0),r(null),d(null);try{const i=String(s.email||"").trim().toLowerCase();if(i&&!me(i)){r("Enter a valid email or leave it blank"),P(!1);return}if(!ce(s.phone)){r(F),P(!1);return}const n={street:s.street,city:s.city,state:s.state,zip:s.zip,country:s.country},t=await M.update(l.id,{name:s.name,email:i||null,phone:L(s.phone),profile_image:s.profile_image||null,address:JSON.stringify(n)}),c={...l,...t,token:l==null?void 0:l.token};localStorage.setItem("user",JSON.stringify(c)),window.dispatchEvent(new Event("user-updated")),y(c),A(!!(t!=null&&t.email_verified)),B(!!(t!=null&&t.phone_verified)),J(null),W(null),D(""),T(""),d("Profile updated successfully!"),V({...s,phone:L(s.phone),email_verified:!!(t!=null&&t.email_verified),phone_verified:!!(t!=null&&t.phone_verified)},n)}catch(i){r(i.message)}finally{P(!1)}},ne=2*1024*1024,re=a=>{const i=String(a||"").split(",")[1]||"",n=i.endsWith("==")?2:i.endsWith("=")?1:0;return Math.max(0,Math.floor(i.length*3/4)-n)},ve=a=>new Promise((i,n)=>{const t=URL.createObjectURL(a),c=new Image;c.onload=()=>{URL.revokeObjectURL(t),i(c)},c.onerror=()=>{URL.revokeObjectURL(t),n(new Error("Failed to read image file"))},c.src=t}),ye=async a=>{const i=await ve(a),n=document.createElement("canvas"),t=n.getContext("2d");if(!t)throw new Error("Image optimization is not supported in this browser");const c=i.width,j=i.height,v=Math.min(c,j),I=Math.max(0,Math.floor((c-v)/2)),Y=Math.max(0,Math.floor((j-v)/2.4));let h=Math.min(1200,v),G=.9,E="";for(let le=0;le<8;le+=1){if(n.width=h,n.height=h,t.clearRect(0,0,h,h),t.fillStyle="#ffffff",t.fillRect(0,0,h,h),t.drawImage(i,I,Y,v,v,0,0,h,h),E=n.toDataURL("image/jpeg",G),re(E)<=ne)return E;G>.62?G-=.08:h=Math.floor(h*.85)}if(re(E)>ne)throw new Error("Image is too large even after optimization. Please choose a smaller photo.");return E},xe=async a=>{var t;const i=(t=a.target.files)==null?void 0:t[0];if(!i||!(l!=null&&l.id))return;if(r(null),d(null),!new Set(["image/jpeg","image/png","image/webp"]).has(i.type)){r("Please choose a JPEG, PNG, or WEBP image.");return}k(!0);try{const c=await ye(i),j=await M.uploadProfileImage(l.id,c),v=(j==null?void 0:j.profile_image)||"";z(Y=>({...Y,profile_image:v}));const I={...l,profile_image:v};y(I),localStorage.setItem("user",JSON.stringify(I)),window.dispatchEvent(new Event("user-updated")),d("Profile image updated.")}catch(c){r(c.message||"Failed to upload profile image")}finally{k(!1),a.target.value=""}},je=String(s.email||"").trim().toLowerCase(),w=String((l==null?void 0:l.email)||"").trim().toLowerCase(),$=L(s.phone||""),U=L((l==null?void 0:l.phone)||""),C=je!==w,_=$!==U,H=async(a,i)=>{var n;try{const t=String(a||"").trim();if(!t)return;if(!((n=navigator==null?void 0:navigator.clipboard)!=null&&n.writeText)){r("Clipboard is not available in this browser");return}await navigator.clipboard.writeText(t),d(`${i} copied`)}catch{r(`Failed to copy ${i.toLowerCase()}`)}},be=async()=>{var a;try{if(r(null),d(null),C){r("Save email changes first, then request verification");return}if(!w||!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(w)){r("Enter a valid email and save profile first");return}u("email_request");const i=await q.requestMyEmailVerification();J((i==null?void 0:i.prepared_email)||((a=i==null?void 0:i.delivery)==null?void 0:a.email)||null),d((i==null?void 0:i.message)||"Verification instructions sent")}catch(i){r(i.message||"Failed to request email verification")}finally{u("")}},Ne=async()=>{try{r(null),d(null);const a=String(ae||"").trim();if(!w){r("Save a valid email first");return}if(!a){r("Email verification token is required");return}u("email_confirm");const i=await q.confirmEmailVerification(w,a);A(!0),J(null),D("");const n={...l,email_verified:!0};y(n),localStorage.setItem("user",JSON.stringify(n)),window.dispatchEvent(new Event("user-updated")),d((i==null?void 0:i.message)||"Email verified successfully"),V({...s,email_verified:!0,phone_verified:N,phone:$||s.phone},{street:s.street,city:s.city,state:s.state,zip:s.zip,country:s.country})}catch(a){r(a.message||"Failed to confirm email verification")}finally{u("")}},Se=async()=>{var a;try{if(r(null),d(null),_){r("Save phone changes first, then request verification");return}if(!U){r(F);return}u("phone_request");const i=await q.requestMyPhoneVerification();W((i==null?void 0:i.prepared_whatsapp)||((a=i==null?void 0:i.delivery)==null?void 0:a.whatsapp)||null),d((i==null?void 0:i.message)||"Phone verification instructions sent")}catch(i){r(i.message||"Failed to request phone verification")}finally{u("")}},we=async()=>{try{r(null),d(null);const a=String(te||"").trim();if(!U){r(F);return}if(!a){r("Phone verification code is required");return}u("phone_confirm");const i=await q.confirmPhoneVerification(U,a);B(!0),W(null),T("");const n={...l,phone_verified:!0};y(n),localStorage.setItem("user",JSON.stringify(n)),window.dispatchEvent(new Event("user-updated")),d((i==null?void 0:i.message)||"Phone verified successfully"),V({...s,email_verified:b,phone_verified:!0,phone:$||s.phone},{street:s.street,city:s.city,state:s.state,zip:s.zip,country:s.country})}catch(a){r(a.message||"Failed to confirm phone verification")}finally{u("")}},Ce=async()=>{if(l!=null&&l.id){r(null),d(null),k(!0);try{await M.update(l.id,{profile_image:null}),z(i=>({...i,profile_image:""}));const a={...l,profile_image:null};y(a),localStorage.setItem("user",JSON.stringify(a)),window.dispatchEvent(new Event("user-updated")),d("Profile image removed.")}catch(a){r(a.message||"Failed to remove profile image")}finally{k(!1)}}};return he?e.jsx("div",{className:"profile-page",children:e.jsxs("div",{className:"loading-container",children:[e.jsx(oe,{size:40,className:"spinning"}),e.jsx("p",{children:"Loading profile..."})]})}):e.jsxs("div",{className:"profile-page",children:[e.jsxs("div",{className:"profile-header fade-in-up",children:[e.jsxs("button",{className:"back-btn",onClick:()=>m("/"),children:[e.jsx(Pe,{size:20})," Back"]}),e.jsx("h1",{children:"My Profile"}),e.jsx("p",{children:"Manage your account information"})]}),f.length>0&&e.jsxs("div",{className:"validation-warning fade-in-up",children:[e.jsx(de,{size:24}),e.jsxs("div",{className:"warning-content",children:[e.jsx("h3",{children:"Complete Your Profile for Orders"}),e.jsx("p",{children:"The following information is required to place orders:"}),e.jsx("ul",{className:"issues-list",children:f.map((a,i)=>e.jsxs("li",{children:[e.jsx("span",{className:"issue-icon",children:"â€¢"}),a.message]},i))})]})]}),K&&e.jsxs("div",{className:"success-alert fade-in-up",children:[e.jsx(ze,{size:20}),e.jsx("span",{children:K})]}),Q&&e.jsxs("div",{className:"error-alert fade-in-up",children:[e.jsx(de,{size:20}),e.jsx("span",{children:Q})]}),e.jsxs("div",{className:"profile-content",children:[e.jsxs("form",{onSubmit:ge,className:"profile-form slide-in-up",children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(oe,{size:20})," Personal Information"]}),e.jsxs("div",{className:"profile-image-section",children:[e.jsx("div",{className:"profile-image-preview",children:ee&&!R?e.jsx("img",{src:ee,alt:"Profile",onError:()=>Z(!0)}):e.jsx("span",{children:(s.name||"U").slice(0,1).toUpperCase()})}),e.jsxs("div",{className:"profile-image-actions",children:[e.jsxs("label",{className:"image-upload-btn",children:[e.jsx(Me,{size:16}),O?"Uploading...":"Upload Photo",e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/webp",onChange:xe,disabled:O,style:{display:"none"}})]}),e.jsx("span",{className:"image-adjust-note",children:"Auto-cropped and optimized below 2MB"}),s.profile_image&&e.jsxs("button",{type:"button",className:"image-remove-btn",onClick:Ce,disabled:O,children:[e.jsx(Ve,{size:16})," Remove"]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Full Name *"}),e.jsx("input",{type:"text",id:"name",name:"name",value:s.name,onChange:g,required:!0,placeholder:"Your full name",className:f.find(a=>a.field==="name")?"error-field":""})]}),e.jsxs("div",{className:"form-row two-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"email",children:[e.jsx(Ue,{size:16})," Email Address",s.email&&e.jsx("span",{className:`verification-pill ${b?"verified":"unverified"}`,title:b?"Verified email":"Unverified email",children:b?"Verified":"Unverified"})]}),e.jsx("input",{type:"email",id:"email",name:"email",value:s.email,onChange:g,placeholder:"your@email.com",className:f.find(a=>a.field==="email")?"error-field":""}),s.email&&e.jsxs("div",{className:"verification-tools",children:[C&&e.jsx("span",{className:"verification-note",children:"Save email changes before verification actions"}),!b&&e.jsxs("div",{className:"verification-actions",children:[e.jsx("button",{type:"button",className:"verify-btn",onClick:be,disabled:p==="email_request"||C,children:p==="email_request"?"Preparing...":"Send Verification"}),e.jsx("input",{type:"text",value:ae,onChange:a=>D(a.target.value),placeholder:"Enter email token",disabled:C}),e.jsx("button",{type:"button",className:"verify-btn secondary",onClick:Ne,disabled:p==="email_confirm"||C,children:p==="email_confirm"?"Confirming...":"Confirm Email"})]}),x&&e.jsxs("div",{className:"verification-prepared",children:[e.jsx("textarea",{value:x.body||"",rows:5,readOnly:!0}),e.jsxs("div",{className:"verification-actions",children:[e.jsx("button",{type:"button",className:"verify-btn secondary",onClick:()=>H(x.subject,"Subject"),children:"Copy Subject"}),e.jsx("button",{type:"button",className:"verify-btn secondary",onClick:()=>H(x.body,"Email body"),children:"Copy Body"}),x.mailto_url&&e.jsx("a",{className:"verify-btn",href:x.mailto_url,children:"Open Email App"})]})]})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"phone",children:[e.jsx(Ie,{size:16})," Phone Number *",s.phone&&e.jsx("span",{className:`verification-pill ${N?"verified":"unverified"}`,title:N?"Verified phone":"Unverified phone",children:N?"Verified":"Unverified"})]}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:s.phone,onChange:g,required:!0,placeholder:"+91 98765 43210",className:f.find(a=>a.field==="phone")?"error-field":""}),s.phone&&e.jsxs("div",{className:"verification-tools",children:[_&&e.jsx("span",{className:"verification-note",children:"Save phone changes before verification actions"}),!N&&e.jsxs("div",{className:"verification-actions",children:[e.jsx("button",{type:"button",className:"verify-btn",onClick:Se,disabled:p==="phone_request"||_,children:p==="phone_request"?"Preparing...":"Send WhatsApp Verification"}),e.jsx("input",{type:"text",value:te,onChange:a=>T(a.target.value),placeholder:"Enter phone code",disabled:_}),e.jsx("button",{type:"button",className:"verify-btn secondary",onClick:we,disabled:p==="phone_confirm"||_,children:p==="phone_confirm"?"Confirming...":"Confirm Phone"})]}),S&&e.jsxs("div",{className:"verification-prepared",children:[e.jsx("textarea",{value:S.text||"",rows:5,readOnly:!0}),e.jsxs("div",{className:"verification-actions",children:[e.jsx("button",{type:"button",className:"verify-btn secondary",onClick:()=>H(S.text,"WhatsApp text"),children:"Copy Message"}),S.whatsapp_url&&e.jsx("a",{className:"verify-btn",href:S.whatsapp_url,target:"_blank",rel:"noreferrer",children:"Open WhatsApp"})]})]})]})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("h2",{children:[e.jsx(ke,{size:20})," Shipping Address"]}),e.jsx("p",{className:"section-help",children:"This address will be used for all orders"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"street",children:"Street Address *"}),e.jsx("input",{type:"text",id:"street",name:"street",value:s.street,onChange:g,placeholder:"123 Main Street, Apartment 4B",className:f.find(a=>a.field==="street")?"error-field":""})]}),e.jsxs("div",{className:"form-row three-col",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"city",children:"City *"}),e.jsx("input",{type:"text",id:"city",name:"city",value:s.city,onChange:g,placeholder:"Mumbai",className:f.find(a=>a.field==="city")?"error-field":""})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"state",children:"State/Region *"}),e.jsx("input",{type:"text",id:"state",name:"state",value:s.state,onChange:g,placeholder:"Maharashtra",className:f.find(a=>a.field==="state")?"error-field":""})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"zip",children:"Postal Code *"}),e.jsx("input",{type:"text",id:"zip",name:"zip",value:s.zip,onChange:g,placeholder:"400001",className:f.find(a=>a.field==="zip")?"error-field":""})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"country",children:"Country"}),e.jsx("input",{type:"text",id:"country",name:"country",value:s.country,onChange:g,placeholder:"India"})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>m("/"),children:"Cancel"}),e.jsxs("button",{type:"submit",className:"save-btn",disabled:X,children:[e.jsx(qe,{size:18}),X?"Saving...":"Save Changes"]})]})]}),e.jsxs("div",{className:"quick-actions slide-in-up",children:[e.jsx("h3",{children:"Quick Actions"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/my-orders"),children:"View My Orders"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/cart"),children:"View Cart"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/change-password"),children:"Change Password"}),e.jsx("button",{className:"action-btn",onClick:()=>m("/my-credit"),children:"View Credit History"})]})]})]})}export{Te as default};
