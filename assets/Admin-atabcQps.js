import{c as Pe,r,j as e,b as tt,P as $s,X as ke,p as ye,i as at,k as is,l as Bs,m as ga,s as Ga,n as Ts,q as We,f as Gt,t as La,O as Ra,T as Oa,v as Xt,w as Ze,e as Xa,u as Ya,L as wt,M as Ja,x as ba,C as Yt,y as Za,z as va,A as Jt,o as kt}from"./index-B15Jacgc.js";import{g as la,u as ca,M as oa,a as en}from"./MobileBottomSheet-C4-vX-mw.js";import{f as H,a as Zt,g as sn}from"./formatters-C_RfwIqz.js";import{S as da}from"./search-BblXmoKy.js";import{P as Me}from"./plus-DMW20Fof.js";import{T as ls}from"./trash-2-Cj6RQxxF.js";import{i as ua,P as ma,n as Dt}from"./phone-CMmRihHV.js";import{P as tn,M as fa}from"./phone-O8duDAfg.js";import{M as an,A as nn}from"./map-pin-ChjTJwgu.js";import{P as rn,p as Ia,e as we,R as Et}from"./printService-DN5DPOVT.js";import{f as ln,g as Fs,t as cn}from"./dateTime-BT6xQjkF.js";import{R as ya,X as on}from"./x-circle-uNhED-ap.js";import{E as za,D as Ma}from"./eye-Da84VUM6.js";import{M as Na}from"./minus-CA1TDh_X.js";import{C as Ua}from"./clock-BZbWU7wl.js";import{C as dn}from"./check-circle-CYoLxoFM.js";import{b as qa,s as Ba,c as un,a as mn,d as hn,e as pn,f as xn,M as _a,F as Ca,U as jn}from"./pdfService-Bbu4Qf5L.js";import{S as Sa}from"./shopping-bag-DL0BFioV.js";import{T as gn}from"./truck-BlmPUeyj.js";const bn=Pe("AlertTriangle",[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z",key:"c3ski4"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]]),wa=Pe("ArrowDown",[["path",{d:"M12 5v14",key:"s699le"}],["path",{d:"m19 12-7 7-7-7",key:"1idqje"}]]),vn=Pe("ArrowUpDown",[["path",{d:"m21 16-4 4-4-4",key:"f6ql7i"}],["path",{d:"M17 20V4",key:"1ejh1v"}],["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}]]),ea=Pe("ArrowUp",[["path",{d:"m5 12 7-7 7 7",key:"hav0vg"}],["path",{d:"M12 19V5",key:"x0mq9r"}]]),fn=Pe("BarChart2",[["line",{x1:"18",x2:"18",y1:"20",y2:"10",key:"1xfpm4"}],["line",{x1:"12",x2:"12",y1:"20",y2:"4",key:"be30l9"}],["line",{x1:"6",x2:"6",y1:"20",y2:"14",key:"1r4le6"}]]),ka=Pe("Calendar",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}]]),ia=Pe("CheckCircle2",[["path",{d:"M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",key:"14v8dr"}],["path",{d:"m9 12 2 2 4-4",key:"dzmm74"}]]),yn=Pe("Check",[["polyline",{points:"20 6 9 17 4 12",key:"10jjfj"}]]),sa=Pe("FolderOpen",[["path",{d:"m6 14 1.45-2.9A2 2 0 0 1 9.24 10H20a2 2 0 0 1 1.94 2.5l-1.55 6a2 2 0 0 1-1.94 1.5H4a2 2 0 0 1-2-2V5c0-1.1.9-2 2-2h3.93a2 2 0 0 1 1.66.9l.82 1.2a2 2 0 0 0 1.66.9H18a2 2 0 0 1 2 2v2",key:"1nmvlm"}]]),Nn=Pe("Gift",[["polyline",{points:"20 12 20 22 4 22 4 12",key:"nda8fc"}],["rect",{width:"20",height:"5",x:"2",y:"7",key:"wkgdzj"}],["line",{x1:"12",x2:"12",y1:"22",y2:"7",key:"1n8zgp"}],["path",{d:"M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z",key:"zighg4"}],["path",{d:"M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z",key:"1pa5tk"}]]),Pa=Pe("History",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}],["path",{d:"M12 7v5l4 2",key:"1fdv2h"}]]),_n=Pe("KeyRound",[["path",{d:"M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z",key:"167ctg"}],["circle",{cx:"16.5",cy:"7.5",r:".5",key:"1kog09"}]]),ys=Pe("Loader2",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]),rt=Pe("PenSquare",[["path",{d:"M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7",key:"1qinfi"}],["path",{d:"M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z",key:"w2jsv5"}]]),Cn=Pe("Pen",[["path",{d:"M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z",key:"5qss01"}]]),Sn=Pe("QrCode",[["rect",{width:"5",height:"5",x:"3",y:"3",rx:"1",key:"1tu5fj"}],["rect",{width:"5",height:"5",x:"16",y:"3",rx:"1",key:"1v8r4q"}],["rect",{width:"5",height:"5",x:"3",y:"16",rx:"1",key:"1x03jg"}],["path",{d:"M21 16h-3a2 2 0 0 0-2 2v3",key:"177gqh"}],["path",{d:"M21 21v.01",key:"ents32"}],["path",{d:"M12 7v3a2 2 0 0 1-2 2H7",key:"8crl2c"}],["path",{d:"M3 12h.01",key:"nlz23k"}],["path",{d:"M12 3h.01",key:"n36tog"}],["path",{d:"M12 16v.01",key:"133mhm"}],["path",{d:"M16 12h1",key:"1slzba"}],["path",{d:"M21 12v.01",key:"1lwtk9"}],["path",{d:"M12 21v-1",key:"1880an"}]]),ta=Pe("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]),aa=Pe("Users",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["path",{d:"M22 21v-2a4 4 0 0 0-3-3.87",key:"kshegd"}],["path",{d:"M16 3.13a4 4 0 0 1 0 7.75",key:"1da9ce"}]]),Ns=l=>String(l||"").trim(),Aa=Ns(void 0),Da=Ns(void 0),Ea=Ns(void 0),wn="https://api.unsplash.com/search/photos",kn=({name:l,brand:g,content:k,category:A,query:d})=>{const R=Ns(d);return R||[Ns(g),Ns(l),Ns(k),Ns(A),"product packshot"].filter(Boolean).join(" ")},Fa=(l,g)=>{const k=encodeURIComponent(l||"product-image"),A=[];for(let d=0;d<g;d+=1){const R=`${k}-${d+1}`;A.push({id:`fallback-${R}`,thumbUrl:`https://picsum.photos/seed/${R}/320/220`,fullUrl:`https://picsum.photos/seed/${R}/800/520`,source:"fallback",title:`Suggestion ${d+1}`})}return A},Pn=async(l,g)=>{if(!Aa||!Da)return[];const k=new URLSearchParams({key:Aa,cx:Da,q:l,searchType:"image",num:String(Math.max(1,Math.min(10,Number(g)||4))),safe:"active"}),A=await fetch(`https://www.googleapis.com/customsearch/v1?${k.toString()}`);if(!A.ok)throw new Error("Google image search request failed");const d=await A.json();return(Array.isArray(d==null?void 0:d.items)?d.items:[]).slice(0,g).map((h,$)=>{var D,G;return{id:`google-cse-${h.cacheId||$}`,thumbUrl:((D=h==null?void 0:h.image)==null?void 0:D.thumbnailLink)||(h==null?void 0:h.link)||"",fullUrl:(h==null?void 0:h.link)||((G=h==null?void 0:h.image)==null?void 0:G.contextLink)||"",source:"google-cse",title:(h==null?void 0:h.title)||(h==null?void 0:h.snippet)||`Suggestion ${$+1}`}}).filter(h=>h.fullUrl)},An=async(l,g)=>{if(!Ea)return[];const k=new URLSearchParams({query:l,per_page:String(g),orientation:"landscape"}),A=await fetch(`${wn}?${k.toString()}`,{headers:{Authorization:`Client-ID ${Ea}`}});if(!A.ok)throw new Error("Unsplash request failed");const d=await A.json();return(Array.isArray(d==null?void 0:d.results)?d.results:[]).slice(0,g).map((h,$)=>{var D,G,W,S,y,E;return{id:`unsplash-${h.id||$}`,thumbUrl:((D=h==null?void 0:h.urls)==null?void 0:D.small)||((G=h==null?void 0:h.urls)==null?void 0:G.thumb)||((W=h==null?void 0:h.urls)==null?void 0:W.regular)||"",fullUrl:((S=h==null?void 0:h.urls)==null?void 0:S.regular)||((y=h==null?void 0:h.urls)==null?void 0:y.full)||((E=h==null?void 0:h.urls)==null?void 0:E.small)||"",source:"unsplash",title:(h==null?void 0:h.alt_description)||(h==null?void 0:h.description)||`Suggestion ${$+1}`}}).filter(h=>h.fullUrl)},Dn=async(l={})=>{const g=Math.max(1,Math.min(12,Number(l.limit||4))),k=kn(l);if(!k)return{query:"",images:Fa("product-image",g)};try{const A=await Pn(k,g);if(A.length)return{query:k,images:A}}catch{}try{const A=await An(k,g);if(A.length)return{query:k,images:A}}catch{}return{query:k,images:Fa(k,g)}},na=l=>{const g=String(l||"").trim();if(!g)return"";try{const k=new URL(g);return k.protocol==="http:"||k.protocol==="https:"?k.href:""}catch{return""}};function En({value:l,onChange:g,productMeta:k={},disabled:A=!1}){const[d,R]=r.useState(!1),[h,$]=r.useState(""),[D,G]=r.useState(""),[W,S]=r.useState([]),y=String(l||"").trim(),E=r.useMemo(()=>[String((k==null?void 0:k.brand)||"").trim(),String((k==null?void 0:k.name)||"").trim(),String((k==null?void 0:k.content)||"").trim(),String((k==null?void 0:k.category)||"").trim(),"product packshot"].filter(Boolean).join(" "),[k]),se=L=>{const ee=String(L.target.value||"");g(ee),h&&$("")},K=async()=>{R(!0),$("");try{const L=await Dn({...k,limit:4});G(L.query||""),S(Array.isArray(L.images)?L.images.slice(0,4):[])}catch(L){$((L==null?void 0:L.message)||"Image search failed"),S([])}finally{R(!1)}},w=L=>{const ee=na((L==null?void 0:L.fullUrl)||(L==null?void 0:L.thumbUrl)||"");if(!ee){$("Selected image URL is invalid");return}g(ee),$("")};return e.jsxs("div",{className:"image-url-picker",children:[e.jsxs("div",{className:"image-url-picker-row",children:[e.jsx("input",{type:"url",id:"image",name:"image",value:y,onChange:se,placeholder:"https://example.com/image.jpg",className:"input-field",disabled:A}),e.jsxs("button",{type:"button",className:"image-search-btn",onClick:K,disabled:A||d,children:[e.jsx(da,{size:16}),d?"Searching...":"Search"]})]}),e.jsx("small",{className:"field-help",children:D?`Search used: ${D}`:`Auto query preview: ${E||"product packshot"}`}),h&&e.jsx("span",{className:"field-error",children:h}),W.length>0&&e.jsx("div",{className:"image-choice-grid",children:W.map(L=>{const ee=na(L.fullUrl)===na(y);return e.jsxs("button",{type:"button",className:`image-choice-card${ee?" selected":""}`,onClick:()=>w(L),title:L.title||"Image option",children:[e.jsx("img",{src:la(L.thumbUrl||L.fullUrl),alt:L.title||"Image option",loading:"lazy"}),e.jsx("span",{children:L.title||"Image option"})]},L.id)})})]})}function Fn({product:l,onClose:g,onSave:k}){const A=()=>({name:"",description:"",brand:"",content:"",color:"",price:"",mrp:"",uom:"pcs",base_unit:"pcs",uom_type:"selling",conversion_factor:"1",barcode:"",sku:"",image:"",stock:"",expiry_date:"",category:"",defaultDiscount:"",discountType:"fixed"}),[d,R]=r.useState(A()),[h,$]=r.useState([]),[D,G]=r.useState(!1),[W,S]=r.useState(""),[y,E]=r.useState({}),[se,K]=r.useState([]),[w,L]=r.useState(!0),ee=[{value:"pcs",label:"Pieces (pcs)"},{value:"kg",label:"Kilogram (kg)"},{value:"g",label:"Gram (g)"},{value:"l",label:"Liter (l)"},{value:"ml",label:"Milliliter (ml)"},{value:"box",label:"Box"},{value:"pack",label:"Pack"},{value:"case",label:"Case (24 pcs)"},{value:"dozen",label:"Dozen (12 pcs)"}];r.useEffect(()=>{var v,F,p,C,O;re(),l?(R({name:l.name||"",description:l.description||"",brand:l.brand||"",content:l.content||"",color:l.color||"",price:((v=l.price)==null?void 0:v.toString())||"",mrp:((F=l.mrp)==null?void 0:F.toString())||"",uom:l.uom||"pcs",base_unit:l.base_unit||"pcs",uom_type:l.uom_type||"selling",conversion_factor:((p=l.conversion_factor)==null?void 0:p.toString())||"1",barcode:l.barcode||"",sku:l.sku||"",image:l.image||"",stock:((C=l.stock)==null?void 0:C.toString())||"",expiry_date:l.expiry_date||"",category:l.category||"",defaultDiscount:((O=l.defaultDiscount)==null?void 0:O.toString())||"",discountType:l.discountType||"fixed"}),L(!1)):(R(A()),K([]),L(!0))},[l]);const re=async()=>{try{const v=await tt.getAll();$(v)}catch(v){console.error("Error fetching categories:",v)}},xe=(v=d)=>{const F=Z=>String(Z||"").replace(/[^a-zA-Z0-9]/g,"").toUpperCase(),p=F(v.name).slice(0,4).padEnd(4,"X"),C=F(v.brand).slice(0,4).padEnd(4,"X"),O=F(v.content).slice(0,2).padEnd(2,"X"),ie=Math.round(parseFloat(v.mrp)||parseFloat(v.price)||0),N=String(ie).replace(/\D/g,"").slice(-4).padStart(4,"0");return`${p}${C}${O}${N}`},u=(v=d)=>{const F=(v.name||"").trim();if(!F)return"";const p=(v.brand||"").trim(),C=(v.content||"").trim(),O=(v.category||"").trim(),ie=(v.color||"").trim(),N=[F];p&&N.push(`by ${p}`),C&&N.push(`(${C})`);let Z=N.join(" ");return O&&(Z+=` in ${O} category`),ie&&(Z+=`, ${ie} variant`),Z+=". Quality product for daily use.",Z},_=()=>{const v=u(d);v&&(R(F=>({...F,description:v})),L(!0))},J=v=>{const F={};return v.name.trim()||(F.name="Product name is required"),v.description.trim()||(F.description="Description is required"),(!v.price||parseFloat(v.price)<=0)&&(F.price="Price must be a positive number"),v.category||(F.category="Category is required"),(!v.stock||parseInt(v.stock)<0)&&(F.stock="Stock must be a non-negative number"),F},B=()=>{const v=J(d);return E(v),Object.keys(v).length===0},P=v=>({name:v.name.trim(),description:v.description.trim(),brand:v.brand.trim(),content:v.content.trim(),color:v.color.trim(),price:parseFloat(v.price),mrp:parseFloat(v.mrp)||parseFloat(v.price),uom:v.uom,base_unit:v.base_unit,uom_type:v.uom_type,barcode:v.barcode.trim(),sku:v.sku,image:v.image.trim(),stock:parseInt(v.stock),conversion_factor:parseFloat(v.conversion_factor)||1,expiry_date:v.expiry_date||null,category:v.category,defaultDiscount:parseFloat(v.defaultDiscount)||0,discountType:v.discountType}),te=(v=d)=>["name","description","brand","content","color","price","mrp","barcode","sku","image","stock","expiry_date","category","defaultDiscount"].some(F=>String(v[F]||"").trim()!==""),ce=()=>{if(S(""),!B())return;const v=P(d);K(F=>[...F,v]),R(F=>({...A(),category:F.category||"",uom:F.uom||"pcs",base_unit:F.base_unit||"pcs",uom_type:F.uom_type||"selling"})),E({}),L(!0)},me=v=>{K(F=>F.filter((p,C)=>C!==v))},i=v=>{const{name:F,value:p}=v.target,C={...d,[F]:p};if(y[F]&&E(O=>({...O,[F]:""})),["name","brand","content","price","mrp"].includes(F)&&(C.sku=xe(C)),F==="description"&&L(!1),["name","brand","content","category","color"].includes(F)&&(!C.description.trim()||w)){const O=u(C);O&&(C.description=O,L(!0))}R(C)},b=async v=>{v.preventDefault(),S(""),G(!0);try{const F=async({mode:p,payload:C,id:O})=>{var N;const ie=(Z=!1)=>{const Q=Z?{...C,allow_identical:!0}:C;return p==="update"?ye.update(O,Q):ye.create(Q)};try{return await ie(!1)}catch(Z){const Q=String(((N=Z==null?void 0:Z.payload)==null?void 0:N.conflict_type)||"");if(Number(Z==null?void 0:Z.status)===409&&Q==="identical"){if(!window.confirm(`${Z.message}

Do you want to continue anyway?`))throw Z;return ie(!0)}throw Z}};if(l){if(!B())return;const p=P(d);await F({mode:"update",id:l.id,payload:p}),await k({mode:"edit",createdCount:0})}else{const p=[...se];if(te(d)){if(!B())return;p.push(P(d))}if(!p.length){S("Add at least one product to submit");return}let C=0;for(let O=0;O<p.length;O+=1)try{await F({mode:"create",payload:p[O]}),C+=1}catch(ie){C>0&&await k(),S(`Failed at product ${O+1} (${p[O].name}): ${ie.message||"Create failed"}. Created ${C} product(s).`);return}await k({mode:"create",createdCount:p.length})}g()}catch(F){S(F.message||"Failed to save product")}finally{G(!1)}},x=!!l,z=ca(),X=e.jsxs(e.Fragment,{children:[W&&e.jsx("div",{className:"error-message",children:W}),e.jsxs("form",{onSubmit:b,className:"product-form",children:[!x&&e.jsxs("div",{className:"form-section batch-section",children:[e.jsx("h3",{className:"section-title",children:"Batch Add Products"}),e.jsxs("p",{className:"batch-help",children:["Fill product details and click ",e.jsx("strong",{children:"Add To Batch"}),". You can submit all queued products at once."]}),e.jsx("div",{className:"batch-actions",children:e.jsxs("button",{type:"button",className:"submit-btn batch-add-btn",onClick:ce,disabled:D,children:[e.jsx(Me,{size:16})," Add To Batch"]})}),se.length>0&&e.jsx("div",{className:"batch-list",children:se.map((v,F)=>e.jsxs("div",{className:"batch-item",children:[e.jsxs("div",{className:"batch-item-info",children:[e.jsx("strong",{children:v.name}),e.jsxs("span",{children:[v.category," | Rs ",Number(v.price||0).toFixed(2)," | Stock: ",v.stock]})]}),e.jsx("button",{type:"button",className:"batch-item-remove",onClick:()=>me(F),title:"Remove",children:e.jsx(ls,{size:14})})]},`${v.name}-${F}`))})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Basic Information"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Product Name *"}),e.jsx("input",{type:"text",id:"name",name:"name",value:d.name,onChange:i,placeholder:"Enter product name",className:`input-field ${y.name?"error":""}`}),y.name&&e.jsx("span",{className:"field-error",children:y.name})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("div",{className:"description-header",children:[e.jsx("label",{htmlFor:"description",children:"Description *"}),e.jsx("button",{type:"button",className:"suggest-description-btn",onClick:_,children:"Suggest"})]}),e.jsx("textarea",{id:"description",name:"description",value:d.description,onChange:i,placeholder:"Enter product description",rows:"3",className:`input-field ${y.description?"error":""}`}),e.jsx("small",{className:"field-help",children:"Description is auto-suggested from product name. You can edit it anytime."}),y.description&&e.jsx("span",{className:"field-error",children:y.description})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"brand",children:"Brand"}),e.jsx("input",{type:"text",id:"brand",name:"brand",value:d.brand,onChange:i,placeholder:"e.g., Nescafe, Parle",className:"input-field"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"content",children:"Content/Size"}),e.jsx("input",{type:"text",id:"content",name:"content",value:d.content,onChange:i,placeholder:"e.g., 250g, 1L, 500ml",className:"input-field"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"color",children:"Color"}),e.jsx("input",{type:"text",id:"color",name:"color",value:d.color,onChange:i,placeholder:"e.g., Brown, White, Red",className:"input-field"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"category",children:"Category *"}),e.jsxs("select",{id:"category",name:"category",value:d.category,onChange:i,className:`input-field ${y.category?"error":""}`,children:[e.jsx("option",{value:"",children:"Select a category"}),h.map(v=>e.jsx("option",{value:v.name,children:v.name},v.id))]}),y.category&&e.jsx("span",{className:"field-error",children:y.category})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Pricing"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"price",children:"Selling Price (₹) *"}),e.jsx("input",{type:"number",id:"price",name:"price",value:d.price,onChange:i,placeholder:"0.00",step:"0.01",min:"0",className:`input-field ${y.price?"error":""}`}),y.price&&e.jsx("span",{className:"field-error",children:y.price})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"mrp",children:"MRP (₹)"}),e.jsx("input",{type:"number",id:"mrp",name:"mrp",value:d.mrp,onChange:i,placeholder:"0.00",step:"0.01",min:"0",className:"input-field"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"defaultDiscount",children:"Discount"}),e.jsx("input",{type:"number",id:"defaultDiscount",name:"defaultDiscount",value:d.defaultDiscount,onChange:i,placeholder:"0",step:"0.01",min:"0",className:"input-field"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"discountType",children:"Discount Type"}),e.jsxs("select",{id:"discountType",name:"discountType",value:d.discountType,onChange:i,className:"input-field",children:[e.jsx("option",{value:"fixed",children:"Fixed (₹)"}),e.jsx("option",{value:"percentage",children:"Percentage (%)"})]})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Inventory"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"stock",children:"Stock Quantity *"}),e.jsx("input",{type:"number",id:"stock",name:"stock",value:d.stock,onChange:i,placeholder:"0",min:"0",className:`input-field ${y.stock?"error":""}`}),y.stock&&e.jsx("span",{className:"field-error",children:y.stock})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"base_unit",children:"Base Unit"}),e.jsx("select",{id:"base_unit",name:"base_unit",value:d.base_unit,onChange:i,className:"input-field",children:ee.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))}),e.jsx("small",{className:"field-help",children:"Primary unit for inventory"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"uom",children:"Selling UOM"}),e.jsx("select",{id:"uom",name:"uom",value:d.uom,onChange:i,className:"input-field",children:ee.map(v=>e.jsx("option",{value:v.value,children:v.label},v.value))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"uom_type",children:"UOM Type"}),e.jsxs("select",{id:"uom_type",name:"uom_type",value:d.uom_type,onChange:i,className:"input-field",children:[e.jsx("option",{value:"selling",children:"Selling Only"}),e.jsx("option",{value:"purchasing",children:"Purchasing Only"}),e.jsx("option",{value:"both",children:"Both Selling & Purchasing"})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"conversion_factor",children:"Conversion Factor"}),e.jsx("input",{type:"number",id:"conversion_factor",name:"conversion_factor",value:d.conversion_factor,onChange:i,placeholder:"1",step:"0.0001",min:"0",className:"input-field"}),e.jsx("small",{className:"field-help",children:"Selling units per base unit (e.g., 12 for Dozen)"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"expiry_date",children:"Expiry Date"}),e.jsx("input",{type:"date",id:"expiry_date",name:"expiry_date",value:d.expiry_date,onChange:i,className:"input-field"})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"SKU & Barcode"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"sku",children:[e.jsx($s,{size:16})," SKU (Auto-generated)"]}),e.jsx("input",{type:"text",id:"sku",name:"sku",value:d.sku,onChange:i,placeholder:"Auto-generated SKU",className:"input-field",readOnly:!x}),e.jsx("small",{className:"field-help",children:"Format: Name[:4] + Brand[:4] + Content[:2] + MRP[:4]"})]}),e.jsxs("div",{className:"form-group",children:[e.jsxs("label",{htmlFor:"barcode",children:[e.jsx(Sn,{size:16})," Barcode"]}),e.jsx("input",{type:"text",id:"barcode",name:"barcode",value:d.barcode,onChange:i,placeholder:"Enter barcode (numeric)",className:"input-field"})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Product Image"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"image",children:"Image URL"}),e.jsx(En,{value:d.image,disabled:D,productMeta:{name:d.name,brand:d.brand,content:d.content,category:d.category},onChange:v=>{R(F=>({...F,image:v}))}})]}),d.image&&e.jsx("div",{className:"image-preview",children:e.jsx("img",{src:la(d.image),alt:"Product preview",onError:v=>v.target.style.display="none"})})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:g,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:D,children:D?"Saving...":x?"Update Product":`Add Product${se.length?` (${se.length} queued)`:""}`})]})]})]});return z?e.jsx(oa,{open:!0,title:x?"Edit Product":"Add New Product",onClose:g,className:"product-form-sheet",children:X}):e.jsx("div",{className:"product-form-overlay",children:e.jsxs("div",{className:"product-form-container fade-in-up",children:[e.jsxs("div",{className:"product-form-header",children:[e.jsx("h2",{children:x?"Edit Product":"Add New Product"}),e.jsx("button",{className:"close-btn",onClick:g,children:e.jsx(ke,{size:24})})]}),X]})})}function Tn({onClose:l}){const[g,k]=r.useState([]),[A,d]=r.useState(!0),[R,h]=r.useState(""),[$,D]=r.useState(""),[G,W]=r.useState(!1),[S,y]=r.useState(null),[E,se]=r.useState({name:"",description:""}),[K,w]=r.useState({});r.useEffect(()=>{L()},[]);const L=async()=>{try{const B=await tt.getAll();k(B),h("")}catch(B){h("Failed to fetch categories: "+(B.message||"Unknown error"))}finally{d(!1)}},ee=()=>{const B={};return E.name.trim()?E.name.length<2&&(B.name="Category name must be at least 2 characters"):B.name="Category name is required",w(B),Object.keys(B).length===0},re=B=>{const{name:P,value:te}=B.target;se(ce=>({...ce,[P]:te})),K[P]&&w(ce=>({...ce,[P]:""}))},xe=async B=>{if(B.preventDefault(),!!ee()){d(!0),h(""),D("");try{G?(await tt.update(S,E),D("Category updated successfully")):(await tt.create(E),D("Category created successfully")),se({name:"",description:""}),W(!1),y(null),L(),setTimeout(()=>D(""),3e3)}catch(P){h(P.message||"Failed to save category")}finally{d(!1)}}},u=B=>{W(!0),y(B.id),se({name:B.name,description:B.description||""}),w({})},_=async B=>{if(window.confirm("Are you sure you want to delete this category? Products using this category will not be affected.")){d(!0),h(""),D("");try{await tt.delete(B),D("Category deleted successfully"),L(),setTimeout(()=>D(""),3e3)}catch(P){h(P.message||"Failed to delete category")}finally{d(!1)}}},J=()=>{W(!1),y(null),se({name:"",description:""}),w({})};return e.jsx("div",{className:"category-management-overlay",children:e.jsxs("div",{className:"category-management-container fade-in-up",children:[e.jsxs("div",{className:"category-management-header",children:[e.jsx("h2",{children:"Category Management"}),e.jsx("button",{className:"close-btn",onClick:l,children:e.jsx(ke,{size:24})})]}),R&&e.jsx("div",{className:"error-message",children:R}),$&&e.jsx("div",{className:"success-message",children:$}),e.jsxs("div",{className:"category-management-content",children:[e.jsxs("div",{className:"category-form-section",children:[e.jsx("h3",{children:G?"Edit Category":"Add New Category"}),e.jsxs("form",{onSubmit:xe,className:"category-form",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Category Name *"}),e.jsx("input",{type:"text",id:"name",name:"name",value:E.name,onChange:re,placeholder:"Enter category name",className:K.name?"error":""}),K.name&&e.jsx("span",{className:"field-error",children:K.name})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"description",children:"Description"}),e.jsx("textarea",{id:"description",name:"description",value:E.description,onChange:re,placeholder:"Enter category description",rows:"2"})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:J,disabled:A,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:A,children:A?"Saving...":G?"Update Category":"Add Category"})]})]})]}),e.jsxs("div",{className:"categories-list-section",children:[e.jsxs("h3",{children:["Existing Categories (",g.length,")"]}),A&&!g.length?e.jsx("div",{className:"loading-message",children:"Loading categories..."}):g.length===0?e.jsx("div",{className:"empty-message",children:"No categories found. Create your first category above."}):e.jsx("div",{className:"categories-grid",children:g.map(B=>e.jsxs("div",{className:"category-card",children:[e.jsxs("div",{className:"category-info",children:[e.jsx("h4",{children:B.name}),B.description&&e.jsx("p",{className:"category-description",children:B.description})]}),e.jsxs("div",{className:"category-actions",children:[e.jsx("button",{className:"edit-btn",onClick:()=>u(B),title:"Edit category",children:e.jsx(Cn,{size:16})}),e.jsx("button",{className:"delete-btn",onClick:()=>_(B.id),title:"Delete category",children:e.jsx(ls,{size:16})})]})]},B.id))})]})]})]})})}function $n({user:l}){const[g,k]=r.useState([]),[A,d]=r.useState(!0),[R,h]=r.useState(""),[$,D]=r.useState(!1),[G,W]=r.useState(null),[S,y]=r.useState(""),[E,se]=r.useState({name:"",salesman_name:"",phone:"",email:"",address:"",products_supplied:"",order_day:"",delivery_day:"",payment_terms:"Net 30",status:"active"});r.useEffect(()=>{w()},[]);const K=P=>{if(!P)return{};if(typeof P=="object")return P;try{return JSON.parse(P)}catch{return{}}},w=async()=>{try{d(!0);const P=await at.getAll();k(P||[])}catch{h("Failed to load distributors")}finally{d(!1)}},L=P=>{const{name:te,value:ce}=P.target;se(me=>({...me,[te]:ce}))},ee=async P=>{P.preventDefault(),h("");try{if(E.phone&&!ua(E.phone)){h(ma);return}const te={name:E.name.trim(),salesman_name:E.salesman_name.trim(),contacts:JSON.stringify({phone:E.phone?Dt(E.phone):"",email:E.email}),address:E.address.trim(),products_supplied:E.products_supplied.trim(),order_day:E.order_day,delivery_day:E.delivery_day,payment_terms:E.payment_terms,status:E.status};G?await at.update(G.id,te):await at.create(te),D(!1),W(null),u(),w()}catch(te){h(te.message||"Failed to save distributor")}},re=P=>{const te=K(P.contacts);se({name:P.name||"",salesman_name:P.salesman_name||"",phone:te.phone||"",email:te.email||"",address:P.address||"",products_supplied:P.products_supplied||"",order_day:P.order_day||"",delivery_day:P.delivery_day||"",payment_terms:P.payment_terms||"Net 30",status:P.status||"active"}),W(P),D(!0)},xe=async P=>{if(window.confirm("Are you sure you want to delete this distributor?"))try{await at.delete(P),k(g.filter(te=>te.id!==P))}catch{h("Failed to delete distributor")}},u=()=>{se({name:"",salesman_name:"",phone:"",email:"",address:"",products_supplied:"",order_day:"",delivery_day:"",payment_terms:"Net 30",status:"active"})},_=()=>{D(!1),W(null),u()},J=g.filter(P=>{var te,ce;return P.name.toLowerCase().includes(S.toLowerCase())||((te=P.salesman_name)==null?void 0:te.toLowerCase().includes(S.toLowerCase()))||((ce=P.products_supplied)==null?void 0:ce.toLowerCase().includes(S.toLowerCase()))}),B=P=>P==="active"?e.jsx("span",{className:"status-badge active",children:"Active"}):e.jsx("span",{className:"status-badge inactive",children:"Inactive"});return A?e.jsx("div",{className:"distributor-management",children:e.jsx("div",{className:"loading",children:"Loading distributors..."})}):e.jsxs("div",{className:"distributor-management",children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Distributor Management"}),e.jsxs("button",{className:"admin-btn primary",onClick:()=>D(!0),children:[e.jsx(Me,{size:20})," Add Distributor"]})]}),R&&e.jsx("div",{className:"error-message",children:R}),e.jsxs("div",{className:"search-bar",children:[e.jsx(da,{size:20}),e.jsx("input",{type:"text",placeholder:"Search distributors by name, salesman, or products...",value:S,onChange:P=>y(P.target.value)})]}),e.jsx("div",{className:"distributors-grid",children:J.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No distributors found."}),e.jsx("p",{children:'Click "Add Distributor" to create one.'})]}):J.map(P=>{const te=K(P.contacts);return e.jsxs("div",{className:"distributor-card fade-in-up",children:[e.jsxs("div",{className:"card-header",children:[e.jsxs("div",{className:"distributor-name",children:[e.jsx("h3",{children:P.name}),B(P.status)]}),e.jsxs("div",{className:"card-actions",children:[e.jsx("button",{className:"action-btn edit",onClick:()=>re(P),children:e.jsx(rt,{size:16})}),e.jsx("button",{className:"action-btn delete",onClick:()=>xe(P.id),children:e.jsx(ls,{size:16})})]})]}),e.jsxs("div",{className:"card-body",children:[P.salesman_name&&e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Salesman:"}),e.jsx("span",{className:"value",children:P.salesman_name})]}),e.jsxs("div",{className:"info-row",children:[e.jsx(tn,{size:14}),e.jsx("span",{children:te.phone||"-"})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Email:"}),e.jsx("span",{children:te.email||"-"})]}),P.address&&e.jsxs("div",{className:"info-row address",children:[e.jsx(an,{size:14}),e.jsx("span",{children:P.address})]}),P.products_supplied&&e.jsxs("div",{className:"info-row",children:[e.jsx($s,{size:14}),e.jsx("span",{children:P.products_supplied})]}),e.jsxs("div",{className:"info-row schedule",children:[e.jsxs("div",{className:"schedule-item",children:[e.jsx(ka,{size:14}),e.jsxs("span",{children:["Order: ",P.order_day||"-"]})]}),e.jsxs("div",{className:"schedule-item",children:[e.jsx(ka,{size:14}),e.jsxs("span",{children:["Delivery: ",P.delivery_day||"-"]})]})]}),e.jsxs("div",{className:"info-row",children:[e.jsx("span",{className:"label",children:"Payment Terms:"}),e.jsx("span",{children:P.payment_terms||"Net 30"})]})]})]},P.id)})}),$&&e.jsx("div",{className:"modal-overlay",onClick:_,children:e.jsxs("div",{className:"modal-content fade-in-up",onClick:P=>P.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:G?"Edit Distributor":"Add New Distributor"}),e.jsx("button",{className:"close-btn",onClick:_,children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:ee,children:[e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Basic Information"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor Name *"}),e.jsx("input",{type:"text",name:"name",value:E.name,onChange:L,placeholder:"Enter distributor name",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Salesman Name"}),e.jsx("input",{type:"text",name:"salesman_name",value:E.salesman_name,onChange:L,placeholder:"Enter salesman name"})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Contact Information"}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Phone"}),e.jsx("input",{type:"tel",name:"phone",value:E.phone,onChange:L,placeholder:"Enter phone number"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Email"}),e.jsx("input",{type:"email",name:"email",value:E.email,onChange:L,placeholder:"Enter email address"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Address"}),e.jsx("textarea",{name:"address",value:E.address,onChange:L,placeholder:"Enter full address",rows:"2"})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{className:"section-title",children:"Business Details"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Products Supplied"}),e.jsx("input",{type:"text",name:"products_supplied",value:E.products_supplied,onChange:L,placeholder:"e.g., Coffee, Tea, Sugar, Biscuits"})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Order Day"}),e.jsxs("select",{name:"order_day",value:E.order_day,onChange:L,children:[e.jsx("option",{value:"",children:"Select day"}),e.jsx("option",{value:"Monday",children:"Monday"}),e.jsx("option",{value:"Tuesday",children:"Tuesday"}),e.jsx("option",{value:"Wednesday",children:"Wednesday"}),e.jsx("option",{value:"Thursday",children:"Thursday"}),e.jsx("option",{value:"Friday",children:"Friday"}),e.jsx("option",{value:"Saturday",children:"Saturday"}),e.jsx("option",{value:"Sunday",children:"Sunday"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Delivery Day"}),e.jsxs("select",{name:"delivery_day",value:E.delivery_day,onChange:L,children:[e.jsx("option",{value:"",children:"Select day"}),e.jsx("option",{value:"Monday",children:"Monday"}),e.jsx("option",{value:"Tuesday",children:"Tuesday"}),e.jsx("option",{value:"Wednesday",children:"Wednesday"}),e.jsx("option",{value:"Thursday",children:"Thursday"}),e.jsx("option",{value:"Friday",children:"Friday"}),e.jsx("option",{value:"Saturday",children:"Saturday"}),e.jsx("option",{value:"Sunday",children:"Sunday"})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Payment Terms"}),e.jsxs("select",{name:"payment_terms",value:E.payment_terms,onChange:L,children:[e.jsx("option",{value:"Cash on Delivery",children:"Cash on Delivery"}),e.jsx("option",{value:"Net 15",children:"Net 15"}),e.jsx("option",{value:"Net 30",children:"Net 30"}),e.jsx("option",{value:"Net 45",children:"Net 45"}),e.jsx("option",{value:"Net 60",children:"Net 60"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Status"}),e.jsxs("select",{name:"status",value:E.status,onChange:L,children:[e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]})]})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:_,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:G?"Update Distributor":"Add Distributor"})]})]})]})})]})}const q=l=>{const g=Number(l);return Number.isFinite(g)?g:0},Qa=l=>String((l==null?void 0:l.type)||(l==null?void 0:l.transaction_type)||"").toLowerCase(),At=(l,g=["payment"])=>{const k=Math.abs(q(l==null?void 0:l.amount));return g.includes(Qa(l))?-k:k},Ka=l=>{const g=Qa(l);return g==="payment"?"Payment":g==="given"||g==="credit"?"Credit":g?g.charAt(0).toUpperCase()+g.slice(1):"-"},Va=(l,g=["transaction_date","created_at","date"])=>{for(const k of g){const A=l==null?void 0:l[k];if(!A)continue;const d=new Date(A).getTime();if(Number.isFinite(d))return d}return Date.now()};function Ln({user:l}){const g=ca(),k="purchase_distributor_ledger_local_entries",A="po_entry_modal_size_v1",d=()=>({distributor_id:"",distributor_name:"",order_date:Fs(),notes:"",items:[]}),R=()=>({distributor_id:"",type:"payment",amount:"",payment_mode:"cash",transaction_date:Fs(),reference:"",description:""}),h=()=>({type:"payment",amount:"",payment_mode:"cash",transaction_date:Fs(),reference:"",reason:""}),$=s=>Va(s,["transaction_date","created_at","date"]),D=s=>s!=null&&s.transaction_date?String(s.transaction_date):s!=null&&s.created_at?String(s.created_at):s!=null&&s.date?String(s.date):"",G=s=>{const a=Number(s);return Number.isFinite(a)?a:null},W=s=>String(s||"").trim().toLowerCase(),S=s=>String((s==null?void 0:s.type)||(s==null?void 0:s.transaction_type)||"").trim().toLowerCase(),y=s=>{const a=S(s);return a==="credit"||a==="given"},E=s=>{if(!s||!y(s))return null;const a=ee(s),n=W(s==null?void 0:s.source),m=(s==null?void 0:s.source_id)??(s==null?void 0:s.sourceId);if(n==="purchase_order"&&m!==void 0&&m!==null&&String(m).trim()!=="")return`${a}|poid:${String(m).trim()}`;const c=W((s==null?void 0:s.reference)||(s==null?void 0:s.po_number)),T=W(s==null?void 0:s.description);return c&&T.includes("purchase order")?`${a}|poref:${c}`:null},se=s=>q(s==null?void 0:s.amount).toFixed(2),K=s=>{const a=G(s==null?void 0:s.balance);return a!==null?a:G(s==null?void 0:s.computed_balance)},w=s=>{const a=s!=null&&s.source?String(s.source):"",n=(s==null?void 0:s.source_id)??(s==null?void 0:s.sourceId);return!a||n===void 0||n===null||n===""?null:`${ee(s)}|${a}|${String(n)}`},L=s=>{const a=E(s);if(a)return`po:${a}`;const n=w(s);if(n)return`src:${n}`;const m=ee(s),c=String((s==null?void 0:s.type)||(s==null?void 0:s.transaction_type)||"").toLowerCase(),T=W((s==null?void 0:s.reference)||(s==null?void 0:s.po_number)),V=se(s),I=D(s);return T||I?`fallback:${m}|${c}|${T}|${V}|${I}`:(s==null?void 0:s.id)!==void 0&&(s==null?void 0:s.id)!==null&&String(s.id)!==""?`id:${String(s.id)}`:null},ee=s=>(s==null?void 0:s.distributor_id)!==void 0&&(s==null?void 0:s.distributor_id)!==null?String(s.distributor_id):s!=null&&s.distributor_name?`name:${String(s.distributor_name).toLowerCase()}`:"unknown",re=s=>{const a=q((s==null?void 0:s.total_amount)??(s==null?void 0:s.grand_total)??(s==null?void 0:s.line_total));if(a>0)return a;const m=(Array.isArray(s==null?void 0:s.items)?s.items:[]).reduce((V,I)=>{const M=q((I==null?void 0:I.line_total)??(I==null?void 0:I.total_amount)??(I==null?void 0:I.total));if(M>0)return V+M;const he=q(I==null?void 0:I.taxable_value),He=q(I==null?void 0:I.tax_amount);if(he>0||He>0)return V+he+He;const ze=q(I==null?void 0:I.quantity),ms=q((I==null?void 0:I.rate)??(I==null?void 0:I.unit_price));return V+ze*ms},0);if(m>0)return m;const c=q(s==null?void 0:s.taxable_value),T=q(s==null?void 0:s.tax_amount);return c>0||T>0?c+T:q(s==null?void 0:s.total)},xe=s=>re(s),u=()=>{try{const s=localStorage.getItem(k),a=s?JSON.parse(s):[];return Array.isArray(a)?a:[]}catch{return[]}},_=s=>{try{localStorage.setItem(k,JSON.stringify(s))}catch{}},J=s=>{const a=u();_([s,...a])},B=(s,a)=>{const n=new Set(["confirmed"]),m=(s||[]).filter(c=>n.has(String(c.status||"").toLowerCase())).map(c=>({id:`po-${c.id}`,distributor_id:c.distributor_id,distributor_name:c.distributor_name,type:"credit",transaction_type:"credit",amount:re(c),payment_mode:"credit",reference:c.po_number,bill_number:c.bill_number||c.invoice_number||null,description:`Purchase Order ${c.po_number||""}`.trim(),transaction_date:c.created_at||c.order_date||c.expected_delivery||Fs(),source:"purchase_order",source_id:c.id,mode:"automatic"}));return a?m.filter(c=>String(c.distributor_id)===String(a)):m},P=(s,a,n)=>{const m=Array.isArray(s)?s:[],c=Array.isArray(a)?a:[],T=Array.isArray(n)?n:[],V=new Set([...m,...c].map(ve=>w(ve)).filter(Boolean)),I=T.filter(ve=>{const Ee=E(ve);if(Ee&&[...m,...c].some(rs=>{const ja=E(rs);if(ja&&ja===Ee)return!0;if(!y(rs)||!(ee(rs)===ee(ve)))return!1;const Ha=W((rs==null?void 0:rs.reference)||(rs==null?void 0:rs.po_number))===W((ve==null?void 0:ve.reference)||(ve==null?void 0:ve.po_number)),Wa=se(rs)===se(ve);return Ha&&Wa}))return!1;const et=w(ve);return et?!V.has(et):!0}),M=[...m,...c,...I],he=[],He=new Set;for(const ve of M){const Ee=L(ve);Ee&&He.has(Ee)||(Ee&&He.add(Ee),he.push(ve))}const ze={};return[...he].sort((ve,Ee)=>$(ve)-$(Ee)).map(ve=>{const Ee=ee(ve),et=G(ve==null?void 0:ve.balance);et!==null?ze[Ee]=et:ze[Ee]!==void 0?ze[Ee]+=At(ve):m.length===0&&(ze[Ee]=At(ve));const Wt=ze[Ee];return{...ve,computed_balance:Wt===void 0?null:Wt}}).sort((ve,Ee)=>$(Ee)-$(ve))},te=(s,a)=>{const n={};for(const c of s||[]){const T=ee(c);if(n[T]===void 0){const V=K(c);V!==null&&(n[T]=V)}}if(a){const c=String(a);let T=0;for(const[V,I]of Object.entries(n))if(V===c){T=I;break}return{label:"Distributor Balance",value:T}}return{label:"Total Balance (All Distributors)",value:Object.values(n).reduce((c,T)=>c+q(T),0)}},ce=s=>{const a=q(s.quantity),n=q(s.rate??s.unit_price),m=a*n,c=s.discount_type==="fixed"?"fixed":"percent",T=q(s.discount_value),V=c==="percent"?m*T/100:T,I=Math.max(0,Math.min(V,m)),M=Math.max(0,m-I),he=Math.max(0,q(s.gst_rate)),He=M*he/100,ze=M+He;return{quantity:a,rate:n,grossAmount:m,discountType:c,discountValue:T,discountAmount:I,taxableValue:M,gstRate:he,taxAmount:He,totalAmount:ze}},me=(s=[])=>s.reduce((a,n)=>{const m=ce(n);return a.grossAmount+=m.grossAmount,a.discountAmount+=m.discountAmount,a.taxableValue+=m.taxableValue,a.taxAmount+=m.taxAmount,a.totalAmount+=m.totalAmount,a},{grossAmount:0,discountAmount:0,taxableValue:0,taxAmount:0,totalAmount:0}),[i,b]=r.useState("orders"),[x,z]=r.useState([]),[X,v]=r.useState([]),[F,p]=r.useState([]),[C,O]=r.useState([]),[ie,N]=r.useState(!0),[Z,Q]=r.useState(""),[U,Ne]=r.useState({distributor_id:"",status:"",start_date:"",end_date:""}),[es,Ge]=r.useState(!1),[Ls,Ae]=r.useState(!1),[_s,Xe]=r.useState(!1),[oe,de]=r.useState(!1),[je,ne]=r.useState(!1),[Fe,hs]=r.useState(!1),[Ue,Be]=r.useState(null),[ps,it]=r.useState(null),[Qe,xs]=r.useState(null),[Qs,Cs]=r.useState([]),[lt,Ss]=r.useState(!1),[ge,$e]=r.useState(R()),[Le,Ke]=r.useState(h()),[Rs,ct]=r.useState({expectedAmount:0,currentImpact:0,delta:0,linkedEntries:0}),[ws,cs]=r.useState(!1),[Ks,ae]=r.useState(!1),[_e,Os]=r.useState(null),[ot,Vs]=r.useState(!1),[ss,Is]=r.useState(null),[ts,pe]=r.useState("detailed"),[os,dt]=r.useState(()=>{try{const s=JSON.parse(localStorage.getItem(A)||"{}"),a=q(s.width),n=q(s.height);return{width:a>0?a:980,height:n>0?n:760}}catch{return{width:980,height:760}}}),[zs,Ve]=r.useState(!1),js=r.useRef(null),gs=r.useRef(null),Hs=r.useRef(os),[be,Re]=r.useState({distributor_id:"",distributor_name:"",expected_delivery:"",notes:"",items:[]}),[Se,Ye]=r.useState(d()),[as,ks]=r.useState({invoice_number:"",items:[]}),[De,ue]=r.useState({distributor_id:"",reference_po:"",return_type:"return",reason:"",items:[]});r.useEffect(()=>{Ft()},[]),r.useEffect(()=>{ds()},[U]),r.useEffect(()=>{Hs.current=os},[os]),r.useEffect(()=>{if(!zs)return;const s=n=>{const m=gs.current;if(!m)return;const c=m.startWidth+(n.clientX-m.startX),T=m.startHeight+(n.clientY-m.startY),V=760,I=Math.max(V,Math.floor(window.innerWidth*.95)),M=520,he=Math.max(M,Math.floor(window.innerHeight*.9));dt({width:Math.min(I,Math.max(V,c)),height:Math.min(he,Math.max(M,T))})},a=()=>{Ve(!1),gs.current=null,document.body.classList.remove("po-modal-resizing");try{localStorage.setItem(A,JSON.stringify(Hs.current))}catch{}};return window.addEventListener("mousemove",s),window.addEventListener("mouseup",a),()=>{window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",a)}},[zs]),r.useEffect(()=>{i==="orders"&&As()},[i,U.distributor_id,x]);const Ft=async()=>{try{N(!0);const[s,a]=await Promise.all([at.getAll(),ye.getAll()]);p(s||[]),O(a||[])}catch{Q("Failed to load data")}finally{N(!1)}},ds=async()=>{try{const s=await is.getAll(U);z(s||[])}catch{Q("Failed to load purchase orders")}},Ws=async()=>{try{const s=await ga.getAll(U);v(s||[])}catch{Q("Failed to load purchase returns")}},ns=s=>{const{name:a,value:n}=s.target;Ne(m=>({...m,[a]:n}))},ut=s=>{const a=String(s||"").trim().toLowerCase();return a&&F.find(n=>n.status==="active"&&(String(n.id)===a||String(n.name||"").trim().toLowerCase()===a))||null},mt=s=>{const n=(c=>String(c||"").replace(/^\[(recent|all)\]\s*/i,"").trim())(s).toLowerCase();if(!n)return null;const m=c=>{if(!c)return"";const T=String(c.name||"").trim(),V=String(c.sku||"").trim();return V?`${T} (${V})`:T};return C.find(c=>String(c.id)===n||String(c.name||"").trim().toLowerCase()===n||String(c.sku||"").trim().toLowerCase()===n||m(c).toLowerCase()===n)||null},Ms=s=>{if(!s)return"";const a=String(s.name||"").trim(),n=String(s.sku||"").trim();return n?`${a} (${n})`:a},Us=(s,a="all")=>{const n=Ms(s);return a==="recent"?`[Recent] ${n}`:`[All] ${n}`},ht=s=>{const a=String(s||"").trim();if(!a)return{prioritized:[],all:C};const n=new Map(C.map(M=>[String(M.id),M])),m=new Map;(x||[]).forEach(M=>{if(String((M==null?void 0:M.distributor_id)||"")!==a)return;const he=new Date((M==null?void 0:M.created_at)||(M==null?void 0:M.order_date)||(M==null?void 0:M.expected_delivery)||0).getTime();(Array.isArray(M==null?void 0:M.items)?M.items:[]).forEach(ze=>{const ms=String((ze==null?void 0:ze.product_id)||"").trim();if(!ms)return;const Zs=m.get(ms)||{count:0,latest:0};m.set(ms,{count:Zs.count+1,latest:Math.max(Zs.latest,Number.isFinite(he)?he:0)})})});const T=[...m.entries()].sort((M,he)=>he[1].latest!==M[1].latest?he[1].latest-M[1].latest:he[1].count-M[1].count).map(([M])=>M).map(M=>n.get(M)).filter(Boolean),V=new Set(T.map(M=>String(M.id))),I=C.filter(M=>!V.has(String(M.id)));return{prioritized:T,all:I}},pt=s=>{const a=ut(s);Re(n=>({...n,distributor_name:s,distributor_id:a?String(a.id):""}))},Tt=s=>{const a=ut(s);Ye(n=>({...n,distributor_name:s,distributor_id:a?String(a.id):""}))},Ps=s=>{if(!s)return"";const a=String(s);if(/^\d{4}-\d{2}-\d{2}/.test(a))return a.slice(0,10);const n=new Date(s);return Number.isNaN(n.getTime())?"":cn(n)},Y=()=>{Re(s=>({...s,items:[...s.items,{product_id:"",product_query:"",product_name:"",quantity:1,uom:"pcs",unit_price:0,rate:0,gst_rate:5,discount_type:"percent",discount_value:0}]}))},As=async()=>{try{Ss(!0);const s=u().filter(c=>!U.distributor_id||String(c.distributor_id)===String(U.distributor_id)),a=B(x,U.distributor_id),n=U.distributor_id?await Bs.getByDistributor(U.distributor_id,{limit:100}):await Bs.getAll({limit:100}),m=Array.isArray(n)?n:(n==null?void 0:n.rows)||(n==null?void 0:n.data)||(n==null?void 0:n.transactions)||[];Cs(P(m,s,a))}catch{const a=u().filter(m=>!U.distributor_id||String(m.distributor_id)===String(U.distributor_id)),n=B(x,U.distributor_id);Cs(P([],a,n))}finally{Ss(!1)}},xt=async({distributorId:s,amount:a,poNumber:n,orderId:m,billNumber:c})=>{!s||a<=0||await Bs.addTransaction(s,{type:"credit",transaction_type:"credit",amount:Number(a.toFixed(2)),payment_mode:"credit",reference:n||(m?`PO-${m}`:""),bill_number:c||null,description:`Purchase Order ${n||""}${c?` (Bill: ${c})`:""}`.trim(),transactionDate:Fs(),source:"purchase_order",source_id:m,mode:"automatic",created_by:l==null?void 0:l.id})},us=async(s,a,n)=>{const m=[...be.items];if(m[s][a]=n,a==="product_id"){const c=String(n||""),T=C.find(V=>String(V.id)===c);if(T){const V=q(T.price);m[s].product_name=T.name,m[s].product_query=Ms(T),m[s].unit_price=V,m[s].rate=V,m[s].uom=T.uom||"pcs",m[s].last_purchase_hint=""}else m[s].product_query="",m[s].product_name="",m[s].last_purchase_hint="";if(Re(V=>({...V,items:m})),!c)return;try{const V=await ye.getLastPurchase(c);if(!(V!=null&&V.found))return;Re(I=>{const M=[...I.items],he=M[s];if(!he||String(he.product_id)!==c)return I;const He=q(V.rate??V.unit_price??he.rate??he.unit_price),ze=q(V.gst_rate??he.gst_rate??5),ms=V.created_at?new Date(V.created_at).toLocaleDateString():"",Zs=V.po_number||"last PO";return M[s]={...he,unit_price:He,rate:He,gst_rate:ze,uom:V.uom||he.uom||"pcs",last_purchase_hint:`Suggested from ${Zs}${ms?` (${ms})`:""}`},{...I,items:M}})}catch{}return}a==="rate"&&(m[s].unit_price=q(n)),a==="unit_price"&&(m[s].rate=q(n)),Re(c=>({...c,items:m}))},$t=(s,a)=>{const n=[...be.items];n[s].product_query=a;const m=mt(a);if(!m){n[s].product_id="",n[s].product_name=a,n[s].last_purchase_hint="",Re(c=>({...c,items:n}));return}Re(c=>({...c,items:n})),us(s,"product_id",String(m.id))},bs=s=>{Re(a=>({...a,items:a.items.filter((n,m)=>m!==s)}))},qs=()=>{Re({distributor_id:"",distributor_name:"",expected_delivery:"",notes:"",items:[]}),Is(null),pe("detailed")},Lt=()=>{Q(""),qs(),Ge(!0)},Ds=()=>{Ge(!1),qs()},jt=s=>{if(g||!js.current)return;s.preventDefault();const a=js.current.getBoundingClientRect();gs.current={startX:s.clientX,startY:s.clientY,startWidth:a.width,startHeight:a.height},document.body.classList.add("po-modal-resizing"),Ve(!0)},gt=async s=>{s.preventDefault(),Q("");try{if(!F.find(I=>String(I.id)===String(be.distributor_id)&&I.status==="active")){Q("Please select a valid distributor");return}if(be.items.filter(I=>String(I.product_query||"").trim()&&!I.product_id).length>0){Q("Please select valid products from suggestions for all typed product names");return}const m=be.items.filter(I=>I.product_id&&I.quantity>0);if(m.length===0){Q("Please add at least one item");return}const c=m.map(I=>{const M=ce(I);return{...I,quantity:M.quantity,unit_price:M.rate,rate:M.rate,gst_rate:M.gstRate,discount_type:M.discountType,discount_value:M.discountValue,taxable_value:M.taxableValue,tax_amount:M.taxAmount,line_total:M.totalAmount}}),T=me(c),V={distributor_id:be.distributor_id,expected_delivery:be.expected_delivery,notes:be.notes,subtotal:T.taxableValue,taxable_value:T.taxableValue,tax_amount:T.taxAmount,total_amount:T.totalAmount,grand_total:T.totalAmount,total:T.totalAmount,items:c,created_by:l==null?void 0:l.id};ss?await is.update(ss,V):await is.create(V),Ds(),await ds()}catch(a){Q(a.message||(ss?"Failed to update purchase order":"Failed to create purchase order"))}},Gs=async s=>{var a;try{Q("");const n=await is.getById(s);if(!n||String(n.status||"").toLowerCase()!=="pending"){Q("Only pending orders can be edited");return}const m=(n.items||[]).map(c=>({product_id:c.product_id?String(c.product_id):"",product_query:c.product_name||"",product_name:c.product_name||"",quantity:q(c.quantity),uom:c.uom||"pcs",unit_price:q(c.unit_price??c.rate),rate:q(c.rate??c.unit_price),gst_rate:q(c.gst_rate),discount_type:c.discount_type==="fixed"?"fixed":"percent",discount_value:q(c.discount_value),last_purchase_hint:""}));Re({distributor_id:n.distributor_id?String(n.distributor_id):"",distributor_name:n.distributor_name||((a=F.find(c=>String(c.id)===String(n.distributor_id)))==null?void 0:a.name)||"",expected_delivery:Ps(n.expected_delivery),notes:n.notes||"",items:m}),Is(n.id),Ge(!0)}catch(n){Q(n.message||"Failed to load order for edit")}},Oe=()=>{Ye(s=>({...s,items:[...s.items,{product_id:"",product_query:"",product_name:"",quantity:1,uom:"pcs"}]}))},Ie=s=>{Ye(a=>({...a,items:a.items.filter((n,m)=>m!==s)}))},bt=(s,a,n)=>{const m=[...Se.items];if(m[s][a]=n,a==="product_id"){const c=String(n||""),T=C.find(V=>String(V.id)===c);T?(m[s].product_name=T.name,m[s].product_query=Ms(T),m[s].uom=T.uom||"pcs"):(m[s].product_query="",m[s].product_name="")}Ye(c=>({...c,items:m}))},vt=(s,a)=>{const n=[...Se.items];n[s].product_query=a;const m=mt(a);if(!m){n[s].product_id="",n[s].product_name=a,Ye(c=>({...c,items:n}));return}Ye(c=>({...c,items:n})),bt(s,"product_id",String(m.id))},Ce=()=>{Ae(!1),Ye(d())},Rt=async s=>{s.preventDefault(),Q("");try{if(!F.find(T=>String(T.id)===String(Se.distributor_id)&&T.status==="active")){Q("Please select a valid distributor");return}if(Se.items.filter(T=>String(T.product_query||"").trim()&&!T.product_id).length>0){Q("Please select valid products from suggestions for all typed product names");return}const m=Se.items.filter(T=>T.product_id&&q(T.quantity)>0);if(m.length===0){Q("Please add at least one item");return}const c=m.map(T=>({product_id:Number(T.product_id),product_name:T.product_name,quantity:q(T.quantity),uom:T.uom||"pcs",unit_price:0,rate:0,gst_rate:0,discount_type:"percent",discount_value:0,taxable_value:0,tax_amount:0,line_total:0}));await is.create({distributor_id:Number(Se.distributor_id),expected_delivery:Se.order_date,notes:Se.notes||"Quick entry draft",subtotal:0,taxable_value:0,tax_amount:0,total_amount:0,grand_total:0,total:0,items:c,created_by:l==null?void 0:l.id}),Ce(),await ds()}catch(a){Q(a.message||"Failed to create quick purchase order")}},ft=s=>{var a;Be(s),ks({invoice_number:"",items:((a=s.items)==null?void 0:a.map(n=>({item_id:n.id,product_id:n.product_id,product_name:n.product_name,ordered_quantity:n.quantity,received_quantity:n.quantity-(n.received_quantity||0),unit_price:n.unit_price})))||[]}),Xe(!0)},vs=(s,a,n)=>{const m=[...as.items];m[s][a]=n,ks(c=>({...c,items:m}))},Xs=(s,a)=>{const n=as.items[s];if(!n)return;const m=q(n.received_quantity),c=Math.max(0,Math.min(q(n.ordered_quantity),m+a));vs(s,"received_quantity",c)},yt=async s=>{s.preventDefault(),Q("");try{const a=as.items.filter(n=>n.received_quantity>0);if(a.length===0){Q("Please receive at least one item");return}await is.receive(Ue.id,{invoice_number:as.invoice_number,items:a,received_by:l==null?void 0:l.id}),Xe(!1),Be(null),ks({invoice_number:"",items:[]}),ds()}catch(a){Q(a.message||"Failed to receive inventory")}},Ot=async(s,a)=>{try{Q("");let n=x.find(c=>String(c.id)===String(s)),m="";if(a==="confirmed"){const c=String((n==null?void 0:n.bill_number)||(n==null?void 0:n.invoice_number)||"").trim(),T=window.prompt("Enter Bill No (optional). Leave blank to continue.",c);if(T===null)return;m=String(T).trim()}if(await is.updateStatus(s,a,m?{bill_number:m}:{}),a==="confirmed"){try{const c=await is.getById(s);c&&(n=c)}catch{}if(n)try{await xt({distributorId:n.distributor_id,amount:re(n),poNumber:n.po_number,orderId:n.id,billNumber:m||n.bill_number||n.invoice_number||""})}catch(c){console.warn("Auto distributor credit entry failed on confirmation:",c)}}ds(),As()}catch{Q("Failed to update status")}},Nt=async s=>{if(window.confirm("Are you sure you want to delete this purchase order?"))try{await is.delete(s),ds()}catch{Q("Failed to delete order")}},It=async s=>{try{ae(!0),Os(null),Vs(!0);const a=await is.getById(s);Os(a)}catch{Q("Failed to load order details"),ae(!1)}finally{Vs(!1)}},zt=()=>{ue({distributor_id:"",reference_po:"",return_type:"return",reason:"",items:[]}),de(!0)},Mt=()=>{ue(s=>({...s,items:[...s.items,{product_id:"",product_name:"",quantity:1,uom:"pcs",unit_price:0,reason:""}]}))},Ys=(s,a,n)=>{const m=[...De.items];if(m[s][a]=n,a==="product_id"){const c=C.find(T=>T.id===parseInt(n));c&&(m[s].product_name=c.name,m[s].unit_price=c.price,m[s].uom=c.uom||"pcs")}ue(c=>({...c,items:m}))},Ut=s=>{ue(a=>({...a,items:a.items.filter((n,m)=>m!==s)}))},qt=async s=>{s.preventDefault(),Q("");try{const a=De.items.filter(n=>n.product_id&&n.quantity>0);if(a.length===0){Q("Please add at least one item");return}await ga.create({distributor_id:De.distributor_id,reference_po:De.reference_po,return_type:De.return_type,reason:De.reason,items:a,created_by:l==null?void 0:l.id}),de(!1),ue({distributor_id:"",reference_po:"",return_type:"return",reason:"",items:[]}),Ws()}catch(a){Q(a.message||"Failed to create return")}},Bt=s=>{const n={pending:{label:"Pending",class:"pending"},confirmed:{label:"Confirmed",class:"confirmed"},shipped:{label:"Shipped",class:"shipped"},received:{label:"Received",class:"received"},cancelled:{label:"Cancelled",class:"cancelled"}}[s]||{label:s,class:""};return e.jsx("span",{className:`status-badge ${n.class}`,children:n.label})},Qt=s=>{if(!s)return"";if(typeof s=="object"&&s.phone)return String(s.phone);const a=String(s).trim();if(!a)return"";try{const n=JSON.parse(a);return String((n==null?void 0:n.phone)||"")}catch{return""}},_t=s=>{if(!s)return{name:"-",phone:"-",address:"-",contacts:""};const a=F.find(c=>String(c.id)===String(s.distributor_id)),n=s.distributor_contacts||(a==null?void 0:a.contacts)||"",m=Qt(n);return{name:s.distributor_name||(a==null?void 0:a.name)||"-",phone:s.distributor_phone||(a==null?void 0:a.phone)||m||"-",address:s.distributor_address||(a==null?void 0:a.address)||"-",contacts:n}},Ct=s=>{const a=q(s==null?void 0:s.quantity),n=q((s==null?void 0:s.rate)??(s==null?void 0:s.unit_price)),m=a*n,c=q(s==null?void 0:s.taxable_value),T=q(s==null?void 0:s.tax_amount),V=q((s==null?void 0:s.line_total)??(s==null?void 0:s.total)??c+T??m),I=c>0?c:T>0?Math.max(0,V-T):V,M=q(s==null?void 0:s.gst_rate);return{quantity:a,rate:n,taxableValue:I,taxAmount:T,lineTotal:V>0?V:m,gstRate:M}},Kt=s=>{const a=Array.isArray(s==null?void 0:s.items)?s.items:[],n=_t(s),m=a.map((I,M)=>{const he=Ct(I);return`
        <tr>
          <td>${M+1}</td>
          <td>${we((I==null?void 0:I.product_name)||"-")}</td>
          <td>${he.quantity}</td>
          <td>${we((I==null?void 0:I.uom)||"-")}</td>
          <td>${H(he.rate)}</td>
          <td>${he.gstRate.toFixed(2)}%</td>
          <td>${H(he.taxableValue)}</td>
          <td>${H(he.taxAmount)}</td>
          <td>${H(he.lineTotal)}</td>
        </tr>
      `}).join(""),c=q(s==null?void 0:s.taxable_value),T=q(s==null?void 0:s.tax_amount),V=q((s==null?void 0:s.total_amount)||xe(s));return`
      <div class="po-print">
        <div class="po-print-header">
          <div>
            <h1>Purchase Order</h1>
            <div class="muted">PO #${(s==null?void 0:s.po_number)||"-"}</div>
          </div>
          <div class="meta">
            <div><strong>Status:</strong> ${String((s==null?void 0:s.status)||"-").toUpperCase()}</div>
            <div><strong>Date:</strong> ${Zt((s==null?void 0:s.created_at)||(s==null?void 0:s.order_date))}</div>
            <div><strong>Expected:</strong> ${Zt(s==null?void 0:s.expected_delivery)}</div>
            <div><strong>Bill No:</strong> ${(s==null?void 0:s.bill_number)||(s==null?void 0:s.invoice_number)||"-"}</div>
          </div>
        </div>

        <div class="po-print-party">
          <div>
            <h3>Supplier</h3>
            <div>${we(n.name)}</div>
            <div>${we(n.phone)}</div>
            <div>${we(n.address)}</div>
          </div>
          <div>
            <h3>Order Notes</h3>
            <div>${we((s==null?void 0:s.notes)||"-")}</div>
          </div>
        </div>

        <table class="po-print-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Product</th>
              <th>Qty</th>
              <th>UOM</th>
              <th>Rate</th>
              <th>GST %</th>
              <th>Taxable</th>
              <th>Tax</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>${m||'<tr><td colspan="9">No items</td></tr>'}</tbody>
        </table>

        <div class="po-print-summary">
          <div><span>Taxable Value</span><strong>${H(c)}</strong></div>
          <div><span>GST</span><strong>${H(T)}</strong></div>
          <div class="grand"><span>Grand Total</span><strong>${H(V)}</strong></div>
        </div>
      </div>
    `},Vt=s=>{if(!s)return;const a=Kt(s);Ia({title:`PO ${(s==null?void 0:s.po_number)||""}`,bodyHtml:a,cssText:`
        .po-print { max-width: 980px; margin: 0 auto; }
        .po-print-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; }
        .po-print-header h1 { margin: 0 0 6px; font-size: 26px; }
        .muted { color: #555; font-size: 13px; }
        .meta { font-size: 13px; line-height: 1.6; text-align: right; }
        .po-print-party { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
        .po-print-party h3 { margin: 0 0 8px; font-size: 13px; text-transform: uppercase; color: #444; }
        .po-print-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .po-print-table th, .po-print-table td { border: 1px solid #d1d5db; padding: 7px; text-align: left; }
        .po-print-table thead th { background: #f3f4f6; font-weight: 700; }
        .po-print-summary { margin-top: 14px; margin-left: auto; width: 320px; }
        .po-print-summary div { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #e5e7eb; font-size: 13px; }
        .po-print-summary .grand { font-size: 15px; font-weight: 700; border-bottom: none; }
        @media print {
          body { margin: 0; padding: 10mm; }
          .po-print-table tr { page-break-inside: avoid; }
        }
      `,onError:n=>Q(n)})},t=s=>{if(s!=null&&s.distributor_name)return s.distributor_name;const a=s==null?void 0:s.distributor_id;if(!a)return"-";const n=F.find(m=>String(m.id)===String(a));return(n==null?void 0:n.name)||"-"},o=s=>(s==null?void 0:s.bill_number)||(s==null?void 0:s.linked_bill_number)||(s==null?void 0:s.po_bill_number)||(s==null?void 0:s.invoice_number)||(s==null?void 0:s.po_invoice_number)||"-",j=s=>Array.isArray(s)?s:(s==null?void 0:s.rows)||(s==null?void 0:s.data)||(s==null?void 0:s.transactions)||[],f=(s,a)=>{if(!a)return[];const n=String(a.id||"").trim(),m=W(a.po_number);return(s||[]).filter(c=>{const T=W(c==null?void 0:c.source),V=(c==null?void 0:c.source_id)??(c==null?void 0:c.sourceId);if((T==="purchase_order"||T==="po_correction")&&V!==void 0&&V!==null&&String(V).trim()===n)return!0;const I=W((c==null?void 0:c.reference)||(c==null?void 0:c.po_number));if(!m||!I||I!==m)return!1;const M=W(c==null?void 0:c.description);return M.includes("purchase order")||M.includes("po correction")||M.includes("ledger correction")})},le=(s,a)=>f(s,a).reduce((n,m)=>n+At(m),0),fe=()=>{hs(!1),xs(null),Ke(h()),ct({expectedAmount:0,currentImpact:0,delta:0,linkedEntries:0}),cs(!1)},qe=async s=>{if(!s||!s.distributor_id){Q("Cannot open correction form. Invalid purchase order/distributor.");return}try{Q(""),cs(!0);const a=await Bs.getByDistributor(s.distributor_id,{limit:500}),n=j(a),m=f(n,s),c=re(s),T=le(n,s),V=Number((c-T).toFixed(2)),I=V<0?"payment":"credit",M=Math.abs(V);xs(s),ct({expectedAmount:c,currentImpact:T,delta:V,linkedEntries:m.length}),Ke({...h(),type:I,amount:M>0?M.toFixed(2):"",reference:s.po_number||""}),hs(!0)}catch(a){Q((a==null?void 0:a.message)||"Failed to load PO ledger impact for correction")}finally{cs(!1)}},ha=async s=>{if(s.preventDefault(),!Qe)return;const a=q(Le.amount),n=String(Le.reason||"").trim();if(a<=0){Q("Correction amount must be greater than 0");return}if(!n){Q("Correction reason is required");return}try{Q(""),cs(!0),await Bs.addTransaction(Qe.distributor_id,{type:Le.type,transaction_type:Le.type,amount:Number(a.toFixed(2)),payment_mode:Le.payment_mode,reference:Le.reference||Qe.po_number||"",description:`PO correction for ${Qe.po_number||Qe.id}: ${n}`,transactionDate:Le.transaction_date,source:"po_correction",source_id:Qe.id,mode:"manual",created_by:l==null?void 0:l.id}),fe(),As()}catch(m){Q((m==null?void 0:m.message)||"Failed to post PO correction")}finally{cs(!1)}},Js=()=>{$e({...R(),distributor_id:U.distributor_id||""}),ne(!0)},St=async s=>{s.preventDefault(),Q("");const a=q(ge.amount);if(!ge.distributor_id){Q("Please select a distributor for ledger entry");return}if(a<=0){Q("Please enter a valid amount");return}try{await Bs.addTransaction(ge.distributor_id,{type:ge.type,transaction_type:ge.type,amount:Number(a.toFixed(2)),payment_mode:ge.payment_mode,reference:ge.reference,description:ge.description||`Manual ${ge.type} entry`,transactionDate:ge.transaction_date,mode:"manual",created_by:l==null?void 0:l.id}),ne(!1),$e(R()),As()}catch{const m={id:`local-${Date.now()}`,distributor_id:ge.distributor_id,type:ge.type,transaction_type:ge.type,amount:Number(a.toFixed(2)),payment_mode:ge.payment_mode,reference:ge.reference,description:ge.description||`Manual ${ge.type} entry`,transaction_date:ge.transaction_date,created_at:new Date().toISOString(),mode:"manual"};J(m),ne(!1),$e(R()),As()}},fs=me(be.items),Ht=te(Qs,U.distributor_id),pa=r.useMemo(()=>ht(be.distributor_id),[be.distributor_id,x,C]),xa=r.useMemo(()=>ht(Se.distributor_id),[Se.distributor_id,x,C]);return ie?e.jsx("div",{className:"purchase-management",children:e.jsx("div",{className:"loading",children:"Loading purchase data..."})}):e.jsxs("div",{className:"purchase-management",children:[Z&&e.jsx("div",{className:"error-message",children:Z}),e.jsxs("div",{className:"sub-nav",children:[e.jsxs("button",{className:i==="orders"?"active":"",onClick:()=>b("orders"),children:[e.jsx($s,{size:18})," Purchase Orders"]}),e.jsxs("button",{className:i==="returns"?"active":"",onClick:()=>{b("returns"),Ws()},children:[e.jsx(ya,{size:18})," Purchase Returns"]})]}),i==="orders"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"filters-bar",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Distributor:"}),e.jsxs("select",{name:"distributor_id",value:U.distributor_id,onChange:ns,children:[e.jsx("option",{value:"",children:"All Distributors"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Status:"}),e.jsxs("select",{name:"status",value:U.status,onChange:ns,children:[e.jsx("option",{value:"",children:"All Status"}),e.jsx("option",{value:"pending",children:"Pending"}),e.jsx("option",{value:"confirmed",children:"Confirmed"}),e.jsx("option",{value:"shipped",children:"Shipped"}),e.jsx("option",{value:"received",children:"Received"}),e.jsx("option",{value:"cancelled",children:"Cancelled"})]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"From:"}),e.jsx("input",{type:"date",name:"start_date",value:U.start_date,onChange:ns})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"To:"}),e.jsx("input",{type:"date",name:"end_date",value:U.end_date,onChange:ns})]})]}),e.jsxs("div",{className:"actions-bar",children:[e.jsx("h2",{children:"Purchase Orders"}),e.jsxs("div",{className:"action-buttons",children:[e.jsxs("button",{className:"admin-btn secondary",onClick:Js,children:[e.jsx(Me,{size:18})," Payment / Credit Entry"]}),e.jsxs("button",{className:"admin-btn secondary",onClick:zt,children:[e.jsx(ya,{size:18})," Return / Exchange"]}),e.jsxs("button",{className:"admin-btn primary",onClick:Lt,children:[e.jsx(Me,{size:18})," New Order"]})]})]}),e.jsx("div",{className:"data-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"PO Number"}),e.jsx("th",{children:"Distributor"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Expected"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:x.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"empty-state",children:"No purchase orders found"})}):x.map(s=>{var a;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:s.po_number})}),e.jsx("td",{children:s.distributor_name}),e.jsx("td",{children:((a=s.items)==null?void 0:a.length)||0}),e.jsx("td",{children:H(xe(s))}),e.jsx("td",{children:Bt(s.status)}),e.jsx("td",{children:s.expected_delivery?new Date(s.expected_delivery).toLocaleDateString():"-"}),e.jsxs("td",{className:"actions-cell",children:[e.jsx("button",{className:"action-btn view",title:"View Details",onClick:()=>It(s.id),children:e.jsx(za,{size:16})}),s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"action-btn edit",title:"Edit",onClick:()=>Gs(s.id),children:e.jsx(rt,{size:16})}),e.jsx("button",{className:"action-btn",title:"Confirm",onClick:()=>Ot(s.id,"confirmed"),children:e.jsx(yn,{size:16})})]}),s.status==="shipped"&&e.jsx("button",{className:"action-btn receive",title:"Receive",onClick:()=>ft(s),children:e.jsx($s,{size:16})}),s.status==="confirmed"&&e.jsx("button",{className:"action-btn correction",title:"Correct Ledger Impact",onClick:()=>qe(s),disabled:ws,children:e.jsx(vn,{size:16})}),s.status==="pending"&&e.jsx("button",{className:"action-btn delete",title:"Delete",onClick:()=>Nt(s.id),children:e.jsx(ls,{size:16})})]})]},s.id)})})]})}),e.jsx("div",{className:"actions-bar ledger-header",children:e.jsx("h2",{children:"Distributor Credit / Payment Ledger"})}),e.jsxs("div",{className:"ledger-balance-summary",children:[e.jsx("span",{className:"ledger-balance-label",children:Ht.label}),e.jsx("strong",{className:`ledger-balance-value ${Ht.value>=0?"positive":"negative"}`,children:H(Ht.value)})]}),e.jsx("div",{className:"data-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Distributor"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Amount"}),e.jsx("th",{children:"Balance"}),e.jsx("th",{children:"Mode"}),e.jsx("th",{children:"Reference"}),e.jsx("th",{children:"Bill No"}),e.jsx("th",{children:"Description"})]})}),e.jsx("tbody",{children:lt?e.jsx("tr",{children:e.jsx("td",{colSpan:"9",className:"empty-state",children:"Loading ledger records..."})}):Qs.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"9",className:"empty-state",children:"No distributor payment/credit records found"})}):Qs.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:new Date(s.created_at||s.transaction_date||Date.now()).toLocaleDateString()}),e.jsx("td",{children:t(s)}),e.jsx("td",{children:Ka(s)}),e.jsx("td",{children:H(q(s.amount))}),e.jsx("td",{children:K(s)===null?"-":H(K(s))}),e.jsx("td",{children:s.payment_mode||s.method||"-"}),e.jsx("td",{children:s.reference||s.po_number||"-"}),e.jsx("td",{children:o(s)}),e.jsx("td",{children:s.description||"-"})]},s.id||a))})]})})]}),i==="returns"&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"filters-bar",children:e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Distributor:"}),e.jsxs("select",{name:"distributor_id",value:U.distributor_id,onChange:ns,children:[e.jsx("option",{value:"",children:"All Distributors"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]})}),e.jsx("div",{className:"data-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Return Number"}),e.jsx("th",{children:"Distributor"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Items"}),e.jsx("th",{children:"Total"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:X.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"7",className:"empty-state",children:"No purchase returns found"})}):X.map(s=>{var a;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("strong",{children:s.return_number})}),e.jsx("td",{children:s.distributor_name}),e.jsx("td",{children:e.jsx("span",{className:`type-badge ${s.return_type}`,children:s.return_type==="exchange"?"Exchange":"Return"})}),e.jsx("td",{children:((a=s.items)==null?void 0:a.length)||0}),e.jsx("td",{children:H(s.total)}),e.jsx("td",{children:s.reason||"-"}),e.jsx("td",{children:new Date(s.created_at).toLocaleDateString()})]},s.id)})})]})})]}),Ls&&e.jsx("div",{className:"modal-overlay",onClick:Ce,children:e.jsxs("div",{ref:js,className:"modal-content large po-form-modal",onClick:s=>s.stopPropagation(),style:g?void 0:{width:`${os.width}px`,height:`${os.height}px`},children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Quick Purchase Entry"}),e.jsx("button",{className:"close-btn",onClick:Ce,children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:Rt,className:"po-entry-form",children:[e.jsxs("div",{className:"form-section po-form-section po-form-header",children:[e.jsxs("div",{className:"form-row po-info-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor *"}),e.jsx("input",{type:"text",list:"po-distributor-list-quick",value:Se.distributor_name||"",onChange:s=>Tt(s.target.value),placeholder:"Type distributor name",required:!0}),e.jsx("datalist",{id:"po-distributor-list-quick",children:F.filter(s=>s.status==="active").map(s=>e.jsx("option",{value:s.name},s.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:Se.order_date,onChange:s=>Ye(a=>({...a,order_date:s.target.value}))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{value:Se.notes,onChange:s=>Ye(a=>({...a,notes:s.target.value})),rows:"2",placeholder:"Optional short note"})]})]}),e.jsxs("div",{className:"form-section po-form-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h3",{children:"Items (Product + Qty)"}),e.jsxs("button",{type:"button",className:"add-item-btn",onClick:Oe,children:[e.jsx(Me,{size:16})," Add Row"]})]}),e.jsx("div",{className:"quick-entry-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"UOM"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:Se.items.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",className:"empty-state",children:"No rows added"})}):Se.items.map((s,a)=>e.jsxs("tr",{children:[e.jsxs("td",{children:[e.jsx("input",{type:"text",list:`quick-po-product-list-${a}`,value:s.product_query||"",onChange:n=>vt(a,n.target.value),placeholder:"Type product name / SKU"}),e.jsxs("datalist",{id:`quick-po-product-list-${a}`,children:[xa.prioritized.map(n=>e.jsx("option",{value:Us(n,"recent")},`quick-recent-${a}-${n.id}`)),xa.all.map(n=>e.jsx("option",{value:Us(n,"all")},`quick-all-${a}-${n.id}`))]})]}),e.jsx("td",{children:e.jsx("input",{type:"number",min:"1",value:s.quantity,onChange:n=>bt(a,"quantity",q(n.target.value))})}),e.jsx("td",{children:e.jsx("input",{type:"text",value:s.uom||"pcs",readOnly:!0})}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"remove-item-btn",onClick:()=>Ie(a),children:e.jsx(ke,{size:16})})})]},a))})]})})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:Ce,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:"Save Quick Draft"})]})]}),!g&&e.jsx("button",{type:"button",className:"po-modal-resize-handle",onMouseDown:jt,"aria-label":"Resize purchase order form",title:"Drag to resize"})]})}),es&&e.jsx("div",{className:"modal-overlay",onClick:Ds,children:e.jsxs("div",{className:"modal-content large po-form-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:ss?"Edit Purchase Order":"Create Purchase Order"}),e.jsx("button",{className:"close-btn",onClick:Ds,children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:gt,className:`po-entry-form ${ts==="quick"?"quick-mode":""}`,children:[e.jsxs("div",{className:"po-entry-mode-tabs",role:"tablist","aria-label":"Purchase entry mode",children:[e.jsx("button",{type:"button",className:ts==="detailed"?"active":"",onClick:()=>pe("detailed"),role:"tab","aria-selected":ts==="detailed",children:"Detailed Entry"}),e.jsx("button",{type:"button",className:ts==="quick"?"active":"",onClick:()=>pe("quick"),role:"tab","aria-selected":ts==="quick",children:"Quick Entry"})]}),e.jsxs("div",{className:"form-section po-form-section po-form-header",children:[e.jsxs("div",{className:"form-row po-info-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor *"}),e.jsx("input",{type:"text",list:"po-distributor-list",value:be.distributor_name||"",onChange:s=>pt(s.target.value),placeholder:"Type distributor name",required:!0}),e.jsx("datalist",{id:"po-distributor-list",children:F.filter(s=>s.status==="active").map(s=>e.jsx("option",{value:s.name},s.id))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Expected Delivery"}),e.jsx("input",{type:"date",value:be.expected_delivery,onChange:s=>Re(a=>({...a,expected_delivery:s.target.value}))})]})]}),e.jsx("div",{className:"form-row po-info-row",children:e.jsxs("div",{className:"form-group po-note-group",children:[e.jsx("label",{children:"Notes"}),e.jsx("textarea",{value:be.notes,onChange:s=>Re(a=>({...a,notes:s.target.value})),rows:"2"})]})})]}),e.jsxs("div",{className:"form-section po-form-section po-products-section",children:[e.jsx("div",{className:"section-header",children:e.jsx("h3",{children:"Order Items"})}),e.jsxs("div",{className:"items-list",children:[be.items.map((s,a)=>{const n=ce(s),m=n.quantity>0?n.totalAmount/n.quantity:0;return e.jsxs("div",{className:"item-row order-item-row po-item-row",children:[e.jsxs("div",{className:"po-item-main",children:[e.jsxs("div",{className:"item-field product",children:[e.jsx("label",{children:"Product"}),e.jsx("input",{type:"text",list:`po-product-list-${a}`,value:s.product_query||"",onChange:c=>$t(a,c.target.value),placeholder:"Type product name / SKU"}),e.jsxs("datalist",{id:`po-product-list-${a}`,children:[pa.prioritized.map(c=>e.jsx("option",{value:Us(c,"recent")},`order-recent-${a}-${c.id}`)),pa.all.map(c=>e.jsx("option",{value:Us(c,"all")},`order-all-${a}-${c.id}`))]}),s.last_purchase_hint&&e.jsx("small",{className:"field-hint",children:s.last_purchase_hint})]}),e.jsxs("div",{className:"item-field qty",children:[e.jsx("label",{children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:s.quantity,onChange:c=>us(a,"quantity",q(c.target.value))})]}),e.jsxs("div",{className:"item-field uom",children:[e.jsx("label",{children:"UOM"}),e.jsx("input",{type:"text",value:s.uom,readOnly:!0})]}),ts!=="quick"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"item-field price",children:[e.jsx("label",{children:"Rate"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.rate??s.unit_price,onChange:c=>us(a,"rate",q(c.target.value))})]}),e.jsxs("div",{className:"item-field gst",children:[e.jsx("label",{children:"GST %"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.gst_rate??0,onChange:c=>us(a,"gst_rate",q(c.target.value))})]})]})]}),ts!=="quick"&&e.jsxs("div",{className:"po-item-discount",children:[e.jsxs("div",{className:"item-field discount-type",children:[e.jsx("label",{children:"Discount Type"}),e.jsxs("select",{value:s.discount_type||"percent",onChange:c=>us(a,"discount_type",c.target.value),children:[e.jsx("option",{value:"percent",children:"%"}),e.jsx("option",{value:"fixed",children:"Fixed"})]})]}),e.jsxs("div",{className:"item-field discount-value",children:[e.jsx("label",{children:"Discount"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.discount_value??0,onChange:c=>us(a,"discount_value",q(c.target.value))})]})]}),e.jsxs("div",{className:"po-item-amounts",children:[e.jsxs("div",{className:"item-field cost-per-item",children:[e.jsx("label",{children:"Cost Per Item (After Discount + Tax)"}),e.jsx("span",{children:H(m)})]}),e.jsxs("div",{className:"item-field taxable",children:[e.jsx("label",{children:"Taxable Value"}),e.jsx("span",{children:H(n.taxableValue)})]}),e.jsxs("div",{className:"item-field tax",children:[e.jsx("label",{children:"Tax"}),e.jsx("span",{children:H(n.taxAmount)})]}),e.jsxs("div",{className:"item-field total",children:[e.jsx("label",{children:"Total Amount"}),e.jsx("span",{children:H(n.totalAmount)})]})]}),e.jsx("button",{type:"button",className:"remove-item-btn po-remove-btn",onClick:()=>bs(a),children:e.jsx(ke,{size:16})})]},a)}),be.items.length===0&&e.jsx("p",{className:"no-items",children:'No items added. Click "Add Item" to add products.'})]}),e.jsx("div",{className:"po-products-actions",children:e.jsxs("button",{type:"button",className:"add-item-btn",onClick:Y,children:[e.jsx(Me,{size:16})," Add Item"]})})]}),e.jsxs("div",{className:"form-section po-form-section po-form-footer",children:[e.jsxs("div",{className:"order-summary",children:[e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Taxable Value"}),e.jsx("strong",{children:H(fs.taxableValue)})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Total Tax"}),e.jsx("strong",{children:H(fs.taxAmount)})]}),e.jsxs("div",{className:"summary-row grand-total",children:[e.jsx("span",{children:"Total Amount"}),e.jsx("strong",{children:H(fs.totalAmount)})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:Ds,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:ss?"Update Order":"Create Order"})]})]})]})]})}),_s&&Ue&&(g?e.jsx(oa,{open:!0,onClose:()=>Xe(!1),title:`Receive Inventory - ${Ue.po_number}`,className:"purchase-receive-sheet",actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>Xe(!1),children:"Cancel"}),e.jsx("button",{type:"submit",form:"receive-inventory-form",className:"submit-btn",children:"Confirm Receipt"})]}),children:e.jsxs("form",{id:"receive-inventory-form",onSubmit:yt,className:"mobile-receive-form",children:[e.jsx("div",{className:"form-section",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Invoice Number"}),e.jsx("input",{type:"text",value:as.invoice_number,onChange:s=>ks(a=>({...a,invoice_number:s.target.value})),placeholder:"Enter invoice number"})]})}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"Received Items"}),e.jsx("div",{className:"mobile-receive-list",children:as.items.map((s,a)=>e.jsxs("div",{className:"mobile-receive-item",children:[e.jsxs("div",{className:"mobile-receive-row",children:[e.jsx("strong",{children:s.product_name}),e.jsxs("span",{children:["Ordered: ",s.ordered_quantity]})]}),e.jsxs("div",{className:"mobile-receive-stepper",children:[e.jsx("button",{type:"button",className:"mobile-stepper-btn",onClick:()=>Xs(a,-1),"aria-label":"Decrease received quantity",children:"-"}),e.jsx("input",{type:"number",min:"0",max:s.ordered_quantity,value:s.received_quantity,onChange:n=>vs(a,"received_quantity",Math.max(0,Math.min(q(s.ordered_quantity),q(n.target.value))))}),e.jsx("button",{type:"button",className:"mobile-stepper-btn",onClick:()=>Xs(a,1),"aria-label":"Increase received quantity",children:"+"})]}),e.jsxs("div",{className:"mobile-receive-row",children:[e.jsx("label",{children:"Unit Cost"}),e.jsx("input",{type:"number",step:"0.01",value:s.unit_price,onChange:n=>vs(a,"unit_price",q(n.target.value))})]}),e.jsxs("div",{className:"mobile-receive-row value",children:[e.jsx("span",{children:"Value"}),e.jsx("strong",{children:H(q(s.received_quantity)*q(s.unit_price))})]})]},a))})]})]})}):e.jsx("div",{className:"modal-overlay",onClick:()=>Xe(!1),children:e.jsxs("div",{className:"modal-content large",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Receive Inventory - ",Ue.po_number]}),e.jsx("button",{className:"close-btn",onClick:()=>Xe(!1),children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{id:"receive-inventory-form",onSubmit:yt,children:[e.jsx("div",{className:"form-section",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Invoice Number"}),e.jsx("input",{type:"text",value:as.invoice_number,onChange:s=>ks(a=>({...a,invoice_number:s.target.value})),placeholder:"Enter invoice number"})]})}),e.jsxs("div",{className:"form-section",children:[e.jsx("h3",{children:"Received Items"}),e.jsx("div",{className:"items-list",children:as.items.map((s,a)=>e.jsxs("div",{className:"item-row",children:[e.jsxs("div",{className:"item-field product",children:[e.jsx("label",{children:"Product"}),e.jsx("span",{children:s.product_name})]}),e.jsxs("div",{className:"item-field qty",children:[e.jsx("label",{children:"Ordered"}),e.jsx("span",{children:s.ordered_quantity})]}),e.jsxs("div",{className:"item-field qty",children:[e.jsx("label",{children:"Received"}),e.jsx("input",{type:"number",min:"0",max:s.ordered_quantity,value:s.received_quantity,onChange:n=>vs(a,"received_quantity",q(n.target.value))})]}),e.jsxs("div",{className:"item-field price",children:[e.jsx("label",{children:"Unit Cost"}),e.jsx("input",{type:"number",step:"0.01",value:s.unit_price,onChange:n=>vs(a,"unit_price",q(n.target.value))})]}),e.jsxs("div",{className:"item-field total",children:[e.jsx("label",{children:"Value"}),e.jsx("span",{children:H(q(s.received_quantity)*q(s.unit_price))})]})]},a))})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>Xe(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:"Confirm Receipt"})]})]})]})})),Ks&&e.jsx("div",{className:"modal-overlay",onClick:()=>ae(!1),children:e.jsxs("div",{className:"modal-content large po-detail-modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h2",{children:["Purchase Order: ",(_e==null?void 0:_e.po_number)||"-"]}),e.jsx("button",{className:"close-btn",onClick:()=>ae(!1),children:e.jsx(ke,{size:24})})]}),ot||!_e?e.jsx("div",{className:"order-detail-body",children:e.jsx("div",{className:"loading",children:"Loading purchase order details..."})}):e.jsx("div",{className:"order-detail-body",children:e.jsx("div",{className:"po-invoice-preview",children:(()=>{const s=_t(_e);return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"po-invoice-header",children:[e.jsxs("div",{children:[e.jsx("h3",{children:"Purchase Order"}),e.jsxs("p",{children:["PO #",_e.po_number]})]}),e.jsxs("div",{className:"po-invoice-meta",children:[e.jsxs("div",{children:[e.jsx("span",{children:"Status"}),e.jsx("strong",{children:String(_e.status||"-").toUpperCase()})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Created"}),e.jsx("strong",{children:ln(_e.created_at||_e.order_date)})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Expected"}),e.jsx("strong",{children:Zt(_e.expected_delivery)})]}),e.jsxs("div",{children:[e.jsx("span",{children:"Bill No"}),e.jsx("strong",{children:_e.bill_number||_e.invoice_number||"-"})]})]})]}),e.jsxs("div",{className:"po-party-grid",children:[e.jsxs("div",{className:"po-party-card",children:[e.jsx("h4",{children:"Supplier"}),e.jsx("p",{children:s.name}),e.jsx("p",{children:s.phone}),e.jsx("p",{children:s.address})]}),e.jsxs("div",{className:"po-party-card",children:[e.jsx("h4",{children:"Notes"}),e.jsx("p",{children:_e.notes||"-"})]})]}),e.jsxs("table",{className:"po-invoice-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"#"}),e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"UOM"}),e.jsx("th",{children:"Rate"}),e.jsx("th",{children:"GST %"}),e.jsx("th",{children:"Taxable"}),e.jsx("th",{children:"Tax"}),e.jsx("th",{children:"Total"})]})}),e.jsx("tbody",{children:(_e.items||[]).map((a,n)=>{const m=Ct(a);return e.jsxs("tr",{children:[e.jsx("td",{children:n+1}),e.jsx("td",{children:a.product_name}),e.jsx("td",{children:m.quantity}),e.jsx("td",{children:a.uom||"-"}),e.jsx("td",{children:H(m.rate)}),e.jsxs("td",{children:[m.gstRate.toFixed(2),"%"]}),e.jsx("td",{children:H(m.taxableValue)}),e.jsx("td",{children:H(m.taxAmount)}),e.jsx("td",{children:H(m.lineTotal)})]},n)})})]}),e.jsxs("div",{className:"po-invoice-summary",children:[e.jsxs("div",{className:"po-summary-row",children:[e.jsx("span",{children:"Taxable Value"}),e.jsx("strong",{children:H(_e.taxable_value||0)})]}),e.jsxs("div",{className:"po-summary-row",children:[e.jsx("span",{children:"GST"}),e.jsx("strong",{children:H(_e.tax_amount||0)})]}),e.jsxs("div",{className:"po-summary-row grand",children:[e.jsx("span",{children:"Grand Total"}),e.jsx("strong",{children:H(_e.total_amount||xe(_e))})]})]})]})})()})}),e.jsxs("div",{className:"modal-actions",children:[e.jsxs("button",{type:"button",className:"submit-btn print-po-btn",onClick:()=>Vt(_e),disabled:!_e,children:[e.jsx(rn,{size:16})," Print"]}),e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>ae(!1),children:"Close"})]})]})}),je&&e.jsx("div",{className:"modal-overlay",onClick:()=>ne(!1),children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Add Distributor Payment / Credit"}),e.jsx("button",{className:"close-btn",onClick:()=>ne(!1),children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:St,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor *"}),e.jsxs("select",{value:ge.distributor_id,onChange:s=>$e(a=>({...a,distributor_id:s.target.value})),required:!0,children:[e.jsx("option",{value:"",children:"Select distributor"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Type *"}),e.jsxs("select",{value:ge.type,onChange:s=>$e(a=>({...a,type:s.target.value})),children:[e.jsx("option",{value:"payment",children:"Payment (Reduce due)"}),e.jsx("option",{value:"credit",children:"Credit (Increase due)"})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount *"}),e.jsx("input",{type:"number",step:"0.01",min:"0.01",value:ge.amount,onChange:s=>$e(a=>({...a,amount:s.target.value})),placeholder:"Enter amount",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Payment Mode"}),e.jsxs("select",{value:ge.payment_mode,onChange:s=>$e(a=>({...a,payment_mode:s.target.value})),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank",children:"Bank Transfer"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"credit",children:"Credit"})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Transaction Date"}),e.jsx("input",{type:"date",value:ge.transaction_date,onChange:s=>$e(a=>({...a,transaction_date:s.target.value}))})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Reference"}),e.jsx("input",{type:"text",value:ge.reference,onChange:s=>$e(a=>({...a,reference:s.target.value})),placeholder:"Invoice / PO / Bank ref"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description"}),e.jsx("textarea",{rows:"2",value:ge.description,onChange:s=>$e(a=>({...a,description:s.target.value})),placeholder:"Optional notes"})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>ne(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:"Save Entry"})]})]})]})}),Fe&&Qe&&e.jsx("div",{className:"modal-overlay",onClick:fe,children:e.jsxs("div",{className:"modal-content",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Correct PO Ledger Impact"}),e.jsx("button",{className:"close-btn",onClick:fe,children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:ha,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"PO Number"}),e.jsx("input",{type:"text",value:Qe.po_number||"-",readOnly:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor"}),e.jsx("input",{type:"text",value:Qe.distributor_name||t(Qe),readOnly:!0})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Expected PO Impact"}),e.jsx("input",{type:"text",value:H(Rs.expectedAmount),readOnly:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Current Ledger Impact"}),e.jsx("input",{type:"text",value:H(Rs.currentImpact),readOnly:!0})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Adjustment Needed (Delta)"}),e.jsx("input",{type:"text",value:H(Rs.delta),readOnly:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Linked Entries"}),e.jsx("input",{type:"text",value:String(Rs.linkedEntries),readOnly:!0})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Correction Type *"}),e.jsxs("select",{value:Le.type,onChange:s=>Ke(a=>({...a,type:s.target.value})),children:[e.jsx("option",{value:"payment",children:"Payment (Reduce due)"}),e.jsx("option",{value:"credit",children:"Credit (Increase due)"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount *"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:Le.amount,onChange:s=>Ke(a=>({...a,amount:s.target.value})),required:!0})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Mode"}),e.jsxs("select",{value:Le.payment_mode,onChange:s=>Ke(a=>({...a,payment_mode:s.target.value})),children:[e.jsx("option",{value:"cash",children:"Cash"}),e.jsx("option",{value:"bank",children:"Bank Transfer"}),e.jsx("option",{value:"upi",children:"UPI"}),e.jsx("option",{value:"cheque",children:"Cheque"}),e.jsx("option",{value:"credit",children:"Credit"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Date"}),e.jsx("input",{type:"date",value:Le.transaction_date,onChange:s=>Ke(a=>({...a,transaction_date:s.target.value}))})]})]}),e.jsx("div",{className:"form-row",children:e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Reference"}),e.jsx("input",{type:"text",value:Le.reference,onChange:s=>Ke(a=>({...a,reference:s.target.value})),placeholder:"PO number or correction reference"})]})}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Correction Reason *"}),e.jsx("textarea",{rows:"3",value:Le.reason,onChange:s=>Ke(a=>({...a,reason:s.target.value})),placeholder:"Explain why this correction is needed",required:!0})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:fe,disabled:ws,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:ws,children:ws?"Posting...":"Post Correction"})]})]})]})}),oe&&e.jsx("div",{className:"modal-overlay",onClick:()=>de(!1),children:e.jsxs("div",{className:"modal-content large",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:"Create Purchase Return / Exchange"}),e.jsx("button",{className:"close-btn",onClick:()=>de(!1),children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:qt,children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Distributor *"}),e.jsxs("select",{value:De.distributor_id,onChange:s=>ue(a=>({...a,distributor_id:s.target.value})),required:!0,children:[e.jsx("option",{value:"",children:"Select distributor"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Reference PO"}),e.jsx("input",{type:"text",value:De.reference_po,onChange:s=>ue(a=>({...a,reference_po:s.target.value})),placeholder:"Original PO number"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Return Type"}),e.jsxs("select",{value:De.return_type,onChange:s=>ue(a=>({...a,return_type:s.target.value})),children:[e.jsx("option",{value:"return",children:"Return"}),e.jsx("option",{value:"exchange",children:"Exchange"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Reason"}),e.jsx("input",{type:"text",value:De.reason,onChange:s=>ue(a=>({...a,reason:s.target.value})),placeholder:"Reason for return/exchange"})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h3",{children:"Return Items"}),e.jsxs("button",{type:"button",className:"add-item-btn",onClick:Mt,children:[e.jsx(Me,{size:16})," Add Item"]})]}),e.jsx("div",{className:"items-list",children:De.items.map((s,a)=>e.jsxs("div",{className:"item-row",children:[e.jsxs("div",{className:"item-field product",children:[e.jsx("label",{children:"Product"}),e.jsxs("select",{value:s.product_id,onChange:n=>Ys(a,"product_id",n.target.value),children:[e.jsx("option",{value:"",children:"Select product"}),C.map(n=>e.jsxs("option",{value:n.id,children:[n.name," (",n.sku,")"]},n.id))]})]}),e.jsxs("div",{className:"item-field qty",children:[e.jsx("label",{children:"Qty"}),e.jsx("input",{type:"number",min:"1",value:s.quantity,onChange:n=>Ys(a,"quantity",parseFloat(n.target.value))})]}),e.jsxs("div",{className:"item-field uom",children:[e.jsx("label",{children:"UOM"}),e.jsx("input",{type:"text",value:s.uom,readOnly:!0})]}),e.jsxs("div",{className:"item-field price",children:[e.jsx("label",{children:"Unit Price"}),e.jsx("input",{type:"number",step:"0.01",value:s.unit_price,onChange:n=>Ys(a,"unit_price",parseFloat(n.target.value))})]}),e.jsxs("div",{className:"item-field total",children:[e.jsx("label",{children:"Total"}),e.jsx("span",{children:H(s.quantity*s.unit_price)})]}),e.jsx("button",{type:"button",className:"remove-item-btn",onClick:()=>Ut(a),children:e.jsx(ke,{size:16})})]},a))})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:()=>de(!1),children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:"Create Return"})]})]})]})})]})}function Rn({user:l}){const[g,k]=r.useState([]),[A,d]=r.useState([]),[R,h]=r.useState(!0),[$,D]=r.useState({product_id:"",transaction_type:"",start_date:"",end_date:""});r.useEffect(()=>{G()},[]),r.useEffect(()=>{W()},[$]);const G=async()=>{try{const w=await ye.getAll();d(w||[])}catch(w){console.error("Error fetching products:",w)}},W=async()=>{try{h(!0);const w=await Ga.getAll($);k(w||[])}catch(w){console.error("Error fetching stock ledger:",w)}finally{h(!1)}},S=w=>{const{name:L,value:ee}=w.target;D(re=>({...re,[L]:ee}))},y=()=>{D({product_id:"",transaction_type:"",start_date:"",end_date:""})},E=w=>{switch(w){case"PURCHASE":return e.jsx(wa,{size:16,className:"icon purchase"});case"SALE":return e.jsx(ea,{size:16,className:"icon sale"});case"RETURN":return e.jsx(Et,{size:16,className:"icon return"});case"PURCHASE_RETURN":return e.jsx(ea,{size:16,className:"icon purchase-return"});case"ADJUSTMENT":return e.jsx(Na,{size:16,className:"icon adjustment"});case"EXCHANGE_IN":return e.jsx(wa,{size:16,className:"icon exchange-in"});case"EXCHANGE_OUT":return e.jsx(ea,{size:16,className:"icon exchange-out"});default:return e.jsx(Na,{size:16,className:"icon default"})}},se=w=>{const ee={PURCHASE:{label:"Purchase",class:"purchase"},SALE:{label:"Sale",class:"sale"},RETURN:{label:"Return",class:"return"},PURCHASE_RETURN:{label:"Purchase Return",class:"purchase-return"},ADJUSTMENT:{label:"Adjustment",class:"adjustment"},EXCHANGE_IN:{label:"Exchange In",class:"exchange-in"},EXCHANGE_OUT:{label:"Exchange Out",class:"exchange-out"}}[w]||{label:w,class:""};return e.jsx("span",{className:`type-badge ${ee.class}`,children:ee.label})},K=[{value:"",label:"All Types"},{value:"PURCHASE",label:"Purchase"},{value:"SALE",label:"Sale"},{value:"RETURN",label:"Return"},{value:"PURCHASE_RETURN",label:"Purchase Return"},{value:"ADJUSTMENT",label:"Adjustment"},{value:"EXCHANGE_IN",label:"Exchange In"},{value:"EXCHANGE_OUT",label:"Exchange Out"}];return e.jsxs("div",{className:"stock-ledger-history",children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Stock Ledger History"}),e.jsxs("button",{className:"admin-btn",onClick:W,children:[e.jsx(Et,{size:18})," Refresh"]})]}),e.jsx("div",{className:"filters-section",children:e.jsxs("div",{className:"filters-row",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Product:"}),e.jsxs("select",{name:"product_id",value:$.product_id,onChange:S,children:[e.jsx("option",{value:"",children:"All Products"}),A.map(w=>e.jsxs("option",{value:w.id,children:[w.name," (",w.sku,")"]},w.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Transaction Type:"}),e.jsx("select",{name:"transaction_type",value:$.transaction_type,onChange:S,children:K.map(w=>e.jsx("option",{value:w.value,children:w.label},w.value))})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"From:"}),e.jsx("input",{type:"date",name:"start_date",value:$.start_date,onChange:S})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"To:"}),e.jsx("input",{type:"date",name:"end_date",value:$.end_date,onChange:S})]}),e.jsx("button",{className:"reset-btn",onClick:y,children:"Reset Filters"})]})}),e.jsxs("div",{className:"summary-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("span",{className:"stat-value",children:g.length}),e.jsx("span",{className:"stat-label",children:"Total Transactions"})]}),e.jsxs("div",{className:"stat-card purchase",children:[e.jsx("span",{className:"stat-value",children:g.filter(w=>w.transaction_type==="PURCHASE").length}),e.jsx("span",{className:"stat-label",children:"Purchases"})]}),e.jsxs("div",{className:"stat-card sale",children:[e.jsx("span",{className:"stat-value",children:g.filter(w=>w.transaction_type==="SALE").length}),e.jsx("span",{className:"stat-label",children:"Sales"})]}),e.jsxs("div",{className:"stat-card return",children:[e.jsx("span",{className:"stat-value",children:g.filter(w=>w.transaction_type==="RETURN").length}),e.jsx("span",{className:"stat-label",children:"Returns"})]})]}),e.jsx("div",{className:"ledger-table-container",children:R?e.jsx("div",{className:"loading",children:"Loading stock ledger..."}):g.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("p",{children:"No stock transactions found."}),e.jsx("p",{children:"Transactions will appear here when inventory changes occur."})]}):e.jsxs("table",{className:"ledger-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date & Time"}),e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{children:"Previous"}),e.jsx("th",{children:"New Balance"}),e.jsx("th",{children:"Reference"}),e.jsx("th",{children:"By"}),e.jsx("th",{children:"Notes"})]})}),e.jsx("tbody",{children:g.map(w=>e.jsxs("tr",{children:[e.jsxs("td",{className:"date-cell",children:[new Date(w.created_at).toLocaleDateString(),e.jsx("span",{className:"time",children:new Date(w.created_at).toLocaleTimeString()})]}),e.jsxs("td",{className:"product-cell",children:[e.jsx("span",{className:"product-name",children:w.product_name}),e.jsx("span",{className:"product-sku",children:w.sku})]}),e.jsxs("td",{children:[E(w.transaction_type),se(w.transaction_type)]}),e.jsx("td",{className:"qty-cell",children:e.jsxs("span",{className:w.quantity_change>=0?"positive":"negative",children:[w.quantity_change>=0?"+":"",w.quantity_change]})}),e.jsx("td",{children:w.previous_balance}),e.jsx("td",{children:e.jsx("strong",{children:w.new_balance})}),e.jsx("td",{className:"ref-cell",children:w.reference_id&&e.jsxs("span",{className:"reference",children:[w.reference_type,": ",w.reference_id]})}),e.jsx("td",{children:w.user_name||"-"}),e.jsx("td",{className:"notes-cell",children:w.notes||"-"})]},w.id))})]})})]})}function On({user:l}){const[g,k]=r.useState([]),[A,d]=r.useState({}),[R,h]=r.useState(!0),[$,D]=r.useState("");r.useEffect(()=>{G()},[]);const G=async()=>{try{h(!0);const S=await Ts.getAgingReport();k(S.report||[]),d(S.summary||{})}catch{D("Failed to load credit aging report")}finally{h(!1)}},W=S=>{const y=S.credit_limit||0,E=S.current_balance||0,se=y>0?E/y*100:0;return E>y?{status:"over_limit",label:"Over Limit",icon:bn,class:"over-limit"}:se>=80?{status:"high",label:"High Risk",icon:nn,class:"high-risk"}:se>=50?{status:"medium",label:"Medium",icon:Ua,class:"medium"}:{status:"low",label:"Good",icon:dn,class:"good"}};return R?e.jsx("div",{className:"credit-aging-report",children:e.jsx("div",{className:"loading",children:"Loading credit aging report..."})}):e.jsxs("div",{className:"credit-aging-report",children:[e.jsxs("div",{className:"page-header",children:[e.jsx("h1",{children:"Credit Aging Report"}),e.jsxs("button",{className:"refresh-btn",onClick:G,children:[e.jsx(Et,{size:18})," Refresh"]})]}),$&&e.jsx("div",{className:"error-message",children:$}),e.jsxs("div",{className:"summary-cards",children:[e.jsxs("div",{className:"summary-card total",children:[e.jsx("span",{className:"card-value",children:H(A.total_outstanding||0)}),e.jsx("span",{className:"card-label",children:"Total Outstanding"})]}),e.jsxs("div",{className:"summary-card overdue",children:[e.jsx("span",{className:"card-value",children:A.customers_overdue||0}),e.jsx("span",{className:"card-label",children:"Customers Overdue"})]}),e.jsxs("div",{className:"summary-card aging-0-30",children:[e.jsx("span",{className:"card-value",children:H(A.aging_0_30||0)}),e.jsx("span",{className:"card-label",children:"0-30 Days"})]}),e.jsxs("div",{className:"summary-card aging-31-60",children:[e.jsx("span",{className:"card-value",children:H(A.aging_31_60||0)}),e.jsx("span",{className:"card-label",children:"31-60 Days"})]}),e.jsxs("div",{className:"summary-card aging-61-90",children:[e.jsx("span",{className:"card-value",children:H(A.aging_61_90||0)}),e.jsx("span",{className:"card-label",children:"61-90 Days"})]}),e.jsxs("div",{className:"summary-card aging-over-90",children:[e.jsx("span",{className:"card-value",children:H(A.aging_over_90||0)}),e.jsx("span",{className:"card-label",children:"Over 90 Days"})]})]}),e.jsxs("div",{className:"aging-chart",children:[e.jsx("h3",{children:"Outstanding by Aging Period"}),e.jsxs("div",{className:"chart-bars",children:[e.jsxs("div",{className:"chart-bar",style:{width:"40%"},children:[e.jsx("div",{className:"bar-fill days-0-30",style:{width:"100%"}}),e.jsx("span",{className:"bar-label",children:"0-30 Days"}),e.jsx("span",{className:"bar-value",children:H(A.aging_0_30||0)})]}),e.jsxs("div",{className:"chart-bar",style:{width:"30%"},children:[e.jsx("div",{className:"bar-fill days-31-60",style:{width:"100%"}}),e.jsx("span",{className:"bar-label",children:"31-60 Days"}),e.jsx("span",{className:"bar-value",children:H(A.aging_31_60||0)})]}),e.jsxs("div",{className:"chart-bar",style:{width:"20%"},children:[e.jsx("div",{className:"bar-fill days-61-90",style:{width:"100%"}}),e.jsx("span",{className:"bar-label",children:"61-90 Days"}),e.jsx("span",{className:"bar-value",children:H(A.aging_61_90||0)})]}),e.jsxs("div",{className:"chart-bar",style:{width:"10%"},children:[e.jsx("div",{className:"bar-fill days-over-90",style:{width:"100%"}}),e.jsx("span",{className:"bar-label",children:"90+ Days"}),e.jsx("span",{className:"bar-value",children:H(A.aging_over_90||0)})]})]})]}),e.jsxs("div",{className:"report-table-container",children:[e.jsx("h3",{children:"Customer Credit Details"}),g.length===0?e.jsx("div",{className:"empty-state",children:e.jsx("p",{children:"No customers with outstanding credit balance."})}):e.jsxs("table",{className:"report-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Contact"}),e.jsx("th",{children:"Credit Limit"}),e.jsx("th",{children:"Current Balance"}),e.jsx("th",{children:"Utilization"}),e.jsx("th",{children:"0-30 Days"}),e.jsx("th",{children:"31-60 Days"}),e.jsx("th",{children:"61-90 Days"}),e.jsx("th",{children:"90+ Days"}),e.jsx("th",{children:"Status"})]})}),e.jsx("tbody",{children:g.map(S=>{const y=W(S),E=S.credit_limit||0,se=S.current_balance||0,K=E>0?Math.min(se/E*100,100):0;return e.jsxs("tr",{children:[e.jsx("td",{children:e.jsx("span",{className:"customer-name",children:S.customer_name})}),e.jsx("td",{children:e.jsxs("div",{className:"contact-info",children:[e.jsx("span",{children:S.phone||"-"}),e.jsx("span",{className:"email",children:S.email||"-"})]})}),e.jsx("td",{children:H(E)}),e.jsx("td",{className:"balance",children:e.jsx("strong",{children:H(se)})}),e.jsx("td",{children:e.jsxs("div",{className:"utilization-bar",children:[e.jsx("div",{className:`bar ${y.status}`,style:{width:`${K}%`}}),e.jsxs("span",{children:[K.toFixed(1),"%"]})]})}),e.jsx("td",{className:"aging-amount",children:H(S.days_0_30)}),e.jsx("td",{className:`aging-amount ${S.days_31_60>0?"overdue":""}`,children:H(S.days_31_60)}),e.jsx("td",{className:`aging-amount ${S.days_61_90>0?"overdue":""}`,children:H(S.days_61_90)}),e.jsx("td",{className:`aging-amount ${S.days_over_90>0?"critical":""}`,children:H(S.days_over_90)}),e.jsx("td",{children:e.jsxs("span",{className:`status-badge ${y.class}`,children:[e.jsx(y.icon,{size:14}),y.label]})})]},S.customer_id)})})]})]})]})}function Ta({user:l,onClose:g,onSave:k,isCreate:A=!1}){const[d,R]=r.useState({name:"",email:"",phone:"",address:"",role:"customer"}),[h,$]=r.useState(!1),[D,G]=r.useState(""),[W,S]=r.useState(""),[y,E]=r.useState({}),se=ca();r.useEffect(()=>{l&&!A&&R({name:l.name||"",email:l.email||"",phone:l.phone||"",address:l.address||"",role:l.role||"customer"})},[l,A]);const K=A||!!(l!=null&&l.email_verified)&&!!(l!=null&&l.phone_verified),w=!A&&(l==null?void 0:l.role)==="admin",L=w?"Admin users cannot be modified here.":"User type can be changed only when both email and phone are verified.",ee=()=>{const _={};return A?(d.name.trim()?d.name.trim().length<2&&(_.name="Name must be at least 2 characters"):_.name="Name is required",d.phone&&!ua(d.phone)&&(_.phone=ma)):d.role!=="customer"&&d.role!=="admin"&&(_.role="Choose a valid user type"),E(_),Object.keys(_).length===0},re=_=>{const{name:J,value:B}=_.target;R(P=>({...P,[J]:B})),y[J]&&E(P=>({...P,[J]:""}))},xe=async _=>{if(_.preventDefault(),!!ee()){if(!A&&!K){G(L);return}$(!0),G(""),S("");try{if(A){const J=d.phone?Dt(d.phone):"";await We.create({name:d.name.trim(),email:d.email.trim()||null,phone:J||null,address:d.address.trim()||null,role:"customer"}),S("Customer created successfully")}else await We.update(l.id,{role:d.role==="admin"?"admin":"customer"}),S("User type updated successfully");setTimeout(()=>{k(),g()},700)}catch(J){G(J.message||`Failed to ${A?"create":"update"} user`)}finally{$(!1)}}},u=e.jsxs(e.Fragment,{children:[D&&e.jsx("div",{className:"error-message",children:D}),W&&e.jsx("div",{className:"success-message",children:W}),e.jsxs("form",{onSubmit:xe,className:"user-edit-form",children:[A?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"name",children:"Name"}),e.jsx("input",{type:"text",id:"name",name:"name",value:d.name,onChange:re,placeholder:"Enter customer name",autoComplete:"name",className:y.name?"error":""}),y.name&&e.jsx("span",{className:"field-error",children:y.name})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"email",children:"Email"}),e.jsx("input",{type:"email",id:"email",name:"email",value:d.email,onChange:re,placeholder:"Enter email (optional)",autoComplete:"email"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"phone",children:"Phone"}),e.jsx("input",{type:"tel",id:"phone",name:"phone",value:d.phone,onChange:re,placeholder:"Enter Indian phone number",autoComplete:"tel",className:y.phone?"error":""}),y.phone&&e.jsx("span",{className:"field-error",children:y.phone})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"address",children:"Address"}),e.jsx("input",{type:"text",id:"address",name:"address",value:d.address,onChange:re,placeholder:"Enter address (optional)",autoComplete:"street-address"})]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"user-static-summary",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",d.name||"-"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",d.email||"-"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",d.phone||"-"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email status:"})," ",l!=null&&l.email_verified?"Verified":"Unverified"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone status:"})," ",l!=null&&l.phone_verified?"Verified":"Unverified"]})]}),!K&&e.jsx("span",{className:"field-error",children:L}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{htmlFor:"role",children:"User Type"}),e.jsxs("select",{id:"role",name:"role",value:d.role,onChange:re,disabled:!K||w,className:y.role?"error":"",children:[e.jsx("option",{value:"customer",children:"Customer"}),e.jsx("option",{value:"admin",children:"Admin"})]}),y.role&&e.jsx("span",{className:"field-error",children:y.role}),K&&!w&&e.jsx("span",{className:"info-text",children:"Only user type is editable in admin user edit mode."})]})]}),e.jsxs("div",{className:"form-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:g,disabled:h,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",disabled:h||!A&&(!K||w),children:h?"Saving...":A?"Add Customer":"Update User Type"})]})]})]});return se?e.jsx(oa,{open:!0,title:A?"Add New Customer":"Update User Type",onClose:g,className:"user-edit-sheet",children:u}):e.jsx("div",{className:"user-edit-overlay",children:e.jsxs("div",{className:"user-edit-modal fade-in-up",children:[e.jsxs("div",{className:"user-edit-header",children:[e.jsx("h2",{children:A?"Add New Customer":"Update User Type"}),e.jsx("button",{className:"close-btn",onClick:g,"aria-label":"Close",children:e.jsx(ke,{size:24})})]}),u]})})}const Pt=()=>({id:Date.now()+Math.random(),name:"",price:0,qty:1,unit:"pcs",disc:0,discType:"fixed",amount:0}),In=()=>{const[l,g]=r.useState({name:"",email:"",phone:"",address:""}),[k,A]=r.useState([Pt()]),[d,R]=r.useState(!1),[h,$]=r.useState(null),[D,G]=r.useState(!1),[W,S]=r.useState(0),[y,E]=r.useState(""),[se,K]=r.useState(""),[w,L]=r.useState(""),[ee,re]=r.useState([]),[xe,u]=r.useState([]),_=r.useRef(null);r.useEffect(()=>{(async()=>{R(!0),$(null);try{const[C,O]=await Promise.all([Gt.getAll(),ye.getAll()]);re(C||[]),u(O||[])}catch(C){console.error("Error fetching initial data:",C),$("Failed to load data. Please refresh the page.")}finally{R(!1)}})()},[]),r.useEffect(()=>()=>{_.current&&clearTimeout(_.current)},[]);const J=r.useCallback((p,C,O,ie)=>{const N=Number(p)||0,Z=Math.max(1,Number(C)||1),Q=Number(O)||0,U=N*Z;let Ne=0;if(ie==="percentage"){const es=Math.min(100,Math.max(0,Q));Ne=U*es/100}else Ne=Math.min(U,Math.max(0,Q));return{amount:Math.max(0,U-Ne)}},[]),B=r.useCallback((p,C,O)=>{A(ie=>{const N=[...ie];if(C==="name"){const Z=xe.find(Q=>Q.name&&Q.name.toLowerCase()===O.trim().toLowerCase());if(Z){const Q=Number(Z.price)||0,U=Number(Z.defaultDiscount)||0,Ne=Z.discountType||"fixed";N[p]={...N[p],name:Z.name,productId:Z.id,price:Q,qty:1,unit:Z.uom||Z.unit||"pcs",disc:U,discType:Ne,amount:J(Q,1,U,Ne).amount}}else N[p]={...N[p],name:O},N[p].amount=J(N[p].price,N[p].qty,N[p].disc,N[p].discType).amount}else if(C==="price")N[p].price=O,N[p].amount=J(O,N[p].qty,N[p].disc,N[p].discType).amount;else if(C==="qty"){const Z=Math.max(1,Number(O)||1);N[p].qty=Z,N[p].amount=J(N[p].price,Z,N[p].disc,N[p].discType).amount}else if(C==="disc"){const Z=Number(O)||0;N[p].disc=Z,N[p].amount=J(N[p].price,N[p].qty,Z,N[p].discType).amount}else C==="discType"?(N[p].discType=O,N[p].amount=J(N[p].price,N[p].qty,N[p].disc,O).amount):N[p][C]=O;return N})},[J,xe]),P=()=>A(p=>[...p,Pt()]),te=p=>{A(C=>C.length>1?C.filter((O,ie)=>ie!==p):C)},ce=k.reduce((p,C)=>p+C.amount,0),me=Math.max(0,Math.min(Number(W||0),Number(ce||0))),i=Math.max(0,Number(ce)-me),b=k.reduce((p,C)=>{const O=Number(C.price)||0,ie=Math.max(1,Number(C.qty)||1),N=Number(C.disc)||0;if(C.discType==="percentage"){const Z=Math.min(100,Math.max(0,N));return p+O*ie*Z/100}return p+Math.min(O*ie,Math.max(0,N))},0),x=r.useCallback(async()=>{R(!0),$(null);try{const[p,C]=await Promise.all([Gt.getAll(),ye.getAll()]);re(p||[]),u(C||[])}catch(p){console.error("Error refreshing data:",p),$("Failed to refresh data. Please try again.")}finally{R(!1)}},[]),z=r.useCallback(p=>{const{value:C}=p.target;_.current&&clearTimeout(_.current);const O=ee.find(ie=>ie.name&&ie.name.toLowerCase()===C.toLowerCase());if(O){g({...O});return}g(ie=>({...ie,name:C})),C.length>=2&&(_.current=setTimeout(async()=>{try{const ie=await Gt.search(C);ie&&ie.length>0&&g({...ie[0]})}catch(ie){console.error("Error searching customers:",ie)}},300))},[ee]),X=async()=>{var Z,Q;if(!k.some(U=>U.name&&U.amount>0)){alert("Please add at least one item to the bill.");return}if(!ua(l.phone)){alert(ma);return}const C=me,O=U=>Dt(U),ie=(U,Ne)=>String(U||"").trim().toLowerCase()===String(Ne||"").trim().toLowerCase(),N={customer_id:l.id||null,customer_name:l.name,customer_email:l.email||null,customer_phone:Dt(l.phone)||null,customer_address:l.address||null,discount_amount:Number(b.toFixed(2)),total_amount:Number(ce.toFixed(2)),paid_amount:Number(C.toFixed(2)),credit_amount:Number(i.toFixed(2)),payment_method:"cash",payment_status:C<Number(ce||0)?"pending":"paid",bill_type:"sales",items:k.filter(U=>U.name&&Number(U.amount)>0).map(U=>({product_id:U.productId||null,product_name:U.name,mrp:Number(U.price)||0,qty:Number(U.qty)||0,unit:U.unit||"pcs",discount:U.discType==="percentage"?(Number(U.price)||0)*(Number(U.qty)||0)*(Math.min(100,Math.max(0,Number(U.disc)||0))/100):Number(U.disc)||0,amount:Number(U.amount)||0}))};try{G(!0);let U=N.customer_id||null,Ne=null;const es=O(N.customer_phone);if(es&&(Ne=ee.find(oe=>O(oe.phone)===es)||null,Ne)){const oe=ie(Ne.name,N.customer_name),de=ie(Ne.email,N.customer_email);if(oe&&de)U=Ne.id;else if(window.confirm(`A customer with this phone number already exists but name/email differ.
OK to update the existing customer with entered details, Cancel to use existing customer as-is.`)){const ne=await We.update(Ne.id,{name:N.customer_name,email:N.customer_email,phone:N.customer_phone,address:N.customer_address,role:"customer"}),Fe=(ne==null?void 0:ne.user)||ne||null;Fe&&re(hs=>hs.map(Ue=>Ue.id===Ne.id?Fe:Ue)),U=Ne.id}else U=Ne.id}if(!U){const oe=String(N.customer_email||"").trim().toLowerCase(),de=oe?ee.find(je=>String(je.email||"").trim().toLowerCase()===oe):null;if(de)if(window.confirm(`A customer with this email already exists but phone number differs.
OK to update the existing customer phone to the entered phone, Cancel to create a new customer.`)){const ne=await We.update(de.id,{name:N.customer_name||de.name,email:N.customer_email||de.email,phone:N.customer_phone||de.phone,address:N.customer_address||de.address,role:"customer"}),Fe=(ne==null?void 0:ne.user)||ne||null;Fe&&re(hs=>hs.map(Ue=>Ue.id===de.id?Fe:Ue)),U=de.id}else{const ne=await We.create({name:N.customer_name,email:N.customer_email,phone:N.customer_phone,address:N.customer_address,role:"customer"});U=((Z=ne==null?void 0:ne.user)==null?void 0:Z.id)||null,ne!=null&&ne.user&&re(Fe=>[...Fe,ne.user])}else{const je=await We.create({name:N.customer_name,email:N.customer_email,phone:N.customer_phone,address:N.customer_address,role:"customer"});U=((Q=je==null?void 0:je.user)==null?void 0:Q.id)||null,je!=null&&je.user&&re(ne=>[...ne,je.user])}}const Ge=[],Ls=N.items.map(oe=>{let de=null;if(oe.product_id&&(de=xe.find(je=>je.id===oe.product_id)||null),!de){const je=String(oe.product_name||"").trim().toLowerCase();de=xe.find(ne=>String(ne.name||"").trim().toLowerCase()===je)||null}return de?(oe.product_id=de.id,(Number(de.price||0)!==Number(oe.mrp||0)||String(de.uom||"").toLowerCase()!==String(oe.unit||"").toLowerCase())&&Ge.push(ye.update(de.id,{name:de.name,price:Number(oe.mrp||0),mrp:Number(oe.mrp||0),uom:oe.unit||"pcs",category:de.category||"Groceries"})),oe):(Ge.push(ye.create({name:oe.product_name,price:Number(oe.mrp||0),mrp:Number(oe.mrp)||0,uom:oe.unit||"pcs",category:"Groceries",stock:0}).then(je=>(je!=null&&je.id&&(oe.product_id=je.id,u(ne=>[...ne,je])),oe))),oe)});Ge.length&&await Promise.all(Ge),N.customer_id=U,N.items=Ls;const Ae=await La.createBill(N);N.customer_id&&i>0&&await Ts.addTransaction(N.customer_id,{type:"given",amount:Number(i.toFixed(2)),description:`Bill credit | Paid: ${H(Number(C))} | Credit: ${H(Number(i))}`,reference:(Ae==null?void 0:Ae.bill_number)||null});let _s=Number(N.credit_amount||0);if(N.customer_id)try{const oe=await Ts.getBalance(N.customer_id);_s=Number((oe==null?void 0:oe.balance)||0)}catch{}const Xe=qa({companyTitle:Oa||"BARMAN STORE",billNumber:Ae==null?void 0:Ae.bill_number,createdAt:new Date().toISOString(),customerName:N.customer_name,customerPhone:N.customer_phone,customerEmail:N.customer_email,customerAddress:N.customer_address,items:N.items,totalAmount:N.total_amount,paidAmount:N.paid_amount,creditAmount:N.credit_amount,currentTotalCredit:_s,paymentStatus:N.payment_status,onlineStoreUrl:Ra,thankYouLine:"Thank you for shopping with us."});E(Xe),K((Ae==null?void 0:Ae.bill_number)||""),L(N.customer_phone||""),alert("Bill created successfully."),g({name:"",email:"",phone:"",address:""}),A([Pt()]),S(0)}catch(U){console.error("Error creating bill:",U),alert(`Failed to create bill: ${U.message||"Unknown error"}`)}finally{G(!1)}},v=async()=>{if(y)try{await navigator.clipboard.writeText(y),alert("Bill text copied.")}catch{alert("Failed to copy bill text.")}},F=async()=>{if(!y)return;const p=await Ba({phone:w||(l==null?void 0:l.phone),text:y});if(p.status==="missing_phone"){alert("Customer phone is missing or invalid. Please update phone and try again.");return}if(p.status==="fallback_copy"){alert("Message was long, copied to clipboard. Paste it in WhatsApp.");return}p.status==="fallback_no_copy"&&alert("Message was long. Opened WhatsApp chat, please paste message manually.")};return e.jsxs("div",{className:"billing-content",children:[e.jsx("h1",{children:"Billing Invoice"}),h&&e.jsxs("div",{className:"error-message",role:"alert",children:[h,e.jsx("button",{onClick:x,className:"retry-btn",children:"Retry"})]}),d&&e.jsx("div",{className:"loading-indicator",children:"Loading..."}),!d&&!h&&e.jsx("button",{onClick:x,className:"refresh-btn","aria-label":"Refresh customer and product data",children:"Refresh Data"}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",htmlFor:"customerName",children:"Customer Name *"}),e.jsx("input",{id:"customerName",list:"customer-list",className:"form-input",value:l.name,onChange:z,placeholder:"Type or select name...","aria-label":"Customer name","aria-autocomplete":"list",autoComplete:"name",required:!0}),e.jsx("datalist",{id:"customer-list",children:ee.map(p=>e.jsx("option",{value:p.name},p.id))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"customerEmail",children:"Email"}),e.jsx("input",{id:"customerEmail",type:"email",className:"form-input",value:l.email,onChange:p=>g(C=>({...C,email:p.target.value})),"aria-label":"Customer email",placeholder:"email@example.com",autoComplete:"email"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"customerPhone",children:"Phone *"}),e.jsx("input",{id:"customerPhone",type:"tel",className:"form-input",value:l.phone,onChange:p=>g(C=>({...C,phone:p.target.value})),"aria-label":"Customer phone",placeholder:"10-digit phone number",maxLength:"10",autoComplete:"tel"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"form-label",htmlFor:"customerAddress",children:"Address"}),e.jsx("input",{id:"customerAddress",type:"text",className:"form-input",value:l.address,onChange:p=>g(C=>({...C,address:p.target.value})),"aria-label":"Customer address",placeholder:"Full address",autoComplete:"street-address"})]})]}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"billing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product Name"}),e.jsx("th",{className:"w-24",children:"Price"}),e.jsx("th",{className:"w-20",children:"Qty"}),e.jsx("th",{className:"w-24",children:"Unit"}),e.jsx("th",{className:"w-28",children:"Disc"}),e.jsx("th",{className:"w-32",children:"Amount"}),e.jsx("th",{className:"w-12"})]})}),e.jsx("tbody",{children:k.map((p,C)=>e.jsxs("tr",{children:[e.jsxs("td",{"data-label":"Product Name",children:[e.jsx("input",{list:"product-list",value:p.name,onChange:O=>B(C,"name",O.target.value),"aria-label":"Product name",placeholder:"Type or select product...",autoComplete:"off"}),e.jsx("datalist",{id:"product-list",children:xe.map(O=>e.jsx("option",{value:O.name},O.id))})]}),e.jsx("td",{"data-label":"Price",children:e.jsx("input",{type:"number",value:p.price,onChange:O=>B(C,"price",O.target.value),"aria-label":"Price per unit",min:"0",step:"0.01"})}),e.jsx("td",{"data-label":"Quantity",children:e.jsx("input",{type:"number",value:p.qty,onChange:O=>B(C,"qty",O.target.value),"aria-label":"Quantity",min:"1"})}),e.jsx("td",{"data-label":"Unit",children:e.jsx("input",{type:"text",value:p.unit,onChange:O=>B(C,"unit",O.target.value),"aria-label":"Unit of measurement",placeholder:"pcs, kg, etc."})}),e.jsx("td",{"data-label":"Discount",children:e.jsxs("div",{className:"discount-field",children:[e.jsx("input",{type:"number",value:p.disc,onChange:O=>B(C,"disc",O.target.value),"aria-label":"Discount value",min:"0",step:p.discType==="percentage"?"1":"0.01",className:"disc-input"}),e.jsxs("select",{value:p.discType,onChange:O=>B(C,"discType",O.target.value),"aria-label":"Discount type",className:"disc-type-select",children:[e.jsx("option",{value:"fixed",children:"Rs"}),e.jsx("option",{value:"percentage",children:"%"})]})]})}),e.jsx("td",{className:"amount-cell","data-label":"Amount",children:H(p.amount)}),e.jsx("td",{className:"text-center","data-label":"Action",children:e.jsx("button",{onClick:()=>te(C),disabled:k.length===1,className:"delete-btn","aria-label":"Remove item",children:e.jsx(ls,{size:18})})})]},p.id))})]})}),e.jsxs("div",{className:"actions",children:[e.jsxs("button",{onClick:P,className:"add-btn","aria-label":"Add new product",children:[e.jsx(Me,{size:18})," Add Product"]}),e.jsxs("div",{className:"total-section",children:[e.jsx("p",{children:"Total Payable:"}),e.jsx("p",{children:H(ce)})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",htmlFor:"paidAmount",children:"Paid Amount"}),e.jsx("input",{id:"paidAmount",type:"number",min:"0",step:"0.01",className:"form-input",value:W,onChange:p=>S(p.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",children:"Credit "}),e.jsx("div",{className:"form-input","aria-live":"polite",children:H(i)})]})]}),e.jsxs("div",{className:"billing-form-controls",children:[e.jsx("button",{className:"reset",onClick:()=>{g({name:"",email:"",phone:"",address:""}),A([Pt()]),S(0)},children:"Clear"}),e.jsx("button",{className:"submit",onClick:X,disabled:D,children:"Create Bill"})]}),y&&e.jsxs("div",{className:"share-box",children:[e.jsx("div",{className:"share-header",children:e.jsxs("strong",{children:["Share Bill ",se?`#${se}`:""]})}),e.jsx("textarea",{className:"share-text",readOnly:!0,value:y}),e.jsxs("div",{className:"share-actions",children:[e.jsx("button",{className:"share-btn",onClick:v,children:"Copy"}),e.jsx("button",{type:"button",className:"share-btn whatsapp",onClick:F,children:"WhatsApp"})]})]})]})},Je={name:"BARMAN STORE",gstNumber:"GST00000001",address:"COTTONROAD",phone:"0123456789",email:"barmanstore@store.com",logoPath:"/logo.png"},zn=()=>{const[l,g]=r.useState([]),[k,A]=r.useState(!0),[d,R]=r.useState(null),[h,$]=r.useState(""),[D,G]=r.useState(null);r.useEffect(()=>{W()},[]);const W=async()=>{try{A(!0),R(null);const u=await La.getAll();g(u||[])}catch(u){console.error("Error fetching bills:",u),R("Failed to load bills. Please try again.")}finally{A(!1)}},S=async u=>{if(window.confirm("Are you sure you want to delete this bill?"))try{if(!(await fetch(`/api/bills/${u}`,{method:"DELETE"})).ok)throw new Error("Failed to delete bill");g(l.filter(J=>J.id!==u)),G(null),alert("Bill deleted successfully")}catch(_){console.error("Error deleting bill:",_),alert("Error deleting bill: "+_.message)}},y=u=>{var ce;const _=un(),J=[41,128,185],B=[52,73,94],P=(Array.isArray(u.items)?u.items:[]).map(me=>[String(me.product_name||me.name||"-"),Number(me.qty||me.quantity||0),String(me.unit||"-"),{content:`Rs ${Number(me.mrp||0).toFixed(2)}`,styles:{halign:"right"}},{content:`Rs ${Number(me.discount||0).toFixed(2)}`,styles:{halign:"right"}},{content:`Rs ${Number(me.amount||0).toFixed(2)}`,styles:{halign:"right"}}]);_.setFillColor(...J),_.rect(0,0,210,40,"F"),_.setTextColor(255,255,255),_.setFontSize(22),_.setFont("helvetica","bold"),_.text(Je.name,105,15,{align:"center"}),_.setFontSize(10),_.setFont("helvetica","normal"),_.text(`${Je.address} | ${Je.phone}`,105,24,{align:"center"}),_.text(`GST: ${Je.gstNumber}`,105,31,{align:"center"}),_.setTextColor(...B),_.setFontSize(15),_.setFont("helvetica","bold"),_.text("Bill Invoice",105,50,{align:"center"}),_.setFontSize(10),_.setFont("helvetica","normal"),_.text(`Bill #: ${u.bill_number||"-"}`,14,60),_.text(`Date: ${new Date(u.created_at||Date.now()).toLocaleString()}`,14,66),_.text(`Customer: ${u.customer_name||"-"}`,14,72),u.customer_phone&&_.text(`Phone: ${u.customer_phone}`,14,78),u.customer_email&&_.text(`Email: ${u.customer_email}`,14,84),u.customer_address&&_.text(`Address: ${u.customer_address}`,14,90),mn(_,{startY:96,head:[["Product","Qty","Unit","MRP","Discount","Amount"]],body:P,theme:"striped",headStyles:{fillColor:J,textColor:[255,255,255],fontStyle:"bold",fontSize:9},bodyStyles:{fontSize:8,cellPadding:3},columnStyles:{0:{cellWidth:"auto"},1:{cellWidth:14,halign:"right"},2:{cellWidth:16},3:{cellWidth:26,halign:"right"},4:{cellWidth:26,halign:"right"},5:{cellWidth:28,halign:"right"}},margin:{left:14,right:14}});const te=(((ce=_.lastAutoTable)==null?void 0:ce.finalY)||96)+8;_.setFontSize(10),_.setFont("helvetica","bold"),_.text(`Subtotal: Rs ${Number(u.subtotal||0).toFixed(2)}`,130,te),_.text(`Discount: Rs ${Number(u.discount_amount||0).toFixed(2)}`,130,te+7),_.text(`Total: Rs ${Number(u.total_amount||0).toFixed(2)}`,130,te+14),_.setFont("helvetica","normal"),_.text(`Payment: ${u.payment_method||"-"}`,14,te+7),_.text(`Status: ${u.payment_status||"-"}`,14,te+14),hn(_,(me,i,b)=>{me.setFontSize(8),me.setTextColor(140,140,140),me.text(`Generated on ${new Date().toLocaleString("en-IN")} | Page ${i} of ${b}`,105,me.internal.pageSize.height-10,{align:"center"})}),pn(_,`${xn(u.bill_number||"Bill")}_Invoice`)},E=u=>qa({companyTitle:Oa,billNumber:u==null?void 0:u.bill_number,createdAt:u==null?void 0:u.created_at,customerName:u==null?void 0:u.customer_name,customerPhone:u==null?void 0:u.customer_phone,customerEmail:u==null?void 0:u.customer_email,customerAddress:u==null?void 0:u.customer_address,items:(u==null?void 0:u.items)||[],totalAmount:u==null?void 0:u.total_amount,paidAmount:u==null?void 0:u.paid_amount,creditAmount:u==null?void 0:u.credit_amount,paymentStatus:u==null?void 0:u.payment_status,onlineStoreUrl:Ra,thankYouLine:"Thank you for shopping with us."}),se=u=>{const _=`BILL ${u.bill_number||""} Total Rs ${Number(u.total_amount||0)} Paid Rs ${Number(u.paid_amount||0)} Credit Rs ${Number(u.credit_amount||0)}. ${Je.name}`;return _.length>160?_.slice(0,157)+"...":_},K=u=>{const J=(Array.isArray(u.items)?u.items:[]).map(B=>{const P=we(B.product_name||B.name||"Item"),te=Number(B.qty||B.quantity||0),ce=we(B.unit||""),me=Number(B.mrp||0),i=Number(B.discount||0),b=Number(B.amount||0);return`
        <tr>
          <td>${P}</td>
          <td>${te}${ce?" "+ce:""}</td>
          <td>Rs ${me.toFixed(2)}</td>
          <td>Rs ${i.toFixed(2)}</td>
          <td>Rs ${b.toFixed(2)}</td>
        </tr>
      `}).join("");return`
      <div class="invoice">
        <div class="invoice-header">
          <div class="invoice-brand">
            ${`<img src="${Je.logoPath}" alt="Logo" />`}
            <div>
              <div class="company-name">${we(Je.name)}</div>
              <div class="company-meta">GST: ${we(Je.gstNumber)}</div>
              <div class="company-meta">${we(Je.address)}</div>
              <div class="company-meta">${we(Je.phone)} | ${we(Je.email)}</div>
            </div>
          </div>
          <div class="invoice-info">
            <div><strong>Bill #</strong> ${we(u.bill_number||"")}</div>
            <div><strong>Date</strong> ${new Date(u.created_at||Date.now()).toLocaleString()}</div>
            <div><strong>Status</strong> ${we(u.payment_status||"")}</div>
          </div>
        </div>

        <div class="invoice-section">
          <div><strong>Customer</strong></div>
          <div>${we(u.customer_name||"")}</div>
          ${u.customer_phone?`<div>${we(u.customer_phone)}</div>`:""}
          ${u.customer_email?`<div>${we(u.customer_email)}</div>`:""}
          ${u.customer_address?`<div>${we(u.customer_address)}</div>`:""}
        </div>

        <table class="invoice-table">
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>MRP</th>
              <th>Discount</th>
              <th>Amount</th>
            </tr>
          </thead>
          <tbody>
            ${J||'<tr><td colspan="5">No items</td></tr>'}
          </tbody>
        </table>

        <div class="invoice-summary">
          <div><span>Subtotal</span><span>Rs ${Number(u.subtotal||0).toFixed(2)}</span></div>
          <div><span>Discount</span><span>Rs ${Number(u.discount_amount||0).toFixed(2)}</span></div>
          <div><span>Total</span><span>Rs ${Number(u.total_amount||0).toFixed(2)}</span></div>
          <div><span>Paid</span><span>Rs ${Number(u.paid_amount||0).toFixed(2)}</span></div>
          <div><span>Credit</span><span>Rs ${Number(u.credit_amount||0).toFixed(2)}</span></div>
        </div>

        <div class="invoice-footer">
          <div>Thank you for your business.</div>
        </div>
      </div>
    `},w=u=>{const _=K(u);Ia({title:`Bill ${u.bill_number||""}`,bodyHtml:_,cssText:`
        .invoice { max-width: 800px; margin: 0 auto; }
        .invoice-header { display: flex; justify-content: space-between; gap: 16px; margin-bottom: 16px; }
        .invoice-brand { display: flex; gap: 12px; align-items: center; }
        .invoice-brand img { width: 60px; height: 60px; object-fit: contain; }
        .company-name { font-size: 18px; font-weight: 700; }
        .company-meta { font-size: 12px; color: #444; }
        .invoice-info { text-align: right; font-size: 12px; }
        .invoice-section { margin: 12px 0 16px; font-size: 12px; }
        .invoice-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .invoice-table th, .invoice-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
        .invoice-summary { margin-top: 12px; display: grid; gap: 6px; font-size: 12px; }
        .invoice-summary div { display: flex; justify-content: space-between; }
        .invoice-footer { margin-top: 16px; font-size: 12px; text-align: center; color: #444; }
      `,onError:J=>alert(J)})},L=async u=>{const _=E(u);try{await navigator.clipboard.writeText(_),alert("Bill text copied.")}catch{alert("Failed to copy bill text.")}},ee=async u=>{const _=se(u);try{await navigator.clipboard.writeText(_),alert("SMS text copied.")}catch{alert("Failed to copy SMS text.")}},re=async u=>{const _=await Ba({phone:u==null?void 0:u.customer_phone,text:E(u)});if(_.status==="missing_phone"){alert("Customer phone is missing or invalid. Please update phone and try again.");return}if(_.status==="fallback_copy"){alert("Message was long, copied to clipboard. Paste it in WhatsApp.");return}_.status==="fallback_no_copy"&&alert("Message was long. Opened WhatsApp chat, please paste message manually.")},xe=l.filter(u=>{var _,J,B;return((_=u.bill_number)==null?void 0:_.toLowerCase().includes(h.toLowerCase()))||((J=u.customer_name)==null?void 0:J.toLowerCase().includes(h.toLowerCase()))||((B=u.customer_email)==null?void 0:B.toLowerCase().includes(h.toLowerCase()))});return k?e.jsx("div",{className:"bills-viewer-loading",children:"Loading bills..."}):e.jsxs("div",{className:"bills-viewer",children:[e.jsxs("div",{className:"bills-viewer-header",children:[e.jsx("h1",{children:"Bills History"}),e.jsx("p",{children:"View and manage all created bills"})]}),d&&e.jsxs("div",{className:"bills-viewer-error",children:[d,e.jsx("button",{onClick:W,children:"Retry"})]}),e.jsxs("div",{className:"bills-viewer-controls",children:[e.jsxs("div",{className:"search-box",children:[e.jsx(da,{size:18}),e.jsx("input",{type:"text",placeholder:"Search by bill number, customer name, or email...",value:h,onChange:u=>$(u.target.value)})]}),e.jsx("button",{className:"refresh-btn",onClick:W,children:"Refresh"})]}),xe.length===0?e.jsx("div",{className:"bills-viewer-empty",children:e.jsx("p",{children:"No bills found"})}):e.jsxs("div",{className:"bills-viewer-content",children:[e.jsx("div",{className:"bills-list",children:xe.map(u=>e.jsxs("div",{className:`bill-card ${(D==null?void 0:D.id)===u.id?"active":""}`,onClick:()=>G(u),children:[e.jsxs("div",{className:"bill-card-header",children:[e.jsx("span",{className:"bill-number",children:u.bill_number}),e.jsxs("span",{className:"bill-amount",children:["?",u.total_amount]})]}),e.jsxs("div",{className:"bill-card-details",children:[e.jsx("p",{children:e.jsx("strong",{children:u.customer_name})}),e.jsx("p",{className:"bill-date",children:new Date(u.created_at).toLocaleDateString()})]}),e.jsx("div",{className:"bill-card-status",children:e.jsx("span",{className:`status-badge ${u.payment_status}`,children:u.payment_status})})]},u.id))}),D&&e.jsxs("div",{className:"bill-details",children:[e.jsxs("div",{className:"bill-details-header",children:[e.jsx("h2",{children:D.bill_number}),e.jsxs("div",{className:"bill-details-actions",children:[e.jsx("button",{className:"action-btn print-btn",onClick:()=>w(D),title:"Print / Save as PDF",children:"Print/PDF"}),e.jsxs("button",{className:"action-btn download-btn",onClick:()=>y(D),title:"Download PDF",children:[e.jsx(Ma,{size:18})," PDF"]}),e.jsx("button",{className:"action-btn share-btn",onClick:()=>L(D),title:"Copy bill text",children:"Copy"}),e.jsx("button",{className:"action-btn sms-btn",onClick:()=>ee(D),title:"Copy SMS text",children:"SMS"}),e.jsx("button",{type:"button",className:"action-btn whatsapp-btn",onClick:()=>re(D),title:"Share via WhatsApp",children:"WhatsApp"}),e.jsxs("button",{className:"action-btn delete-btn",onClick:()=>S(D.id),title:"Delete bill",children:[e.jsx(ls,{size:18})," Delete"]})]})]}),e.jsxs("div",{className:"bill-details-section",children:[e.jsx("h3",{children:"Customer Information"}),e.jsxs("div",{className:"detail-row",children:[e.jsx("label",{children:"Name:"}),e.jsx("span",{children:D.customer_name})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("label",{children:"Email:"}),e.jsx("span",{children:D.customer_email})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("label",{children:"Phone:"}),e.jsx("span",{children:D.customer_phone})]}),D.customer_address&&e.jsxs("div",{className:"detail-row",children:[e.jsx("label",{children:"Address:"}),e.jsx("span",{children:D.customer_address})]})]}),D.items&&D.items.length>0&&e.jsxs("div",{className:"bill-details-section",children:[e.jsx("h3",{children:"Bill Items"}),e.jsxs("table",{className:"bill-items-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"MRP"}),e.jsx("th",{children:"Discount"}),e.jsx("th",{children:"Amount"})]})}),e.jsx("tbody",{children:D.items.map((u,_)=>e.jsxs("tr",{children:[e.jsx("td",{children:u.product_name}),e.jsx("td",{children:u.qty}),e.jsx("td",{children:u.unit}),e.jsxs("td",{children:["?",u.mrp]}),e.jsxs("td",{children:["?",u.discount]}),e.jsxs("td",{children:["?",u.amount]})]},_))})]})]}),e.jsxs("div",{className:"bill-details-section",children:[e.jsx("h3",{children:"Payment Summary"}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal:"}),e.jsxs("span",{children:["?",D.subtotal]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Discount:"}),e.jsxs("span",{children:["?",D.discount_amount]})]}),e.jsxs("div",{className:"summary-row highlight",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["?",D.total_amount]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Paid Amount:"}),e.jsxs("span",{children:["?",D.paid_amount??0]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Credit Amount:"}),e.jsxs("span",{children:["?",D.credit_amount??0]})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Payment Method:"}),e.jsx("span",{children:D.payment_method})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Payment Status:"}),e.jsx("span",{className:`status-badge ${D.payment_status}`,children:D.payment_status})]}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Created:"}),e.jsx("span",{children:new Date(D.created_at).toLocaleString()})]})]})]})]})]})};function Mn(){const[l,g]=r.useState([]),[k,A]=r.useState(!0),[d,R]=r.useState(""),[h,$]=r.useState({name:"",description:"",type:"percentage",value:0,status:"active"}),D=async()=>{try{A(!0),g(await Xt.getAll())}catch{R("Failed to load offers")}finally{A(!1)}};r.useEffect(()=>{D()},[]);const G=async S=>{S.preventDefault(),R("");try{await Xt.create(h),$({name:"",description:"",type:"percentage",value:0,status:"active"}),await D()}catch(y){R(y.message||"Failed to create offer")}},W=async S=>{try{await Xt.delete(S),g(y=>y.filter(E=>E.id!==S))}catch{R("Failed to delete offer")}};return k?e.jsx("div",{className:"billing-content",children:e.jsx("p",{children:"Loading offers..."})}):e.jsxs("div",{className:"billing-content",children:[e.jsx("h1",{children:"Offer Management"}),d&&e.jsx("div",{className:"error-message",children:d}),e.jsxs("form",{onSubmit:G,className:"form-section",children:[e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",children:"Name"}),e.jsx("input",{className:"form-input",value:h.name,onChange:S=>$(y=>({...y,name:S.target.value})),required:!0})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("input",{className:"form-input",value:h.description,onChange:S=>$(y=>({...y,description:S.target.value}))})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:"form-input",value:h.type,onChange:S=>$(y=>({...y,type:S.target.value})),children:[e.jsx("option",{value:"percentage",children:"Percentage"}),e.jsx("option",{value:"bogo",children:"Buy One Get One"}),e.jsx("option",{value:"bundle",children:"Bundle"}),e.jsx("option",{value:"volume",children:"Volume"})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsx("label",{className:"form-label",children:"Value"}),e.jsx("input",{type:"number",className:"form-input",value:h.value,onChange:S=>$(y=>({...y,value:Number(S.target.value||0)}))})]}),e.jsxs("button",{type:"submit",className:"add-btn",children:[e.jsx(Me,{size:16})," Add Offer"]})]}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"billing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Name"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Value"}),e.jsx("th",{children:"Status"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:l.map(S=>e.jsxs("tr",{children:[e.jsx("td",{children:S.name}),e.jsx("td",{children:S.type}),e.jsx("td",{children:S.value}),e.jsx("td",{children:S.status}),e.jsx("td",{children:e.jsx("button",{className:"delete-btn",onClick:()=>W(S.id),children:e.jsx(ls,{size:16})})})]},S.id))})]})})]})}const Es={display:"inline-flex",alignItems:"center",justifyContent:"center",minWidth:42};function Un(){const[l,g]=r.useState([]),[k,A]=r.useState([]),[d,R]=r.useState(""),[h,$]=r.useState(""),[D,G]=r.useState(!0),[W,S]=r.useState(!1),[y,E]=r.useState(""),[se,K]=r.useState({}),w=async({silent:i=!1}={})=>{try{i?S(!0):G(!0),R("");const[b,x]=await Promise.all([Ze.getPasswordResetRequests(),We.getAll()]);g(Array.isArray(b)?b:[]),A(Array.isArray(x)?x:[])}catch{R("Failed to load account actions data")}finally{G(!1),S(!1)}};r.useEffect(()=>{w()},[]);const L=r.useMemo(()=>k.filter(i=>String((i==null?void 0:i.role)||"").toLowerCase()!=="admin"),[k]),ee=r.useMemo(()=>L.filter(i=>i.email&&!i.email_verified),[L]),re=r.useMemo(()=>L.filter(i=>i.phone&&!i.phone_verified),[L]),xe=i=>{const b=String(i||"").trim();if(b){if(b.startsWith("mailto:")){window.location.href=b;return}window.open(b,"_blank","noopener,noreferrer")}},u=async i=>{const b=Number(i||0);if(b)try{await Ze.markNotificationSent(b)}catch{}},_=async(i,b)=>{var x;try{const z=String(i||"").trim();if(!z)return;if(!((x=navigator==null?void 0:navigator.clipboard)!=null&&x.writeText)){R("Clipboard API is not available in this browser");return}await navigator.clipboard.writeText(z),$(`${b} copied`)}catch{R(`Failed to copy ${String(b||"text").toLowerCase()}`)}},J=async(i,b)=>{const x=Number((i==null?void 0:i.id)||0);if(x)try{R(""),$(""),E(`reset:${x}:${b}`);const z=await Ze.updatePasswordResetRequest(x,{status:"approved",notify_channel:b}),X=(z==null?void 0:z.notification)||{};K(v=>({...v,[`reset:${x}`]:X})),b==="email"&&(X!=null&&X.email)&&(xe(X.email.mailto_url),await u(X.email.event_id)),b==="whatsapp"&&(X!=null&&X.whatsapp)&&(xe(X.whatsapp.whatsapp_url),await u(X.whatsapp.event_id)),$("Password reset approved and template prepared"),await w({silent:!0})}catch(z){R((z==null?void 0:z.message)||"Failed to process reset request")}finally{E("")}},B=async i=>{const b=Number((i==null?void 0:i.id)||0);if(b)try{R(""),$(""),E(`reset:${b}:reject`),await Ze.updatePasswordResetRequest(b,{status:"rejected"}),$("Password reset request rejected"),await w({silent:!0})}catch(x){R((x==null?void 0:x.message)||"Failed to reject request")}finally{E("")}},P=async i=>{const b=Number((i==null?void 0:i.id)||0);if(b)try{R(""),$(""),E(`email:${b}:prepare`);const x=await Ze.prepareEmailNotification({type:"email_verification",user_id:b}),z=(x==null?void 0:x.delivery)||{},X=(x==null?void 0:x.prepared_email)||(z==null?void 0:z.email)||null;if(!X)throw new Error("Prepared email content not returned");const v={event_id:Number((z==null?void 0:z.event_id)||0)||null,...X};K(F=>({...F,[`email:${b}`]:v})),xe(v.mailto_url),await u(v.event_id),$("Email verification template prepared")}catch(x){R((x==null?void 0:x.message)||"Failed to prepare email verification")}finally{E("")}},te=async i=>{const b=Number((i==null?void 0:i.id)||0);if(b)try{R(""),$(""),E(`email:${b}:verify`);const x=await Ze.markUserEmailVerified(b);K(z=>{const X={...z};return delete X[`email:${b}`],X}),$((x==null?void 0:x.message)||"Email marked as verified"),await w({silent:!0})}catch(x){R((x==null?void 0:x.message)||"Failed to mark email verified")}finally{E("")}},ce=async i=>{const b=Number((i==null?void 0:i.id)||0);if(b)try{R(""),$(""),E(`phone:${b}:prepare`);const x=await Ze.prepareWhatsAppNotification({type:"phone_verification",user_id:b}),z=(x==null?void 0:x.delivery)||{},X=(x==null?void 0:x.prepared_whatsapp)||(z==null?void 0:z.whatsapp)||null;if(!X)throw new Error("Prepared WhatsApp content not returned");const v={event_id:Number((z==null?void 0:z.event_id)||0)||null,...X};K(F=>({...F,[`phone:${b}`]:v})),xe(v.whatsapp_url),await u(v.event_id),$("Phone verification message prepared")}catch(x){R((x==null?void 0:x.message)||"Failed to prepare phone verification")}finally{E("")}},me=async i=>{const b=Number((i==null?void 0:i.id)||0);if(b)try{R(""),$(""),E(`phone:${b}:verify`);const x=await Ze.markUserPhoneVerified(b);K(z=>{const X={...z};return delete X[`phone:${b}`],X}),$((x==null?void 0:x.message)||"Phone marked as verified"),await w({silent:!0})}catch(x){R((x==null?void 0:x.message)||"Failed to mark phone verified")}finally{E("")}};return D?e.jsx("div",{className:"billing-content",children:e.jsx("p",{children:"Loading account actions..."})}):e.jsxs("div",{className:"billing-content account-actions",children:[e.jsxs("div",{className:"account-actions-header",children:[e.jsx("h1",{children:"Account Actions"}),e.jsxs("button",{className:"admin-btn",onClick:()=>w({silent:!0}),disabled:W||!!y,children:[W?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(Et,{size:16}),"Refresh"]})]}),e.jsx("p",{className:"account-actions-subtitle",children:"Manage password resets, email verification, and phone verification from one queue."}),d&&e.jsx("div",{className:"error-message",children:d}),h&&e.jsx("div",{className:"success-message",children:h}),e.jsxs("section",{className:"account-actions-section",children:[e.jsx("h2",{children:"Password Reset Requests"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"billing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Reason"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:l.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"6",children:"No password reset requests."})}):l.map(i=>{const b=y===`reset:${i.id}:email`,x=y===`reset:${i.id}:whatsapp`,z=y===`reset:${i.id}:reject`,X=se[`reset:${i.id}`]||{};return e.jsxs("tr",{children:[e.jsx("td",{children:i.user_name||"-"}),e.jsx("td",{children:i.email||"-"}),e.jsx("td",{children:i.phone||"-"}),e.jsx("td",{children:i.reason||"-"}),e.jsx("td",{children:i.status}),e.jsxs("td",{children:[i.status==="pending"?e.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",alignItems:"center"},children:[e.jsx("button",{className:"admin-btn",title:i.email?"Approve and send via Email":"Email is not available",onClick:()=>J(i,"email"),disabled:!i.email||!!y,style:Es,children:b?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(fa,{size:16})}),e.jsx("button",{className:"admin-btn",title:i.phone?"Approve and send via WhatsApp":"Phone is not available",onClick:()=>J(i,"whatsapp"),disabled:!i.phone||!!y,style:Es,children:x?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(_a,{size:16})}),e.jsx("button",{className:"admin-btn",title:"Reject request",onClick:()=>B(i),disabled:!!y,style:Es,children:z?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(on,{size:16})})]}):e.jsx("span",{children:i.status}),(X==null?void 0:X.email)&&e.jsxs("div",{className:"prepared-message-box",children:[e.jsx("strong",{children:"Prepared Email"}),e.jsx("textarea",{readOnly:!0,rows:4,value:X.email.body||""}),e.jsxs("div",{className:"prepared-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>_(X.email.subject,"Subject"),children:"Copy Subject"}),e.jsx("button",{className:"admin-btn",onClick:()=>_(X.email.body,"Body"),children:"Copy Body"}),X.email.mailto_url&&e.jsx("a",{className:"admin-btn",href:X.email.mailto_url,children:"Open Email App"})]})]}),(X==null?void 0:X.whatsapp)&&e.jsxs("div",{className:"prepared-message-box",children:[e.jsx("strong",{children:"Prepared WhatsApp"}),e.jsx("textarea",{readOnly:!0,rows:4,value:X.whatsapp.text||""}),e.jsxs("div",{className:"prepared-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>_(X.whatsapp.text,"Message"),children:"Copy Message"}),X.whatsapp.whatsapp_url&&e.jsx("a",{className:"admin-btn",href:X.whatsapp.whatsapp_url,target:"_blank",rel:"noreferrer",children:"Open WhatsApp"})]})]})]})]},i.id)})})]})})]}),e.jsxs("section",{className:"account-actions-section",children:[e.jsx("h2",{children:"Email Verification Tasks"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"billing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:ee.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",children:"No pending email verification tasks."})}):ee.map(i=>{const b=y===`email:${i.id}:prepare`,x=y===`email:${i.id}:verify`,z=se[`email:${i.id}`];return e.jsxs("tr",{children:[e.jsx("td",{children:i.name||"-"}),e.jsx("td",{children:i.email||"-"}),e.jsx("td",{children:i.email_verified?"Verified":"Unverified"}),e.jsxs("td",{children:[e.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",alignItems:"center"},children:[e.jsx("button",{className:"admin-btn",title:"Prepare verification email",onClick:()=>P(i),disabled:!!y,style:Es,children:b?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(fa,{size:16})}),e.jsx("button",{className:"admin-btn",title:"Mark email verified",onClick:()=>te(i),disabled:!!y,style:Es,children:x?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(ia,{size:16})})]}),z&&e.jsxs("div",{className:"prepared-message-box",children:[e.jsx("strong",{children:"Prepared Email"}),e.jsx("textarea",{readOnly:!0,rows:4,value:z.body||""}),e.jsxs("div",{className:"prepared-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>_(z.subject,"Subject"),children:"Copy Subject"}),e.jsx("button",{className:"admin-btn",onClick:()=>_(z.body,"Body"),children:"Copy Body"}),z.mailto_url&&e.jsx("a",{className:"admin-btn",href:z.mailto_url,children:"Open Email App"}),z.link&&e.jsx("a",{className:"admin-btn",href:z.link,target:"_blank",rel:"noreferrer",children:"Open Verification Link"})]})]})]})]},`email-${i.id}`)})})]})})]}),e.jsxs("section",{className:"account-actions-section",children:[e.jsx("h2",{children:"Phone Verification Tasks"}),e.jsx("div",{className:"table-container",children:e.jsxs("table",{className:"billing-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Phone"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:re.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",children:"No pending phone verification tasks."})}):re.map(i=>{const b=y===`phone:${i.id}:prepare`,x=y===`phone:${i.id}:verify`,z=se[`phone:${i.id}`];return e.jsxs("tr",{children:[e.jsx("td",{children:i.name||"-"}),e.jsx("td",{children:i.phone||"-"}),e.jsx("td",{children:i.phone_verified?"Verified":"Unverified"}),e.jsxs("td",{children:[e.jsxs("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",alignItems:"center"},children:[e.jsx("button",{className:"admin-btn",title:"Prepare verification WhatsApp message",onClick:()=>ce(i),disabled:!!y,style:Es,children:b?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(_a,{size:16})}),e.jsx("button",{className:"admin-btn",title:"Mark phone verified",onClick:()=>me(i),disabled:!!y,style:Es,children:x?e.jsx(ys,{size:16,className:"spinning"}):e.jsx(ia,{size:16})})]}),z&&e.jsxs("div",{className:"prepared-message-box",children:[e.jsx("strong",{children:"Prepared WhatsApp"}),e.jsx("textarea",{readOnly:!0,rows:4,value:z.text||""}),e.jsxs("div",{className:"prepared-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>_(z.text,"Message"),children:"Copy Message"}),z.whatsapp_url&&e.jsx("a",{className:"admin-btn",href:z.whatsapp_url,target:"_blank",rel:"noreferrer",children:"Open WhatsApp"}),z.link&&e.jsx("a",{className:"admin-btn",href:z.link,target:"_blank",rel:"noreferrer",children:"Open Verification Link"})]})]})]})]},`phone-${i.id}`)})})]})})]})]})}const nt=l=>Va(l,["transaction_date","created_at","date"]),qn=l=>new Date(nt(l)).toLocaleDateString(),Bn=l=>Number((l==null?void 0:l.edited)||0)===1||!!(l!=null&&l.edited_at),ra=()=>({user_id:"",type:"payment",amount:"",transactionDate:Fs(),reference:"",description:""});function Qn({user:l}){const[g,k]=r.useState(!0),[A,d]=r.useState(!1),[R,h]=r.useState(""),[$,D]=r.useState([]),[G,W]=r.useState([]),[S,y]=r.useState({user_id:""}),[E,se]=r.useState(!1),[K,w]=r.useState(ra()),[L,ee]=r.useState(null),re=r.useMemo(()=>{const i={};return $.forEach(b=>{i[String(b.id)]=b}),i},[$]),xe=async()=>{const b=(await We.getAll()||[]).filter(x=>x.role!=="admin");return D(b),b},u=async(i,b=$)=>{d(!0),h("");try{let x=[];try{x=await Ts.getLedger(i||"")}catch(F){const p=String((F==null?void 0:F.message)||"").toLowerCase();if(!(p.includes("not found")||p.includes("cannot get")||p.includes("not available")))throw F;const O=i?b.filter(N=>String(N.id)===String(i)):b;x=(await Promise.all(O.map(async N=>(await Ts.getHistory(N.id)||[]).map(Q=>({...Q,user_id:Q.user_id??N.id,customer_name:Q.customer_name||N.name}))))).flat()}const z={},v=[...x||[]].sort((F,p)=>{const C=nt(F)-nt(p);return C!==0?C:Number(F.id||0)-Number(p.id||0)}).map(F=>{const p=String(F.user_id||"unknown"),O=(z[p]||0)+At(F);return z[p]=O,{...F,computed_balance:O}});W(v.sort((F,p)=>{const C=nt(p)-nt(F);return C!==0?C:Number(p.id||0)-Number(F.id||0)}))}catch(x){if((x==null?void 0:x.status)===401){localStorage.removeItem("user"),window.location.href="/login";return}h(x.message||"Failed to load credit khata ledger"),W([])}finally{d(!1)}};r.useEffect(()=>{(async()=>{k(!0),h("");try{await xe()}catch(b){if((b==null?void 0:b.status)===401){localStorage.removeItem("user"),window.location.href="/login";return}h(b.message||"Failed to load credit khata data")}finally{k(!1)}})()},[]),r.useEffect(()=>{g||u(S.user_id,$)},[S.user_id,g]);const _=i=>{y({user_id:i.target.value})},J=()=>{h(""),ee(null),w({...ra(),user_id:S.user_id||""}),se(!0)},B=i=>{h(""),ee(Number(i.id||0)),w({user_id:String(i.user_id||""),type:i.type==="payment"?"payment":"given",amount:String(q(i.amount||0)),transactionDate:String(i.transaction_date||"").slice(0,10)||Fs(),reference:i.reference||"",description:i.description||""}),se(!0)},P=()=>{se(!1),ee(null),w(ra())},te=async i=>{i.preventDefault(),h("");const b=q(K.amount);if(!K.user_id){h("Please select a customer");return}if(b<=0){h("Please enter a valid amount");return}if(!K.description.trim()){h("Please enter a description");return}try{L?await Ts.updateTransaction(K.user_id,L,{type:K.type,amount:Number(b.toFixed(2)),reference:K.reference,description:K.description,transactionDate:K.transactionDate,edited_by:l==null?void 0:l.id}):await Ts.addTransaction(K.user_id,{type:K.type,amount:Number(b.toFixed(2)),reference:K.reference,description:K.description,transactionDate:K.transactionDate,created_by:l==null?void 0:l.id}),P(),await u(S.user_id,$)}catch(x){if((x==null?void 0:x.status)===401){localStorage.removeItem("user"),window.location.href="/login";return}h(x.message||(L?"Failed to edit ledger transaction":"Failed to add ledger transaction"))}},ce=r.useMemo(()=>{const i={};for(const b of G){const x=String(b.user_id||"unknown");i[x]===void 0&&(i[x]=q(b.computed_balance??b.balance))}return S.user_id?{label:"Customer Balance",value:q(i[String(S.user_id)]||0)}:{label:"Total Balance (All Customers)",value:Object.values(i).reduce((b,x)=>b+q(x),0)}},[S.user_id,G]),me=r.useMemo(()=>{const i={};for(const b of G){const x=String(b.user_id||"");!x||i[x]||(i[x]=Number(b.id||0))}return i},[G]);return g?e.jsx("div",{className:"credit-khata",children:e.jsx("div",{className:"loading",children:"Loading credit khata..."})}):!l||l.role!=="admin"?e.jsx("div",{className:"credit-khata",children:e.jsx("div",{className:"error-message",children:"Only administrators can access Credit Khata."})}):e.jsxs("div",{className:"credit-khata purchase-management",children:[R&&e.jsx("div",{className:"error-message",children:R}),e.jsx("div",{className:"filters-bar",children:e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{children:"Customer:"}),e.jsxs("select",{name:"user_id",value:S.user_id,onChange:_,children:[e.jsx("option",{value:"",children:"All Customers"}),$.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})]})}),e.jsxs("div",{className:"actions-bar ledger-header",children:[e.jsx("h2",{children:"Customer Credit / Payment Ledger"}),e.jsx("div",{className:"action-buttons",children:e.jsxs("button",{className:"admin-btn primary",onClick:J,children:[e.jsx(Me,{size:18})," Payment / Credit Entry"]})})]}),e.jsxs("div",{className:"ledger-balance-summary",children:[e.jsx("span",{className:"ledger-balance-label",children:ce.label}),e.jsx("strong",{className:`ledger-balance-value ${ce.value>=0?"positive":"negative"}`,children:H(ce.value)})]}),e.jsx("div",{className:"data-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Amount"}),e.jsx("th",{children:"Balance"}),e.jsx("th",{children:"Reference"}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:A?e.jsx("tr",{children:e.jsx("td",{colSpan:"9",className:"empty-state",children:"Loading ledger records..."})}):G.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"9",className:"empty-state",children:"No customer payment/credit records found"})}):G.map((i,b)=>{var X;const x=String(i.user_id||""),z=Number(i.id||0)>0&&Number(i.id||0)===Number(me[x]||0);return e.jsxs("tr",{children:[e.jsx("td",{children:qn(i)}),e.jsx("td",{children:((X=re[x])==null?void 0:X.name)||i.customer_name||"-"}),e.jsx("td",{children:Ka(i)}),e.jsx("td",{children:H(q(i.amount))}),e.jsx("td",{children:H(q(i.computed_balance??i.balance))}),e.jsx("td",{children:i.reference||i.invoice_number||"-"}),e.jsx("td",{children:i.description||"-"}),e.jsx("td",{children:Bn(i)?"EDITED":"-"}),e.jsx("td",{children:z?e.jsx("button",{type:"button",className:"admin-btn",onClick:()=>B(i),title:"Only latest transaction for this customer can be edited",children:"Edit"}):"-"})]},i.id||b)})})]})}),E&&e.jsx("div",{className:"modal-overlay",onClick:P,children:e.jsxs("div",{className:"modal-content",onClick:i=>i.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:L?"Edit Latest Customer Transaction":"Add Customer Payment / Credit"}),e.jsx("button",{className:"close-btn",onClick:P,children:e.jsx(ke,{size:24})})]}),e.jsxs("form",{onSubmit:te,children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Customer *"}),e.jsxs("select",{value:K.user_id,onChange:i=>w(b=>({...b,user_id:i.target.value})),disabled:!!L,required:!0,children:[e.jsx("option",{value:"",children:"Select customer"}),$.map(i=>e.jsx("option",{value:i.id,children:i.name},i.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Type *"}),e.jsxs("select",{value:K.type,onChange:i=>w(b=>({...b,type:i.target.value})),children:[e.jsx("option",{value:"payment",children:"Payment (Reduce due)"}),e.jsx("option",{value:"given",children:"Credit (Increase due)"})]})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Amount *"}),e.jsx("input",{type:"number",step:"0.01",min:"0.01",value:K.amount,onChange:i=>w(b=>({...b,amount:i.target.value})),placeholder:"Enter amount",required:!0})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Transaction Date"}),e.jsx("input",{type:"date",value:K.transactionDate,onChange:i=>w(b=>({...b,transactionDate:i.target.value}))})]})]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Reference"}),e.jsx("input",{type:"text",value:K.reference,onChange:i=>w(b=>({...b,reference:i.target.value})),placeholder:"Bill / UPI / Bank ref"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Description *"}),e.jsx("input",{type:"text",value:K.description,onChange:i=>w(b=>({...b,description:i.target.value})),placeholder:"Enter description",required:!0})]})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{type:"button",className:"cancel-btn",onClick:P,children:"Cancel"}),e.jsx("button",{type:"submit",className:"submit-btn",children:L?"Update Entry":"Save Entry"})]})]})]})})]})}function $a({open:l,title:g,onClose:k,children:A,dialogClassName:d="",contentClassName:R=""}){return r.useEffect(()=>{if(!l)return;const h=$=>{$.key==="Escape"&&typeof k=="function"&&k()};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[l,k]),l?e.jsx("div",{className:"app-modal-overlay",onClick:()=>{typeof k=="function"&&k()},role:"presentation",children:e.jsxs("div",{className:`app-modal-dialog ${d}`.trim(),onClick:h=>h.stopPropagation(),role:"dialog","aria-modal":"true","aria-label":g||"Dialog",children:[e.jsxs("div",{className:"app-modal-header",children:[e.jsx("h2",{children:g}),e.jsx("button",{type:"button",className:"app-modal-close-btn",onClick:k,"aria-label":"Close",children:e.jsx(ke,{size:20})})]}),e.jsx("div",{className:`app-modal-content ${R}`.trim(),children:A})]})}):null}const st=l=>{const g=H(Math.abs(l));return e.jsx("span",{className:sn(l),children:g})},Kn=l=>{const g=Number(l||0);return g<1024?`${g} B`:g<1024*1024?`${(g/1024).toFixed(1)} KB`:g<1024*1024*1024?`${(g/(1024*1024)).toFixed(1)} MB`:`${(g/(1024*1024*1024)).toFixed(1)} GB`},Te=(l,g=0)=>{const k=Number(l);return Number.isFinite(k)?k:g};function mr({user:l}){const g=Xa(),[k,A]=Ya(),[d,R]=r.useState(()=>{if(typeof window>"u")return"dashboard";const t=new URLSearchParams(window.location.search).get("tab");return new Set(["dashboard","orders","offers","credit-aging","products","categories","billing","view-bills","purchases","distributors","stock-ledger","users","credit-khata","password-resets","backup-restore"]).has(t)?t:"dashboard"}),[h,$]=r.useState({totalOrders:0,totalRevenue:0,pendingOrders:0}),[D,G]=r.useState([]),[W,S]=r.useState([]),[y,E]=r.useState([]),[se,K]=r.useState(!0),[w,L]=r.useState(!1),[ee,re]=r.useState(null),[xe,u]=r.useState(!1),[_,J]=r.useState(null),[B,P]=r.useState(!1),[te,ce]=r.useState(!1),[me,i]=r.useState(null),[b,x]=r.useState(!1),[z,X]=r.useState(null),[v,F]=r.useState([]),[p,C]=r.useState(!1),[O,ie]=r.useState([]),[N,Z]=r.useState(!1),[Q,U]=r.useState(!1),[Ne,es]=r.useState(!1),[Ge,Ls]=r.useState({}),[Ae,_s]=r.useState(()=>{if(typeof window>"u")return"table";const t=window.localStorage.getItem("admin-products-view");return t==="table"||t==="grid"?t:window.innerWidth<=768?"grid":"table"}),[Xe,oe]=r.useState(!1),[de,je]=r.useState(!1),[ne,Fe]=r.useState({name:"",category:"",price:"",stock:"",image:""}),[hs,Ue]=r.useState(null),[Be,ps]=r.useState({name:"",category:"",price:"",stock:"",image:""}),[it,Qe]=r.useState(""),[xs,Qs]=r.useState("created_at"),[Cs,lt]=r.useState("desc"),[Ss,ge]=r.useState(""),[$e,Le]=r.useState("all"),[Ke,Rs]=r.useState(!1),[ct,ws]=r.useState(null),[cs,Ks]=r.useState(!1),[ae,_e]=r.useState({name:"",description:"",brand:"",content:"",color:"",category:"",sku:"",barcode:"",price:"",mrp:"",uom:"pcs",stock:"",expiry_date:"",defaultDiscount:"",discountType:"fixed",is_active:!0,image:""}),[Os,ot]=r.useState(null),[Vs,ss]=r.useState(!1),[Is,ts]=r.useState("csv"),[pe,os]=r.useState(null),[dt,zs]=r.useState([]),[Ve,js]=r.useState(!1),gs=r.useRef(null),Hs={dashboard:"general",orders:"general",offers:"general","credit-aging":"general",products:"products",categories:"products",billing:"billing","view-bills":"billing",purchases:"purchase",distributors:"purchase","stock-ledger":"purchase",users:"users","credit-khata":"users","password-resets":"users","backup-restore":"users"},[be,Re]=r.useState({general:!0,products:!1,billing:!1,purchase:!1,users:!1}),Se=async()=>{const[t,o,j,f]=await Promise.all([Jt.orders(),ye.getAll({include_inactive:!0}),kt.getAll(),We.getAll()]);$(t),G(o),S(j),E(f)},Ye=async t=>{try{C(!0);const o=await kt.getById(t);X(o);const j=o.items||[],f=await Promise.all(j.map(async le=>{try{const fe=await ye.getById(le.product_id);return{...le,stock:fe.stock}}catch{return{...le,stock:void 0}}}));F(f),x(!0)}catch(o){Y(o.message||"Failed to load order details","error")}finally{C(!1)}},as=async()=>{if(z)try{C(!0),await kt.updateStatus(z.id,"confirmed","Approved via admin modal",l.id),x(!1),await Se(),Y("Order approved and stock applied","success"),await fetch(`/api/notify-order/${z.id}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"approved"})}).catch(()=>{})}catch(t){Y(t.message||"Failed to approve order","error")}finally{C(!1)}},ks=async(t,o)=>{if(window.confirm("Are you sure you want to cancel this order?"))try{await kt.updateStatus(t,o,`Order ${o} via admin panel`,l.id),await Se(),Y(`Order ${o} successfully`,"success")}catch(j){console.error("Failed to update order status",j),Y(j.message||"Failed to update order status","error")}};r.useEffect(()=>{if(l){if(l.role!=="admin"){g("/");return}Ft()}},[l,g]),r.useEffect(()=>{const t=Hs[d];t&&Re(o=>({...o,[t]:!0}))},[d]),r.useEffect(()=>{const t=k.get("tab");t&&Hs[t]&&t!==d&&R(t)},[k]),r.useEffect(()=>{d==="backup-restore"&&ns()},[d]),r.useEffect(()=>{typeof window>"u"||window.localStorage.setItem("admin-products-view",Ae)},[Ae]);const De=t=>{Re(o=>({...o,[t]:!o[t]}))},ue=t=>{R(t);const o=new URLSearchParams(k);o.set("tab",t),A(o,{replace:!0}),window.innerWidth<=768&&es(!1)},Ft=async()=>{try{K(!0),await Se()}catch(t){console.error("Error fetching data:",t),Y(t.message||"Failed to load admin dashboard data","error")}finally{K(!1)}},ds=t=>{const o=String(t||"").trim();return o?o.split(" ").map(j=>j[0]).join("").slice(0,2).toUpperCase():"U"},Ws=t=>{if(!t)return"-";const o=new Date(t);return Number.isNaN(o.getTime())?"-":o.toLocaleDateString()},ns=async()=>{try{Z(!0);const t=await Ze.listBackups();ie(Array.isArray(t)?t:[])}catch(t){Y(t.message||"Failed to load backups","error")}finally{Z(!1)}},ut=async()=>{var t;try{U(!0);const o=await Ze.createBackup(),j=((t=o==null?void 0:o.backup)==null?void 0:t.file_name)||"backup";Y(`Backup created: ${j}`,"success"),await ns()}catch(o){Y(o.message||"Failed to create backup","error")}finally{U(!1)}},mt=async t=>{if(!(!t||!window.confirm(`Restore backup "${t}"?

A pre-restore snapshot will be created automatically.`)))try{U(!0);const j=await Ze.restoreBackup(t);Y(`Restore complete: ${(j==null?void 0:j.restored_file)||t}. Pre-restore backup: ${(j==null?void 0:j.pre_restore_backup)||"created"}`,"success"),await ns(),await Se()}catch(j){Y(j.message||"Failed to restore backup","error")}finally{U(!1)}},Ms=async t=>{if(window.confirm("Mark this product as inactive?"))try{await ye.delete(t);const o=await ye.getAll({include_inactive:!0});G(o),Y("Product marked inactive","success");const j=await Jt.orders();$(j)}catch{Y("Failed to delete product","error")}},Us=async t=>{if(Number((t==null?void 0:t.is_active)??1)===1){Y("Deactivate product before permanent delete","error");return}const o=String((t==null?void 0:t.name)||"").trim();if(window.prompt(`Permanent delete "${o}"? This cannot be undone.
Type DELETE to confirm:`,"")==="DELETE")try{await ye.deletePermanent(t.id);const f=await ye.getAll({include_inactive:!0});G(f),Y("Product permanently deleted","success")}catch(f){Y(f.message||"Failed to permanently delete product","error")}},ht=async t=>{if(window.confirm("Are you sure you want to delete this customer?"))try{await We.delete(t),E(o=>o.filter(j=>j.id!==t)),Y("Customer deleted successfully","success")}catch(o){Y(o.message||"Failed to delete customer","error")}},pt=t=>{re(t),L(!0)},Tt=()=>{re(null),L(!0)},Ps=async(t={})=>{try{const o=await ye.getAll({include_inactive:!0});G(o);const j=await Jt.orders();$(j),(t==null?void 0:t.mode)==="create"&&Number(t==null?void 0:t.createdCount)>1?Y(`${t.createdCount} products added successfully`,"success"):(t==null?void 0:t.mode)==="edit"?Y("Product updated successfully","success"):(t==null?void 0:t.mode)==="create"?Y("Product added successfully","success"):Y(ee?"Product updated successfully":"Product added successfully","success")}catch{Y("Failed to refresh products","error")}},Y=(t,o)=>{i({message:t,type:o}),setTimeout(()=>i(null),3e3)},As=()=>{i(null)},xt=Array.from(new Set(D.map(t=>String(t.category||"").trim()).filter(Boolean))).sort((t,o)=>t.localeCompare(o)),us=r.useMemo(()=>D.filter(t=>Number((t==null?void 0:t.is_active)??1)===1).length,[D]),$t=Math.max(0,D.length-us),bs=r.useMemo(()=>y.filter(t=>String((t==null?void 0:t.role)||"").toLowerCase()!=="admin"),[y]),qs=r.useMemo(()=>y.filter(t=>String((t==null?void 0:t.role)||"").toLowerCase()==="admin"),[y]),Lt=r.useMemo(()=>W.filter(t=>String((t==null?void 0:t.status)||"").toLowerCase()==="pending"),[W]),Ds=r.useMemo(()=>[...W].sort((t,o)=>new Date((o==null?void 0:o.created_at)||0).getTime()-new Date((t==null?void 0:t.created_at)||0).getTime()).slice(0,3),[W]),jt=r.useMemo(()=>D.filter(t=>Number((t==null?void 0:t.is_active)??1)===1&&Te(t==null?void 0:t.stock,0)<=10).sort((t,o)=>Te(t==null?void 0:t.stock,0)-Te(o==null?void 0:o.stock,0)).slice(0,3),[D]),gt=r.useMemo(()=>[...bs].sort((t,o)=>new Date((o==null?void 0:o.created_at)||0).getTime()-new Date((t==null?void 0:t.created_at)||0).getTime()).slice(0,3),[bs]),Gs=r.useMemo(()=>{const t=String(it||"").trim().toLowerCase();let o=Array.isArray(D)?[...D]:[];Ss&&(o=o.filter(f=>String(f.category||"").trim()===Ss)),$e!=="all"&&(o=o.filter(f=>{const le=Number(f.is_active??1)===1;return $e==="active"?le:!le})),Ke&&(o=o.filter(f=>Te(f.stock,0)<=10)),t&&(o=o.filter(f=>[f.id,f.name,f.description,f.brand,f.content,f.color,f.category,f.sku,f.barcode,f.price,f.mrp,f.uom,f.stock,f.expiry_date,f.defaultDiscount,f.discountType,f.is_active].map(fe=>String(fe??"").toLowerCase()).join(" ").includes(t)));const j=f=>{switch(xs){case"id":return Te(f.id,0);case"name":return String(f.name||"").toLowerCase();case"category":return String(f.category||"").toLowerCase();case"brand":return String(f.brand||"").toLowerCase();case"sku":return String(f.sku||"").toLowerCase();case"barcode":return String(f.barcode||"").toLowerCase();case"price":return Te(f.price,0);case"mrp":return Te(f.mrp,0);case"stock":return Te(f.stock,0);case"defaultDiscount":return Te(f.defaultDiscount,0);case"is_active":return Number(f.is_active??1);case"created_at":return new Date(f.created_at||0).getTime();case"src":return String(f.image||"").toLowerCase();default:return String(f[xs]??"").toLowerCase()}};return o.sort((f,le)=>{const fe=j(f),qe=j(le);return fe<qe?Cs==="asc"?-1:1:fe>qe?Cs==="asc"?1:-1:0}),o},[D,it,Ss,$e,Ke,xs,Cs]),Oe=t=>{if(xs===t){lt(o=>o==="asc"?"desc":"asc");return}Qs(t),lt(t==="name"||t==="brand"||t==="category"||t==="sku"?"asc":"desc")},Ie=t=>xs!==t?"":Cs==="asc"?" ▲":" ▼",bt=t=>{ws(t.id),_e({name:t.name||"",description:t.description||"",brand:t.brand||"",content:t.content||"",color:t.color||"",category:t.category||"",sku:t.sku||"",barcode:t.barcode||"",price:String(t.price??""),mrp:String(t.mrp??""),uom:t.uom||"pcs",stock:String(t.stock??0),expiry_date:t.expiry_date?String(t.expiry_date).slice(0,10):"",defaultDiscount:String(t.defaultDiscount??0),discountType:t.discountType||"fixed",is_active:Number(t.is_active??1)===1,image:t.image||""}),Ue(null)},vt=()=>{ws(null),Ks(!1)},Ce=(t,o)=>{_e(j=>({...j,[t]:o}))},Rt=async t=>{var j;const o={name:String(ae.name||"").trim(),description:String(ae.description||"").trim(),brand:String(ae.brand||"").trim(),content:String(ae.content||"").trim(),color:String(ae.color||"").trim(),category:String(ae.category||"").trim(),sku:String(ae.sku||"").trim(),barcode:String(ae.barcode||"").trim(),price:Te(ae.price,0),mrp:Te(ae.mrp,0),uom:String(ae.uom||"pcs").trim()||"pcs",stock:Te(ae.stock,0),expiry_date:ae.expiry_date||null,defaultDiscount:Te(ae.defaultDiscount,0),discountType:ae.discountType==="percentage"?"percentage":"fixed",image:String(ae.image||"").trim(),is_active:Number(t.is_active??1)===0||ae.is_active?1:0,base_unit:t.base_unit||"pcs",uom_type:t.uom_type||"selling",conversion_factor:Te(t.conversion_factor,1)||1};if(!o.name){Y("Product name is required","error");return}if(!o.category){Y("Category is required","error");return}if(!(o.price>0)){Y("Price must be greater than 0","error");return}if(o.stock<0){Y("Stock must be 0 or more","error");return}try{Ks(!0);try{await ye.update(t.id,o)}catch(f){const le=String(((j=f==null?void 0:f.payload)==null?void 0:j.conflict_type)||"");if(Number(f==null?void 0:f.status)===409&&le==="identical"){if(!window.confirm(`${f.message}

Continue anyway?`))return;await ye.update(t.id,{...o,allow_identical:!0})}else throw f}await Ps({mode:"edit",createdCount:0}),vt()}catch(f){Y(f.message||"Failed to update product","error")}finally{Ks(!1)}},ft=()=>{Fe({name:"",category:"",price:"",stock:"",image:""})},vs=(t,o={})=>{const j=String(t.name||"").trim(),f=String(t.category||"").trim(),le=String(o.description||"").trim()||`${j} product`,fe=Number(t.price||0),qe=Number(t.stock||0);return{name:j,description:le,brand:o.brand||"",content:o.content||"",color:o.color||"",price:fe,mrp:Number(o.mrp||0)>0?Number(o.mrp):fe,uom:o.uom||"pcs",base_unit:o.base_unit||"pcs",uom_type:o.uom_type||"selling",conversion_factor:Number(o.conversion_factor||1)||1,barcode:o.barcode||"",sku:o.sku||"",image:String(t.image||"").trim(),stock:qe,expiry_date:o.expiry_date||null,category:f,defaultDiscount:Number(o.defaultDiscount||0)||0,discountType:o.discountType||"fixed"}},Xs=t=>String(t.name||"").trim()?String(t.category||"").trim()?Number(t.price)>0?Number(t.stock)>=0?!0:(Y("Stock must be 0 or more","error"),!1):(Y("Price must be greater than 0","error"),!1):(Y("Category is required","error"),!1):(Y("Product name is required","error"),!1),yt=async()=>{var t;if(Xs(ne))try{je(!0);const o=vs(ne);try{await ye.create(o)}catch(j){const f=String(((t=j==null?void 0:j.payload)==null?void 0:t.conflict_type)||"");if(Number(j==null?void 0:j.status)===409&&f==="identical"){if(!window.confirm(`${j.message}

Continue anyway?`))return;await ye.create({...o,allow_identical:!0})}else throw j}await Ps({mode:"create",createdCount:1}),oe(!1),ft()}catch(o){Y(o.message||"Failed to add product","error")}finally{je(!1)}},Ot=t=>{Ue(t.id),ps({name:t.name||"",category:t.category||"",price:String(t.price??""),stock:String(t.stock??0),image:t.image||""})},Nt=()=>{Ue(null),ps({name:"",category:"",price:"",stock:"",image:""})},It=async t=>{var o;if(Xs(Be))try{je(!0);const j=vs(Be,t);try{await ye.update(t.id,j)}catch(f){const le=String(((o=f==null?void 0:f.payload)==null?void 0:o.conflict_type)||"");if(Number(f==null?void 0:f.status)===409&&le==="identical"){if(!window.confirm(`${f.message}

Continue anyway?`))return;await ye.update(t.id,{...j,allow_identical:!0})}else throw f}await Ps({mode:"edit",createdCount:0}),Nt()}catch(j){Y(j.message||"Failed to update product","error")}finally{je(!1)}},zt=t=>new Promise((o,j)=>{const f=new FileReader;f.onload=()=>{const le=String(f.result||""),fe=le.includes(",")?le.split(",")[1]:le;o(fe)},f.onerror=j,f.readAsDataURL(t)}),Mt=async(t,o)=>{var St;let j=(l==null?void 0:l.token)||null;if(!j)try{const fs=localStorage.getItem("user")||"{}";j=((St=JSON.parse(fs))==null?void 0:St.token)||null}catch{j=null}if(!j)throw new Error("Please login again. Missing auth token.");const f=await fetch(t,{headers:{Authorization:`Bearer ${j}`}});if(!f.ok){const fs=await f.json().catch(()=>({}));throw new Error(fs.error||"Download failed")}const le=await f.blob(),fe=URL.createObjectURL(le),qe=document.createElement("a"),Js=String(f.headers.get("Content-Disposition")||"").match(/filename="?([^"]+)"?/i);qe.href=fe,qe.download=(Js==null?void 0:Js[1])||o,document.body.appendChild(qe),qe.click(),document.body.removeChild(qe),URL.revokeObjectURL(fe)},Ys=async()=>{const t=Is==="xlsx"?"xlsx":"csv";try{const o=ye.getExportUrl(t,!0);await Mt(o,`products-export.${t==="xlsx"?"xlsx":"csv"}`),Y("Products exported successfully","success"),ss(!1)}catch(o){Y(o.message||"Failed to export products","error")}},Ut=()=>{Ve||gs.current&&(gs.current.value="",gs.current.click())},qt=async t=>{var j;const o=((j=t.target.files)==null?void 0:j[0])||null;o&&(ot(o),await Bt(o))},Bt=async(t=null)=>{const o=t||Os;if(!o){Y("Select a CSV/XLSX file first","error");return}try{js(!0);const j=await zt(o),f=await ye.importPreview({file_name:o.name,file_content_base64:j,mode:"upsert",stock_mode:"replace"});os(f),zs([]),Y("Import preview generated. Review and confirm.","success")}catch(j){os(null),Y(j.message||"Failed to preview import","error")}finally{js(!1)}},Qt=async()=>{if(!(pe!=null&&pe.batch_id)||!(pe!=null&&pe.checksum)){Y("Generate preview before confirming import","error");return}try{js(!0);const t=await ye.importConfirm({batch_id:pe.batch_id,checksum:pe.checksum,allow_identical_rows:dt});await Ps({mode:"create"}),os(null),ot(null),zs([]),Y(`Import applied. Created: ${t.created}, Updated: ${t.updated}`,"success")}catch(t){Y(t.message||"Failed to confirm import","error")}finally{js(!1)}},_t=t=>{if(!t||!t.email_verified||!t.phone_verified){Y("User type can be changed only when both email and phone are verified.","error");return}J(t)},Ct=async()=>{try{const t=await We.getAll();E(t),Y("User updated successfully","success")}catch{Y("Failed to refresh users","error")}},Kt=()=>{J(null),ce(!0),P(!0)},Vt=async()=>{try{const t=await We.getAll();E(t),Y("User created successfully","success")}catch{Y("Failed to refresh users","error")}};return!l||l.role!=="admin"?e.jsx("div",{className:"admin-page",children:e.jsxs("div",{className:"admin-container",children:[e.jsx("h1",{children:"Access Denied"}),e.jsx("p",{children:"You must be an admin to access this page."}),e.jsx(wt,{to:"/login",className:"admin-btn",children:"Go to Login"})]})}):se?e.jsx("div",{className:"admin-page",children:e.jsx("div",{className:"admin-content",children:e.jsxs("div",{className:"admin-loading-state",children:[e.jsx("h2",{children:"Loading admin dashboard..."}),e.jsx("p",{children:"Fetching orders, products, users and summary stats."})]})})}):e.jsxs("div",{className:"admin-page",children:[me&&e.jsxs("div",{className:`notification ${me.type}`,children:[e.jsx("span",{children:me.message}),e.jsx("button",{onClick:As,children:e.jsx(ke,{size:16})})]}),e.jsxs("div",{className:"admin-mobile-topbar",children:[e.jsx("button",{type:"button",className:"admin-mobile-menu-btn",onClick:()=>es(t=>!t),"aria-label":"Toggle admin menu",children:Ne?e.jsx(ke,{size:20}):e.jsx(Ja,{size:20})}),e.jsx("h2",{children:"Admin Panel"})]}),Ne&&e.jsx("button",{type:"button",className:"admin-sidebar-overlay","aria-label":"Close admin menu",onClick:()=>es(!1)}),e.jsxs("div",{className:`admin-sidebar ${Ne?"open":""}`,children:[e.jsx("h2",{children:"Admin Panel"}),e.jsxs("nav",{children:[e.jsxs("div",{className:"sidebar-group",children:[e.jsx("button",{type:"button",className:`sidebar-group-toggle ${be.general?"expanded":""}`,"data-label":"General",onClick:()=>De("general"),children:e.jsx(ta,{size:20})}),be.general&&e.jsxs("div",{className:"sidebar-group-items",children:[e.jsxs("button",{className:d==="dashboard"?"active":"",onClick:()=>ue("dashboard"),children:[e.jsx(ta,{size:20})," Dashboard"]}),e.jsxs("button",{className:d==="orders"?"active":"",onClick:()=>ue("orders"),children:[e.jsx(ba,{size:20})," Orders"]}),e.jsxs("button",{className:d==="offers"?"active":"",onClick:()=>ue("offers"),children:[e.jsx(Nn,{size:20})," Offers"]}),e.jsxs("button",{className:d==="credit-aging"?"active":"",onClick:()=>ue("credit-aging"),children:[e.jsx(fn,{size:20})," Credit Aging"]})]})]}),e.jsxs("div",{className:"sidebar-group",children:[e.jsx("button",{type:"button",className:`sidebar-group-toggle ${be.products?"expanded":""}`,"data-label":"Products",onClick:()=>De("products"),children:e.jsx($s,{size:20})}),be.products&&e.jsxs("div",{className:"sidebar-group-items",children:[e.jsxs("button",{className:d==="products"?"active":"",onClick:()=>ue("products"),children:[e.jsx($s,{size:20})," Products"]}),e.jsxs("button",{className:`${d==="categories"?"active":""} sub-item`,onClick:()=>ue("categories"),children:[e.jsx(sa,{size:18})," Categories"]})]})]}),e.jsxs("div",{className:"sidebar-group",children:[e.jsx("button",{type:"button",className:`sidebar-group-toggle ${be.billing?"expanded":""}`,"data-label":"Billing",onClick:()=>De("billing"),children:e.jsx(Ca,{size:20})}),be.billing&&e.jsxs("div",{className:"sidebar-group-items",children:[e.jsxs("button",{className:d==="billing"?"active":"",onClick:()=>ue("billing"),children:[e.jsx(Ca,{size:20})," Billing"]}),e.jsxs("button",{className:`${d==="view-bills"?"active":""} sub-item`,onClick:()=>ue("view-bills"),children:[e.jsx(za,{size:18})," Bills History"]})]})]}),e.jsxs("div",{className:"sidebar-group",children:[e.jsx("button",{type:"button",className:`sidebar-group-toggle ${be.purchase?"expanded":""}`,"data-label":"Purchase",onClick:()=>De("purchase"),children:e.jsx(Sa,{size:20})}),be.purchase&&e.jsxs("div",{className:"sidebar-group-items",children:[e.jsxs("button",{className:d==="purchases"?"active":"",onClick:()=>ue("purchases"),children:[e.jsx(Sa,{size:20})," Purchases"]}),e.jsxs("button",{className:`${d==="distributors"?"active":""} sub-item`,onClick:()=>ue("distributors"),children:[e.jsx(gn,{size:18})," Distributors"]}),e.jsxs("button",{className:`${d==="stock-ledger"?"active":""} sub-item`,onClick:()=>ue("stock-ledger"),children:[e.jsx(Pa,{size:18})," Stock History"]})]})]}),e.jsxs("div",{className:"sidebar-group",children:[e.jsx("button",{type:"button",className:`sidebar-group-toggle ${be.users?"expanded":""}`,"data-label":"Users",onClick:()=>De("users"),children:e.jsx(aa,{size:20})}),be.users&&e.jsxs("div",{className:"sidebar-group-items",children:[e.jsxs("button",{className:d==="users"?"active":"",onClick:()=>ue("users"),children:[e.jsx(aa,{size:20})," Users"]}),e.jsxs("button",{className:`${d==="credit-khata"?"active":""} sub-item`,onClick:()=>ue("credit-khata"),children:[e.jsx(Yt,{size:18})," Credit Khata"]}),e.jsxs("button",{className:`${d==="password-resets"?"active":""} sub-item`,onClick:()=>ue("password-resets"),children:[e.jsx(_n,{size:18})," Account Actions"]}),e.jsxs("button",{className:`${d==="backup-restore"?"active":""} sub-item`,onClick:()=>ue("backup-restore"),children:[e.jsx(Pa,{size:18})," Backup & Restore"]})]})]}),e.jsx(wt,{to:"/",className:"logout-link",children:e.jsx(Za,{size:20})})]})]}),e.jsxs("div",{className:"admin-content",children:[d==="dashboard"&&e.jsxs("div",{className:"dashboard",children:[e.jsx("h1",{children:"Dashboard"}),e.jsxs("div",{className:"stats-grid",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx(ba,{size:40}),e.jsxs("div",{children:[e.jsx("h3",{children:h.totalOrders}),e.jsx("p",{children:"Total Orders"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx(ta,{size:40}),e.jsxs("div",{children:[e.jsx("h3",{children:st(h.totalRevenue)}),e.jsx("p",{children:"Total Revenue"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx($s,{size:40}),e.jsxs("div",{children:[e.jsx("h3",{children:us}),e.jsxs("p",{children:["Active Products (",$t," inactive)"]})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx(aa,{size:40}),e.jsxs("div",{children:[e.jsx("h3",{children:bs.length}),e.jsx("p",{children:"Customers"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx(Ua,{size:40}),e.jsxs("div",{children:[e.jsx("h3",{children:Lt.length}),e.jsx("p",{children:"Pending Orders"})]})]})]}),e.jsxs("div",{className:"dashboard-panels",children:[e.jsxs("div",{className:"dashboard-panel",children:[e.jsx("div",{className:"dashboard-panel-head",children:e.jsx("h3",{children:"Quick Actions"})}),e.jsxs("div",{className:"dashboard-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>ue("orders"),children:"Manage Orders"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("products"),children:"Manage Products"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("billing"),children:"Create Bill"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("credit-khata"),children:"Credit Khata"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("purchases"),children:"Purchases"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("backup-restore"),children:"Backup & Restore"})]})]}),e.jsxs("div",{className:"dashboard-panel",children:[e.jsxs("div",{className:"dashboard-panel-head",children:[e.jsx("h3",{children:"Low Stock (≤ 10)"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("products"),children:"Open Products"})]}),jt.length===0?e.jsx("p",{className:"dashboard-empty",children:"No low stock products."}):e.jsx("div",{className:"dashboard-list",children:jt.map(t=>e.jsxs("div",{className:"dashboard-list-row",children:[e.jsx("span",{children:t.name}),e.jsx("strong",{children:Te(t.stock,0)})]},t.id))})]}),e.jsxs("div",{className:"dashboard-panel",children:[e.jsxs("div",{className:"dashboard-panel-head",children:[e.jsx("h3",{children:"Recent Orders"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("orders"),children:"View All"})]}),Ds.length===0?e.jsx("p",{className:"dashboard-empty",children:"No orders yet."}):e.jsx("div",{className:"dashboard-list",children:Ds.map(t=>e.jsxs("div",{className:"dashboard-list-row",children:[e.jsx("span",{children:t.order_number||`#${t.id}`}),e.jsx("span",{children:new Date(t.created_at||Date.now()).toLocaleDateString()}),e.jsx("span",{children:H(t.total_amount||0)})]},t.id))})]}),e.jsxs("div",{className:"dashboard-panel",children:[e.jsxs("div",{className:"dashboard-panel-head",children:[e.jsx("h3",{children:"Recent Customers"}),e.jsx("button",{className:"admin-btn",onClick:()=>ue("users"),children:"Open Users"})]}),gt.length===0?e.jsx("p",{className:"dashboard-empty",children:"No customers found."}):e.jsx("div",{className:"dashboard-list",children:gt.map(t=>e.jsxs("div",{className:"dashboard-list-row",children:[e.jsx("span",{children:t.name||"-"}),e.jsx("span",{children:t.phone||t.email||"-"}),e.jsx(wt,{className:"action-btn credit",to:`/admin/users/${t.id}/credit?returnTab=dashboard`,title:"Open credit history",children:e.jsx(Yt,{size:14})})]},t.id))})]})]})]}),d==="products"&&e.jsxs("div",{className:"products-management",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h1",{children:"Products Management"}),e.jsxs("div",{className:"products-actions",children:[e.jsxs("div",{className:"view-toggle",children:[e.jsx("button",{className:`admin-btn ${Ae==="table"?"primary":""}`,onClick:()=>_s("table"),children:"Table"}),e.jsx("button",{className:`admin-btn ${Ae==="grid"?"primary":""}`,onClick:()=>_s("grid"),children:"Grid"})]}),e.jsxs("button",{className:"admin-btn primary",onClick:Tt,children:[e.jsx(Me,{size:20})," Add Product"]}),e.jsxs("div",{className:"products-io-icons",children:[e.jsx("button",{type:"button",className:"products-icon-btn",onClick:()=>ss(!0),disabled:Ve,title:"Export products","aria-label":"Export products",children:e.jsx(Ma,{size:16})}),e.jsx("button",{type:"button",className:"products-icon-btn",onClick:Ut,disabled:Ve,title:"Import products","aria-label":"Import products",children:e.jsx(jn,{size:16})}),e.jsx("button",{type:"button",className:"products-icon-btn",onClick:Qt,disabled:Ve||!(pe!=null&&pe.batch_id),title:"Confirm import","aria-label":"Confirm import",children:e.jsx(ia,{size:16})})]})]})]}),e.jsxs("div",{className:"products-import-export-card",children:[e.jsxs("div",{className:"products-import-controls",children:[e.jsx("input",{ref:gs,type:"file",accept:".csv,.xlsx,.xls",onChange:qt,disabled:Ve,style:{display:"none"}}),e.jsx("span",{children:Os?`Selected: ${Os.name}`:"No file selected"})]}),(pe==null?void 0:pe.summary)&&e.jsxs("div",{className:"products-import-preview-summary",children:[e.jsxs("span",{children:["Creates: ",pe.summary.creates]}),e.jsxs("span",{children:["Updates: ",pe.summary.updates]}),e.jsxs("span",{children:["Errors: ",pe.summary.errors]}),e.jsxs("span",{children:["Needs Choice: ",pe.summary.needs_confirmation||0]}),e.jsxs("span",{children:["Expires: ",new Date(pe.expires_at).toLocaleString()]})]}),Array.isArray(pe==null?void 0:pe.preview)&&pe.preview.length>0&&e.jsxs("div",{className:"products-import-preview-table-wrap",children:[e.jsxs("table",{className:"products-import-preview-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Row"}),e.jsx("th",{children:"Action"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Allow"}),e.jsx("th",{children:"Details"})]})}),e.jsx("tbody",{children:pe.preview.slice(0,25).map(t=>{var o,j;return e.jsxs("tr",{children:[e.jsx("td",{children:t.row}),e.jsx("td",{children:t.action}),e.jsx("td",{children:t.status}),e.jsx("td",{children:t.status==="needs_confirmation"?e.jsx("input",{type:"checkbox",checked:dt.includes(Number(t.row)),onChange:f=>{const le=Number(t.row);zs(fe=>f.target.checked?Array.from(new Set([...fe,le])):fe.filter(qe=>qe!==le))}}):"-"}),e.jsx("td",{children:(o=t.errors)!=null&&o.length?t.errors.join("; "):(j=t.warnings)!=null&&j.length?t.warnings.join("; "):"Ready"})]},`preview-${t.row}`)})})]}),pe.preview.length>25&&e.jsxs("p",{className:"products-import-preview-note",children:["Showing first 25 rows of ",pe.preview.length,". Confirm applies full validated batch."]})]})]}),Ae==="table"?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"products-table-toolbar",children:[e.jsx("input",{type:"text",className:"products-table-search",placeholder:"Search by name, SKU, barcode, category, brand...",value:it,onChange:t=>Qe(t.target.value)}),e.jsxs("select",{className:"products-table-filter",value:Ss,onChange:t=>ge(t.target.value),children:[e.jsx("option",{value:"",children:"All Categories"}),xt.map(t=>e.jsx("option",{value:t,children:t},`filter-${t}`))]}),e.jsxs("select",{className:"products-table-filter",value:$e,onChange:t=>Le(t.target.value),children:[e.jsx("option",{value:"all",children:"All Status"}),e.jsx("option",{value:"active",children:"Active"}),e.jsx("option",{value:"inactive",children:"Inactive"})]}),e.jsxs("label",{className:"products-table-filter products-table-checkbox",children:[e.jsx("input",{type:"checkbox",checked:Ke,onChange:t=>Rs(t.target.checked)}),"Low Stock"]}),e.jsxs("span",{className:"products-table-count",children:["Rows: ",Gs.length]})]}),e.jsx("div",{className:"products-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsxs("th",{className:"sortable",onClick:()=>Oe("name"),children:["Name",Ie("name")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("brand"),children:["Brand",Ie("brand")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("category"),children:["Category",Ie("category")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("price"),children:["Price",Ie("price")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("mrp"),children:["MRP",Ie("mrp")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("stock"),children:["Stock",Ie("stock")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("sku"),children:["SKU",Ie("sku")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("barcode"),children:["Barcode",Ie("barcode")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("is_active"),children:["Status",Ie("is_active")]}),e.jsx("th",{children:"Description"}),e.jsx("th",{children:"Content"}),e.jsx("th",{children:"Color"}),e.jsx("th",{children:"UOM"}),e.jsx("th",{children:"Expiry"}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("defaultDiscount"),children:["Discount",Ie("defaultDiscount")]}),e.jsx("th",{children:"Disc Type"}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("id"),children:["ID",Ie("id")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("created_at"),children:["Created",Ie("created_at")]}),e.jsxs("th",{className:"sortable",onClick:()=>Oe("src"),children:["Src",Ie("src")]}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:Gs.map(t=>{const o=ct===t.id;return e.jsxs("tr",{children:[e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.name,onChange:j=>Ce("name",j.target.value)}):t.name}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.brand,onChange:j=>Ce("brand",j.target.value)}):t.brand||"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",list:"admin-product-category-list",value:ae.category,onChange:j=>Ce("category",j.target.value)}):t.category}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",type:"number",min:"0",step:"0.01",value:ae.price,onChange:j=>Ce("price",j.target.value)}):st(t.price)}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",type:"number",min:"0",step:"0.01",value:ae.mrp,onChange:j=>Ce("mrp",j.target.value)}):st(t.mrp)}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",type:"number",min:"0",step:"1",value:ae.stock,onChange:j=>Ce("stock",j.target.value)}):e.jsx("span",{className:t.stock<10?"low-stock":"",children:t.stock})}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.sku,onChange:j=>Ce("sku",j.target.value)}):t.sku||"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.barcode,onChange:j=>Ce("barcode",j.target.value)}):t.barcode||"-"}),e.jsx("td",{children:o?e.jsxs("select",{className:"table-edit-input",value:ae.is_active?"1":"0",onChange:j=>Ce("is_active",j.target.value==="1"),children:[e.jsx("option",{value:"1",children:"Active"}),e.jsx("option",{value:"0",children:"Inactive"})]}):Number(t.is_active??1)===1?"Active":"Inactive"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.description,onChange:j=>Ce("description",j.target.value)}):e.jsx("span",{className:"description-snippet",title:t.description||"-",children:t.description||"-"})}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.content,onChange:j=>Ce("content",j.target.value)}):t.content||"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.color,onChange:j=>Ce("color",j.target.value)}):t.color||"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.uom,onChange:j=>Ce("uom",j.target.value)}):t.uom||"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",type:"date",value:ae.expiry_date,onChange:j=>Ce("expiry_date",j.target.value)}):t.expiry_date?new Date(t.expiry_date).toLocaleDateString():"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",type:"number",min:"0",step:"0.01",value:ae.defaultDiscount,onChange:j=>Ce("defaultDiscount",j.target.value)}):Te(t.defaultDiscount,0)}),e.jsx("td",{children:o?e.jsxs("select",{className:"table-edit-input",value:ae.discountType,onChange:j=>Ce("discountType",j.target.value),children:[e.jsx("option",{value:"fixed",children:"fixed"}),e.jsx("option",{value:"percentage",children:"percentage"})]}):t.discountType||"fixed"}),e.jsx("td",{children:t.id}),e.jsx("td",{children:t.created_at?new Date(t.created_at).toLocaleDateString():"-"}),e.jsx("td",{children:o?e.jsx("input",{className:"table-edit-input",value:ae.image,onChange:j=>Ce("image",j.target.value)}):e.jsx("span",{className:"src-cell",title:t.image||"-",children:t.image||"-"})}),e.jsx("td",{children:o?e.jsxs("div",{className:"table-edit-actions",children:[e.jsx("button",{className:"action-btn edit",onClick:()=>Rt(t),disabled:cs,children:cs?"...":"Save"}),e.jsx("button",{className:"action-btn delete",onClick:vt,disabled:cs,children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"action-btn edit",onClick:()=>bt(t),title:"Inline edit",children:e.jsx(rt,{size:16})}),e.jsx("button",{className:"action-btn edit",onClick:()=>pt(t),title:"Advanced edit",children:e.jsx(sa,{size:16})}),e.jsx("button",{className:"action-btn delete",onClick:()=>Ms(t.id),children:e.jsx(ls,{size:16})}),Number(t.is_active??1)===0&&e.jsx("button",{className:"action-btn delete",title:"Permanent delete",onClick:()=>Us(t),children:e.jsx(ke,{size:16})})]})})]},t.id)})})]})})]}):e.jsxs("div",{className:"products-grid-admin",children:[e.jsx("div",{className:"product-admin-card add-product-card",children:Xe?e.jsxs("div",{className:"quick-form",children:[e.jsx("h3",{children:"Quick Add"}),e.jsx("input",{type:"text",placeholder:"Product name",value:ne.name,onChange:t=>Fe(o=>({...o,name:t.target.value}))}),e.jsx("input",{type:"text",list:"admin-product-category-list",placeholder:"Category",value:ne.category,onChange:t=>Fe(o=>({...o,category:t.target.value}))}),e.jsx("input",{type:"number",placeholder:"Price",min:"0",step:"0.01",value:ne.price,onChange:t=>Fe(o=>({...o,price:t.target.value}))}),e.jsx("input",{type:"number",placeholder:"Stock",min:"0",step:"1",value:ne.stock,onChange:t=>Fe(o=>({...o,stock:t.target.value}))}),e.jsx("input",{type:"text",placeholder:"Image URL (optional)",value:ne.image,onChange:t=>Fe(o=>({...o,image:t.target.value}))}),e.jsxs("div",{className:"quick-form-actions",children:[e.jsx("button",{className:"admin-btn",onClick:()=>{oe(!1),ft()},disabled:de,children:"Cancel"}),e.jsx("button",{className:"admin-btn primary",onClick:yt,disabled:de,children:de?"Saving...":"Save"})]})]}):e.jsxs("button",{className:"quick-add-trigger",onClick:()=>oe(!0),children:[e.jsx(Me,{size:18})," Quick Add Product"]})}),Gs.map(t=>{const o=hs===t.id,j=o?{image:Be.image,name:Be.name||t.name,category:Be.category||t.category,brand:t.brand}:t;return e.jsxs("div",{className:"product-admin-card",children:[e.jsx("img",{src:la(j),alt:t.name,className:"product-thumbnail-large",onError:f=>{f.currentTarget.onerror=null,f.currentTarget.src=en(j)}}),o?e.jsxs("div",{className:"quick-form",children:[e.jsx("input",{type:"text",placeholder:"Product name",value:Be.name,onChange:f=>ps(le=>({...le,name:f.target.value}))}),e.jsx("input",{type:"text",list:"admin-product-category-list",placeholder:"Category",value:Be.category,onChange:f=>ps(le=>({...le,category:f.target.value}))}),e.jsx("input",{type:"number",placeholder:"Price",min:"0",step:"0.01",value:Be.price,onChange:f=>ps(le=>({...le,price:f.target.value}))}),e.jsx("input",{type:"number",placeholder:"Stock",min:"0",step:"1",value:Be.stock,onChange:f=>ps(le=>({...le,stock:f.target.value}))}),e.jsx("input",{type:"text",placeholder:"Image URL (optional)",value:Be.image,onChange:f=>ps(le=>({...le,image:f.target.value}))}),e.jsxs("div",{className:"quick-form-actions",children:[e.jsx("button",{className:"admin-btn",onClick:Nt,disabled:de,children:"Cancel"}),e.jsx("button",{className:"admin-btn primary",onClick:()=>It(t),disabled:de,children:de?"Saving...":"Update"})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("h3",{children:t.name}),e.jsx("p",{className:"product-meta",children:t.category}),e.jsx("p",{className:"product-meta",children:st(t.price)}),e.jsxs("p",{className:t.stock<10?"product-stock-label low-stock":"product-stock-label",children:["Stock: ",t.stock]}),e.jsxs("div",{className:"product-card-actions",children:[e.jsx("button",{className:"action-btn edit",onClick:()=>Ot(t),title:"Quick edit",children:e.jsx(rt,{size:16})}),e.jsx("button",{className:"action-btn edit",onClick:()=>pt(t),title:"Advanced edit",children:e.jsx(sa,{size:16})}),e.jsx("button",{className:"action-btn delete",onClick:()=>Ms(t.id),title:"Delete",children:e.jsx(ls,{size:16})})]})]})]},t.id)}),e.jsx("datalist",{id:"admin-product-category-list",children:xt.map(t=>e.jsx("option",{value:t},t))})]})]}),d==="orders"&&e.jsxs("div",{className:"orders-management",children:[e.jsx("h1",{children:"Orders Management"}),e.jsx("div",{className:"orders-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"ID"}),e.jsx("th",{children:"Customer"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Amount"}),e.jsx("th",{children:"Status"}),e.jsx("th",{children:"Actions"}),e.jsx("th",{children:"Date"})]})}),e.jsx("tbody",{children:W.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.id}),e.jsx("td",{children:t.customer_name}),e.jsx("td",{children:t.customer_email}),e.jsx("td",{children:st(t.total_amount)}),e.jsx("td",{children:e.jsx("span",{className:`status ${t.status}`,children:t.status})}),e.jsx("td",{children:t.status==="pending"?e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"admin-btn",onClick:()=>Ye(t.id),children:"Approve"}),e.jsx("button",{className:"admin-btn",onClick:()=>ks(t.id,"cancelled"),children:"Cancel"})]}):e.jsx("span",{style:{opacity:.8},children:"—"})}),e.jsx("td",{children:new Date(t.created_at).toLocaleDateString()})]},t.id))})]})})]}),d==="categories"&&e.jsxs("div",{className:"categories-management",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h1",{children:"Categories Management"}),e.jsxs("button",{className:"admin-btn primary",onClick:()=>u(!0),children:[e.jsx(Me,{size:20})," Manage Categories"]})]}),e.jsx("div",{className:"categories-info",children:e.jsx("p",{children:'Click "Manage Categories" to create, edit, or delete product categories.'})})]}),d==="users"&&e.jsxs("div",{className:"users-management",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h1",{children:"Users Management"}),e.jsxs("button",{className:"admin-btn primary",onClick:Kt,children:[e.jsx(Me,{size:20})," Add Customer"]})]}),e.jsxs("div",{className:"users-group",children:[e.jsxs("h2",{children:["Admins (",qs.length,")"]}),e.jsx("div",{className:"users-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Phone"})]})}),e.jsx("tbody",{children:qs.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",children:"No admins found."})}):qs.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"admin-user-cell",children:[e.jsxs("div",{className:"admin-user-name-cell",children:[t.profile_image&&!Ge[t.id]?e.jsx("img",{src:va(t.profile_image),alt:t.name||"User",className:"admin-user-avatar",onError:()=>Ls(o=>({...o,[t.id]:!0}))}):e.jsx("span",{className:"admin-user-avatar-fallback",children:ds(t.name)}),e.jsx("span",{children:t.name||"-"})]}),e.jsxs("div",{className:"admin-user-meta-row",children:[e.jsxs("span",{className:"admin-user-joined",children:["Joined: ",Ws(t.created_at)]}),e.jsx("div",{className:"admin-user-actions",children:e.jsx("span",{className:"admin-badge",children:"Admin"})})]})]})}),e.jsx("td",{children:t.email||"-"}),e.jsx("td",{children:t.phone||"-"})]},t.id))})]})})]}),e.jsxs("div",{className:"users-group",children:[e.jsxs("h2",{children:["Customers (",bs.length,")"]}),e.jsx("div",{className:"users-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"User"}),e.jsx("th",{children:"Email"}),e.jsx("th",{children:"Phone"})]})}),e.jsx("tbody",{children:bs.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"3",children:"No customers found."})}):bs.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:e.jsxs("div",{className:"admin-user-cell",children:[e.jsxs("div",{className:"admin-user-name-cell",children:[t.profile_image&&!Ge[t.id]?e.jsx("img",{src:va(t.profile_image),alt:t.name||"User",className:"admin-user-avatar",onError:()=>Ls(o=>({...o,[t.id]:!0}))}):e.jsx("span",{className:"admin-user-avatar-fallback",children:ds(t.name)}),e.jsx("span",{children:t.name||"-"})]}),e.jsxs("div",{className:"admin-user-meta-row",children:[e.jsxs("span",{className:"admin-user-joined",children:["Joined: ",Ws(t.created_at)]}),e.jsxs("div",{className:"admin-user-actions",children:[e.jsx(wt,{to:`/admin/users/${t.id}/credit?returnTab=users`,className:"action-btn credit",title:"Credit History",children:e.jsx(Yt,{size:16})}),e.jsx("button",{className:"action-btn edit",onClick:()=>_t(t),title:t.email_verified&&t.phone_verified?"Change user type":"Requires verified email and phone",disabled:!t.email_verified||!t.phone_verified,children:e.jsx(rt,{size:16})}),e.jsx("button",{className:"action-btn delete",onClick:()=>ht(t.id),title:"Delete user",children:e.jsx(ls,{size:16})})]})]})]})}),e.jsx("td",{children:t.email||"-"}),e.jsx("td",{children:t.phone||"-"})]},t.id))})]})})]})]}),d==="backup-restore"&&e.jsxs("div",{className:"users-management",children:[e.jsxs("div",{className:"section-header",children:[e.jsx("h1",{children:"Backup & Restore"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"admin-btn",onClick:ns,disabled:N||Q,children:"Refresh"}),e.jsxs("button",{className:"admin-btn primary",onClick:ut,disabled:Q,children:[e.jsx(Me,{size:20})," Create Backup"]})]})]}),e.jsx("div",{className:"categories-info",children:e.jsx("p",{children:"Restoring data will replace the current database. A pre-restore backup is created automatically."})}),e.jsx("div",{className:"users-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"File"}),e.jsx("th",{children:"Created"}),e.jsx("th",{children:"Size"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:N?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",children:"Loading backups..."})}):O.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:"4",children:"No backups found"})}):O.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.file_name}),e.jsx("td",{children:t.created_at?new Date(t.created_at).toLocaleString():"-"}),e.jsx("td",{children:Kn(t.size_bytes)}),e.jsx("td",{children:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("a",{className:"admin-btn",href:`/api/admin/backup/download/${encodeURIComponent(t.file_name)}`,target:"_blank",rel:"noreferrer",children:"Download"}),e.jsx("button",{className:"admin-btn",onClick:()=>mt(t.file_name),disabled:Q,children:"Restore"})]})})]},t.file_name))})]})})]}),d==="billing"&&e.jsx(In,{}),d==="view-bills"&&e.jsx(zn,{}),d==="distributors"&&e.jsx($n,{user:l}),d==="purchases"&&e.jsx(Ln,{user:l}),d==="stock-ledger"&&e.jsx(Rn,{user:l}),d==="credit-aging"&&e.jsx(On,{user:l}),d==="credit-khata"&&e.jsx(Qn,{user:l}),d==="offers"&&e.jsx(Mn,{}),d==="password-resets"&&e.jsx(Un,{})]}),w&&e.jsx(Fn,{product:ee,onClose:()=>{L(!1),re(null)},onSave:Ps}),b&&z&&e.jsx($a,{open:b,title:`Approve Order ${z.order_number||`#${z.id}`}`,onClose:()=>x(!1),children:p?e.jsx("p",{children:"Loading..."}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Customer: ",z.customer_name," (",z.customer_email,")"]}),e.jsx("div",{style:{maxHeight:300,overflow:"auto",marginTop:8},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Product"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Stock"})]})}),e.jsx("tbody",{children:v.map(t=>e.jsxs("tr",{children:[e.jsx("td",{style:{padding:6},children:t.product_name||t.name}),e.jsx("td",{style:{padding:6},children:t.quantity}),e.jsx("td",{style:{padding:6},children:t.stock!==void 0?t.stock:"—"})]},t.id))})]})}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:12,justifyContent:"flex-end"},children:[e.jsx("button",{className:"admin-btn",onClick:()=>x(!1),disabled:p,children:"Close"}),e.jsx("button",{className:"admin-btn primary",onClick:as,disabled:p,children:"Confirm Approve"})]})]})}),Vs&&e.jsxs($a,{open:Vs,title:"Export Products",onClose:()=>ss(!1),dialogClassName:"export-modal-card",children:[e.jsx("p",{children:"Select format, then confirm export."}),e.jsxs("div",{className:"export-format-toggle-group",children:[e.jsx("button",{className:`admin-btn ${Is==="csv"?"primary":""}`,onClick:()=>ts("csv"),disabled:Ve,children:"CSV (.csv)"}),e.jsx("button",{className:`admin-btn ${Is==="xlsx"?"primary":""}`,onClick:()=>ts("xlsx"),disabled:Ve,children:"Excel (.xlsx)"})]}),e.jsxs("div",{style:{display:"flex",gap:8,marginTop:12,justifyContent:"flex-end"},children:[e.jsx("button",{className:"admin-btn",onClick:()=>ss(!1),disabled:Ve,children:"Cancel"}),e.jsx("button",{className:"admin-btn primary",onClick:Ys,disabled:Ve,children:"Confirm Export"})]})]}),xe&&e.jsx(Tn,{onClose:()=>u(!1)}),_&&e.jsx(Ta,{user:_,onClose:()=>{J(null),P(!1),ce(!1)},onSave:Ct}),B&&te&&e.jsx(Ta,{isCreate:!0,onClose:()=>{P(!1),ce(!1)},onSave:Vt})]})}export{mr as default};
