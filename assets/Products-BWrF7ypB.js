import{c as fe,u as ke,r as o,p as Ce,b as we,j as e,d as Me}from"./index-B15Jacgc.js";import{u as Pe,g as Fe,M as oe,a as R}from"./MobileBottomSheet-C4-vX-mw.js";import{f as q,g as Ie}from"./formatters-C_RfwIqz.js";import{S as qe}from"./search-BblXmoKy.js";import{F as K}from"./filter-BDtCe5nF.js";import{P as ue}from"./plus-DMW20Fof.js";const le=fe("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),h=a=>String(a||"").trim().toLowerCase(),de=a=>a?12:16,Ae=a=>{const u=q(Math.abs(a));return e.jsx("span",{className:Ie(a),children:u})},Ee=a=>{const u=h(a==null?void 0:a.name),y=h(a==null?void 0:a.brand);return`${u}|${y}`},$e=(a,u)=>{const y=[String(a.content||"").trim(),String(a.color||"").trim()].filter(Boolean);if(y.length>0)return y.join(" / ");const g=String(a.sku||"").trim();return g||`Option ${u+1}`};function he({src:a,alt:u,className:y,fallbackProduct:g,...F}){const[A,k]=o.useState(()=>a||R(g));return o.useEffect(()=>{let v=!0,c="";return(async()=>{if(!a){v&&k(R(g));return}try{const x=await Me(a);if(!v){x.revoke&&x.src&&URL.revokeObjectURL(x.src);return}x.revoke&&x.src&&(c=x.src),k(x.src||R(g))}catch{v&&k(R(g))}})(),()=>{v=!1,c&&URL.revokeObjectURL(c)}},[a,g]),e.jsx("img",{src:A,alt:u,className:y,...F,onError:v=>{v.currentTarget.onerror=null,v.currentTarget.src=R(g)}})}function me({family:a,selectedVariationId:u,onSelectVariation:y,onIncreaseQty:g,onDecreaseQty:F,cartQtyById:A,buttonStatus:k,showImage:v=!1}){var f;const c=a.variations.find(b=>b.id===u)||a.variations[0];if(!c)return null;const M=a.variations.length>1,x=new Set,E=a.variations.map((b,I)=>{let C=$e(b,I);const L=h(C);return x.has(L)&&(C=`${C} (${I+1})`),x.add(L),{variation:b,label:C}}),N=Number(A[c.id]||0),S=Number(c.stock||0),j=S>0&&N>=S,$=k[c.id]==="added";return e.jsxs("div",{className:"product-detail-view",onClick:b=>b.stopPropagation(),role:"presentation",children:[v&&e.jsx("div",{className:"detail-mobile-image-wrap",children:e.jsx(he,{src:c.image,alt:a.name,className:"detail-mobile-image",fallbackProduct:c.raw})}),e.jsx("p",{className:"detail-description",children:a.description||"No additional description available."}),M?e.jsx("div",{className:"variation-list",children:E.map(({variation:b,label:I})=>{const C=b.id===c.id;return e.jsxs("button",{type:"button",className:`variation-chip ${C?"active":""}`,onClick:()=>y(a.id,b.id),children:[e.jsx("span",{children:I}),e.jsx("strong",{children:q(Number(b.price||0))})]},b.id)})}):e.jsxs("div",{className:"single-variation-row",children:[e.jsx("span",{children:(f=E[0])==null?void 0:f.label}),e.jsx("strong",{children:q(Number(c.price||0))})]}),e.jsxs("div",{className:"detail-selected-meta",children:[e.jsxs("div",{className:"detail-price-line",children:[e.jsx("span",{children:Ae(Number(c.price||0))}),e.jsxs("small",{children:["/ ",c.uom||"pcs"]})]}),c.mrp&&Number(c.mrp)>Number(c.price)&&e.jsxs("small",{className:"mrp-price",children:["MRP: ",q(c.mrp)]}),e.jsxs("div",{className:"detail-stock-line",children:[e.jsx("span",{className:S>0?"in-stock":"out-of-stock",children:S>0?`${S} ${c.uom||"pcs"} in stock`:"Out of stock"}),N>0&&e.jsxs("small",{children:["In cart: ",N]})]})]}),e.jsxs("button",{type:"button",className:"add-to-cart-btn detail-add-btn",onClick:()=>g(a,c),disabled:S===0||j,children:[e.jsx(ue,{size:14}),S===0?"Out of stock":j?"Max in cart":$?"Added!":"Add to cart"]}),e.jsxs("div",{className:"detail-counter-row",children:[e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>F(c),disabled:N<=0,children:"-"}),e.jsx("span",{className:"qty-step-value",children:N}),e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>g(a,c),disabled:S===0||j,children:"+"})]})]})}function Oe({setCartCount:a}){var ce;const u=Pe(),[y,g]=ke(),[F,A]=o.useState([]),[k,v]=o.useState([]),[c,M]=o.useState(y.get("category")||"all"),[x,E]=o.useState(y.get("q")||""),[N,S]=o.useState(y.get("q")||""),[j,$]=o.useState(y.get("sort")||"relevance"),[f,b]=o.useState(y.get("stock")==="1"),[I,C]=o.useState(!0),[L,ge]=o.useState(""),[P,z]=o.useState([]),[U,W]=o.useState(16),[G,X]=o.useState({}),[V,_]=o.useState(null),[xe,Y]=o.useState(!1),[be,pe]=o.useState(null),[Z,ee]=o.useState(null),[ye,te]=o.useState({});o.useEffect(()=>{Ne(),je(),ve()},[]),o.useEffect(()=>{const t=setTimeout(()=>S(x),250);return()=>clearTimeout(t)},[x]),o.useEffect(()=>{const t=new URLSearchParams;c!=="all"&&t.set("category",c),N&&t.set("q",N),j!=="relevance"&&t.set("sort",j),f&&t.set("stock","1"),g(t,{replace:!0})},[c,N,j,f,g]),o.useEffect(()=>{W(de(u))},[c,N,j,f,u]),o.useEffect(()=>{if(!V)return;const t=setTimeout(()=>_(null),2200);return()=>clearTimeout(t)},[V]);const Ne=async()=>{try{const t=await Ce.getAll();A(Array.isArray(t)?t:[]),C(!1)}catch(t){console.error("Error fetching products:",t),ge("Failed to load products. Please refresh and try again."),C(!1)}},je=async()=>{try{const t=await we.getAll();v(Array.isArray(t)?t:[])}catch(t){console.error("Error fetching categories:",t)}},ve=()=>{try{const t=localStorage.getItem("barman_cart");if(!t)return;const s=JSON.parse(t),n=Array.isArray(s)?s:[];z(n),a(n.reduce((d,l)=>d+Number(l.quantity||0),0))}catch(t){console.error("Invalid cart data in localStorage, resetting cart",t),localStorage.removeItem("barman_cart"),z([]),a(0)}},O=o.useMemo(()=>P.reduce((t,s)=>(t[s.id]=Number(s.quantity||0),t),{}),[P]),T=o.useMemo(()=>{const t=new Map;return F.forEach(s=>{const n=Ee(s),d=[h(s==null?void 0:s.name),h(s==null?void 0:s.brand),Number((s==null?void 0:s.price)||0).toFixed(2),Number((s==null?void 0:s.mrp)||(s==null?void 0:s.price)||0).toFixed(2),h(s==null?void 0:s.content),h(s==null?void 0:s.color)].join("|");t.has(n)||t.set(n,{id:n,key:n,name:String(s.name||"Product").trim()||"Product",brand:String(s.brand||"").trim(),category:String(s.category||"").trim(),description:String(s.description||"").trim(),variations:[]});const l=t.get(n),r=l.variations.find(i=>i.signature===d);r?(r.stock=Number(r.stock||0)+Number(s.stock||0),!r.description&&s.description&&(r.description=String(s.description||"").trim())):l.variations.push({id:s.id,signature:d,name:String(s.name||"").trim(),brand:String(s.brand||"").trim(),category:String(s.category||"").trim(),description:String(s.description||"").trim(),color:String(s.color||"").trim(),content:String(s.content||"").trim(),sku:String(s.sku||"").trim(),price:Number(s.price||0),mrp:Number(s.mrp||0),stock:Number(s.stock||0),uom:String(s.uom||"pcs").trim(),image:Fe(s),raw:s}),!l.description&&s.description&&(l.description=String(s.description||"").trim()),!l.category&&s.category&&(l.category=String(s.category||"").trim())}),[...t.values()].map(s=>{const n=[...s.variations].sort((r,i)=>r.price!==i.price?r.price-i.price:String(r.content||"").localeCompare(String(i.content||""))),d=n.reduce((r,i)=>Math.min(r,Number(i.price||0)),1/0),l=n.reduce((r,i)=>r+Number(i.stock||0),0);return{...s,variations:n,minPrice:Number.isFinite(d)?d:0,totalStock:l}})},[F]),se=o.useMemo(()=>k.length>0?k.map(s=>({id:s.id||s.name,name:String(s.name||"").trim()})).filter(s=>s.name):Array.from(new Set(T.map(s=>String(s.category||"").trim()).filter(Boolean))).map(s=>({id:s,name:s})),[k,T]),w=o.useMemo(()=>{const t=h(N),s=h(c);let n=T.filter(r=>{const i=h(r.category),p=r.variations.some(m=>Number(m.stock||0)>0);return s!=="all"&&i!==s||f&&!p?!1:t?[r.name,r.brand,r.category,r.description,...r.variations.map(m=>`${m.content} ${m.color} ${m.sku}`)].map(m=>h(m)).join(" ").includes(t):!0});const d={"price-asc":(r,i)=>Number(r.minPrice||0)-Number(i.minPrice||0),"price-desc":(r,i)=>Number(i.minPrice||0)-Number(r.minPrice||0),"stock-desc":(r,i)=>Number(i.totalStock||0)-Number(r.totalStock||0),newest:(r,i)=>Number(Math.max(...i.variations.map(p=>Number(p.id||0))))-Number(Math.max(...r.variations.map(p=>Number(p.id||0)))),relevance:(r,i)=>{if(!t)return String(r.name||"").localeCompare(String(i.name||""));const p=h(r.name),D=h(i.name),m=p.startsWith(t)?1:0,H=D.startsWith(t)?1:0;return m!==H?H-m:p.localeCompare(D)}},l=d[j]||d.relevance;return n=[...n].sort(l),n},[T,N,c,j,f]);o.useEffect(()=>{te(t=>{const s={...t};let n=!1;return w.forEach(d=>{if(!d.variations.length)return;const l=s[d.id],r=d.variations.some(i=>i.id===l);(!l||!r)&&(s[d.id]=d.variations[0].id,n=!0)}),n?s:t})},[w]);const re=o.useMemo(()=>w.slice(0,U),[w,U]),Se=U<w.length,ne=t=>{const s=ye[t.id];return t.variations.find(n=>n.id===s)||t.variations[0]},ie=(t,s)=>{te(n=>({...n,[t]:s}))},B=(t,s)=>{if(!s)return;const n=Number(s.stock||0);if(n<=0){_({type:"error",message:"This variation is out of stock."});return}const d=P.find(i=>i.id===s.id);if(Number((d==null?void 0:d.quantity)||0)>=n){_({type:"error",message:"Reached max quantity available in stock."});return}let r;d?r=P.map(i=>i.id===s.id?{...i,quantity:Math.min(Number(i.quantity||0)+1,n)}:i):r=[...P,{id:s.id,name:t.name,brand:t.brand,category:s.category,content:s.content,color:s.color,image:s.image,price:Number(s.price||0),stock:n,uom:s.uom||"pcs",quantity:1}],z(r),localStorage.setItem("barman_cart",JSON.stringify(r)),a(r.reduce((i,p)=>i+Number(p.quantity||0),0)),X(i=>({...i,[s.id]:"added"})),setTimeout(()=>{X(i=>({...i,[s.id]:""}))},900)},J=t=>{if(!t)return;const s=P.find(l=>l.id===t.id);if(!s)return;const n=Math.max(0,Number(s.quantity||0)-1),d=n===0?P.filter(l=>l.id!==t.id):P.map(l=>l.id===t.id?{...l,quantity:n}:l);z(d),localStorage.setItem("barman_cart",JSON.stringify(d)),a(d.reduce((l,r)=>l+Number(r.quantity||0),0))},ae=t=>{if(u){ee(t);return}pe(s=>s===t?null:t)},Q=o.useMemo(()=>w.find(t=>t.id===Z)||null,[w,Z]);return I?e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading products..."})]}):e.jsxs("div",{className:"products-page",children:[V&&e.jsx("div",{className:`products-notice ${V.type==="error"?"error":"info"}`,children:V.message}),e.jsxs("div",{className:"products-header fade-in-up",children:[e.jsx("h1",{children:"Our Collection"}),e.jsx("p",{children:"Discover premium products for your needs"})]}),L&&e.jsx("div",{className:"products-error",children:L}),e.jsxs("div",{className:"products-controls sticky-controls slide-in-left",children:[e.jsx("div",{className:"search-row",children:e.jsxs("div",{className:"search-input-wrap",children:[e.jsx(qe,{size:18}),e.jsx("input",{type:"text",placeholder:"Search by name, content, color...",value:x,onChange:t=>E(t.target.value),"aria-label":"Search products"})]})}),u?e.jsxs("div",{className:"mobile-filter-launch-row",children:[e.jsxs("button",{type:"button",className:"mobile-filter-btn",onClick:()=>Y(!0),children:[e.jsx(K,{size:16})," Filters & Sort"]}),e.jsxs("label",{className:"stock-only-toggle",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:t=>b(t.target.checked)}),"In-stock only"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-header",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"Category"})]}),e.jsxs("div",{className:"category-buttons",children:[e.jsx("button",{type:"button",className:`category-btn ${c==="all"?"active":""}`,onClick:()=>M("all"),children:"All"}),se.map(t=>e.jsx("button",{type:"button",className:`category-btn ${h(c)===h(t.name)?"active":""}`,onClick:()=>M(t.name),children:t.name},t.id))]})]}),e.jsxs("div",{className:"sort-row",children:[e.jsxs("div",{className:"sort-group",children:[e.jsx(le,{size:16}),e.jsxs("select",{value:j,onChange:t=>$(t.target.value),"aria-label":"Sort products",children:[e.jsx("option",{value:"relevance",children:"Relevance"}),e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"price-asc",children:"Price: Low to High"}),e.jsx("option",{value:"price-desc",children:"Price: High to Low"}),e.jsx("option",{value:"stock-desc",children:"Stock: High to Low"})]})]}),e.jsxs("label",{className:"stock-only-toggle",children:[e.jsx("input",{type:"checkbox",checked:f,onChange:t=>b(t.target.checked)}),"In-stock only"]})]})]})]}),e.jsx("div",{className:"result-summary",children:e.jsxs("span",{children:["Showing ",re.length," of ",w.length," products"]})}),e.jsx("div",{className:"products-grid",children:re.map((t,s)=>{const n=ne(t),d=t.variations.some(m=>Number(m.stock||0)>0),l=t.variations.reduce((m,H)=>m+Number(O[H.id]||0),0),r=!u&&be===t.id,i=Number(O[n.id]||0),p=Number(n.stock||0),D=p>0&&i>=p;return e.jsxs("div",{className:"product-card fade-in-up compact-mobile-card family-card",style:{animationDelay:`${s*.04}s`},onClick:()=>ae(t.id),onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&ae(t.id)},role:"button",tabIndex:0,children:[e.jsxs("div",{className:"product-image",children:[e.jsx(he,{src:n.image,alt:t.name,loading:"lazy",fallbackProduct:n.raw}),e.jsx("div",{className:"price-corner-tag",children:t.variations.length>1?`From ${q(Number(t.minPrice||0))}`:q(Number(n.price||0))})]}),e.jsxs("div",{className:"product-info",children:[e.jsx("h3",{className:"product-name",children:t.name}),e.jsxs("div",{className:"product-footer compact",children:[e.jsxs("div",{className:"product-stock",children:[e.jsx("span",{className:d?"in-stock":"out-of-stock",children:d?`${t.variations.length} options`:"Out of stock"}),l>0&&e.jsxs("small",{className:"cart-qty-indicator",children:["In cart: ",l]})]}),i>0?e.jsxs("div",{className:"card-qty-counter",onClick:m=>m.stopPropagation(),children:[e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>J(n),children:"-"}),e.jsx("span",{className:"qty-step-value",children:i}),e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>B(t,n),disabled:p===0||D,children:"+"})]}):e.jsxs("button",{type:"button",className:"add-to-cart-btn",onClick:m=>{m.stopPropagation(),B(t,n)},disabled:p===0,children:[e.jsx(ue,{size:14})," Add"]})]}),r&&e.jsx(me,{family:t,selectedVariationId:n.id,onSelectVariation:ie,onIncreaseQty:B,onDecreaseQty:J,cartQtyById:O,buttonStatus:G,showImage:!1})]})]},t.id)})}),Se&&e.jsx("div",{className:"load-more-wrap",children:e.jsx("button",{type:"button",className:"load-more-btn",onClick:()=>W(t=>t+de(u)),children:"Load More"})}),w.length===0&&e.jsxs("div",{className:"no-products",children:[e.jsx("p",{children:"No products matched your filters."}),e.jsx("button",{type:"button",className:"reset-filters-btn",onClick:()=>{M("all"),E(""),$("relevance"),b(!1)},children:"Reset Filters"})]}),u&&e.jsxs(oe,{open:xe,onClose:()=>Y(!1),title:"Filter Products",className:"products-filter-sheet",children:[e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-header",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"Category"})]}),e.jsxs("div",{className:"category-buttons",children:[e.jsx("button",{type:"button",className:`category-btn ${c==="all"?"active":""}`,onClick:()=>M("all"),children:"All"}),se.map(t=>e.jsx("button",{type:"button",className:`category-btn ${h(c)===h(t.name)?"active":""}`,onClick:()=>M(t.name),children:t.name},t.id))]})]}),e.jsx("div",{className:"sort-row",children:e.jsxs("div",{className:"sort-group",children:[e.jsx(le,{size:16}),e.jsxs("select",{value:j,onChange:t=>$(t.target.value),"aria-label":"Sort products",children:[e.jsx("option",{value:"relevance",children:"Relevance"}),e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"price-asc",children:"Price: Low to High"}),e.jsx("option",{value:"price-desc",children:"Price: High to Low"}),e.jsx("option",{value:"stock-desc",children:"Stock: High to Low"})]})]})})]}),u&&Q&&e.jsx(oe,{open:!!Q,onClose:()=>ee(null),title:Q.name,className:"products-detail-sheet",children:e.jsx(me,{family:Q,selectedVariationId:(ce=ne(Q))==null?void 0:ce.id,onSelectVariation:ie,onIncreaseQty:B,onDecreaseQty:J,cartQtyById:O,buttonStatus:G,showImage:!0})})]})}export{Oe as default};
