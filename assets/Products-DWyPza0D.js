import{c as ve,u as ke,r as l,p as fe,b as Ce,j as e}from"./index-DzGHLpa5.js";import{u as we,g as Pe,a as me,M as ce}from"./MobileBottomSheet-b-SxHdIS.js";import{f as M,g as Me}from"./formatters-C_RfwIqz.js";import{S as Fe}from"./search-DON9pjVo.js";import{F as K}from"./filter-CvY0UQ-I.js";import{P as ue}from"./plus-O5hZR1MK.js";const oe=ve("SlidersHorizontal",[["line",{x1:"21",x2:"14",y1:"4",y2:"4",key:"obuewd"}],["line",{x1:"10",x2:"3",y1:"4",y2:"4",key:"1q6298"}],["line",{x1:"21",x2:"12",y1:"12",y2:"12",key:"1iu8h1"}],["line",{x1:"8",x2:"3",y1:"12",y2:"12",key:"ntss68"}],["line",{x1:"21",x2:"16",y1:"20",y2:"20",key:"14d8ph"}],["line",{x1:"12",x2:"3",y1:"20",y2:"20",key:"m0wm8r"}],["line",{x1:"14",x2:"14",y1:"2",y2:"6",key:"14e1ph"}],["line",{x1:"8",x2:"8",y1:"10",y2:"14",key:"1i6ji0"}],["line",{x1:"16",x2:"16",y1:"18",y2:"22",key:"1lctlv"}]]),h=a=>String(a||"").trim().toLowerCase(),le=a=>a?12:16,Ie=a=>{const g=M(Math.abs(a));return e.jsx("span",{className:Me(a),children:g})},qe=a=>{const g=h(a==null?void 0:a.name),x=h(a==null?void 0:a.brand);return`${g}|${x}`},Ae=(a,g)=>{const x=[String(a.content||"").trim(),String(a.color||"").trim()].filter(Boolean);if(x.length>0)return x.join(" / ");const k=String(a.sku||"").trim();return k||`Option ${g+1}`};function de({family:a,selectedVariationId:g,onSelectVariation:x,onIncreaseQty:k,onDecreaseQty:Q,cartQtyById:B,buttonStatus:F,showImage:H=!1}){var j;const c=a.variations.find(u=>u.id===g)||a.variations[0];if(!c)return null;const C=a.variations.length>1,w=new Set,I=a.variations.map((u,P)=>{let S=Ae(u,P);const A=h(S);return w.has(A)&&(S=`${S} (${P+1})`),w.add(A),{variation:u,label:S}}),p=Number(B[c.id]||0),N=Number(c.stock||0),y=N>0&&p>=N,q=F[c.id]==="added";return e.jsxs("div",{className:"product-detail-view",onClick:u=>u.stopPropagation(),role:"presentation",children:[H&&e.jsx("div",{className:"detail-mobile-image-wrap",children:e.jsx("img",{src:c.image,alt:a.name,className:"detail-mobile-image",onError:u=>{u.currentTarget.onerror=null,u.currentTarget.src=me(c.raw)}})}),e.jsx("p",{className:"detail-description",children:a.description||"No additional description available."}),C?e.jsx("div",{className:"variation-list",children:I.map(({variation:u,label:P})=>{const S=u.id===c.id;return e.jsxs("button",{type:"button",className:`variation-chip ${S?"active":""}`,onClick:()=>x(a.id,u.id),children:[e.jsx("span",{children:P}),e.jsx("strong",{children:M(Number(u.price||0))})]},u.id)})}):e.jsxs("div",{className:"single-variation-row",children:[e.jsx("span",{children:(j=I[0])==null?void 0:j.label}),e.jsx("strong",{children:M(Number(c.price||0))})]}),e.jsxs("div",{className:"detail-selected-meta",children:[e.jsxs("div",{className:"detail-price-line",children:[e.jsx("span",{children:Ie(Number(c.price||0))}),e.jsxs("small",{children:["/ ",c.uom||"pcs"]})]}),c.mrp&&Number(c.mrp)>Number(c.price)&&e.jsxs("small",{className:"mrp-price",children:["MRP: ",M(c.mrp)]}),e.jsxs("div",{className:"detail-stock-line",children:[e.jsx("span",{className:N>0?"in-stock":"out-of-stock",children:N>0?`${N} ${c.uom||"pcs"} in stock`:"Out of stock"}),p>0&&e.jsxs("small",{children:["In cart: ",p]})]})]}),e.jsxs("button",{type:"button",className:"add-to-cart-btn detail-add-btn",onClick:()=>k(a,c),disabled:N===0||y,children:[e.jsx(ue,{size:14}),N===0?"Out of stock":y?"Max in cart":q?"Added!":"Add to cart"]}),e.jsxs("div",{className:"detail-counter-row",children:[e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>Q(c),disabled:p<=0,children:"-"}),e.jsx("span",{className:"qty-step-value",children:p}),e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>k(a,c),disabled:N===0||y,children:"+"})]})]})}function De({setCartCount:a}){var ae;const g=we(),[x,k]=ke(),[Q,B]=l.useState([]),[F,H]=l.useState([]),[c,C]=l.useState(x.get("category")||"all"),[w,I]=l.useState(x.get("q")||""),[p,N]=l.useState(x.get("q")||""),[y,q]=l.useState(x.get("sort")||"relevance"),[j,u]=l.useState(x.get("stock")==="1"),[P,S]=l.useState(!0),[A,he]=l.useState(""),[f,L]=l.useState([]),[R,W]=l.useState(16),[U,G]=l.useState({}),[E,_]=l.useState(null),[ge,X]=l.useState(!1),[be,xe]=l.useState(null),[Y,Z]=l.useState(null),[pe,ee]=l.useState({});l.useEffect(()=>{ye(),Ne(),je()},[]),l.useEffect(()=>{const t=setTimeout(()=>N(w),250);return()=>clearTimeout(t)},[w]),l.useEffect(()=>{const t=new URLSearchParams;c!=="all"&&t.set("category",c),p&&t.set("q",p),y!=="relevance"&&t.set("sort",y),j&&t.set("stock","1"),k(t,{replace:!0})},[c,p,y,j,k]),l.useEffect(()=>{W(le(g))},[c,p,y,j,g]),l.useEffect(()=>{if(!E)return;const t=setTimeout(()=>_(null),2200);return()=>clearTimeout(t)},[E]);const ye=async()=>{try{const t=await fe.getAll();B(Array.isArray(t)?t:[]),S(!1)}catch(t){console.error("Error fetching products:",t),he("Failed to load products. Please refresh and try again."),S(!1)}},Ne=async()=>{try{const t=await Ce.getAll();H(Array.isArray(t)?t:[])}catch(t){console.error("Error fetching categories:",t)}},je=()=>{try{const t=localStorage.getItem("barman_cart");if(!t)return;const s=JSON.parse(t),n=Array.isArray(s)?s:[];L(n),a(n.reduce((d,o)=>d+Number(o.quantity||0),0))}catch(t){console.error("Invalid cart data in localStorage, resetting cart",t),localStorage.removeItem("barman_cart"),L([]),a(0)}},z=l.useMemo(()=>f.reduce((t,s)=>(t[s.id]=Number(s.quantity||0),t),{}),[f]),D=l.useMemo(()=>{const t=new Map;return Q.forEach(s=>{const n=qe(s),d=[h(s==null?void 0:s.name),h(s==null?void 0:s.brand),Number((s==null?void 0:s.price)||0).toFixed(2),Number((s==null?void 0:s.mrp)||(s==null?void 0:s.price)||0).toFixed(2),h(s==null?void 0:s.content),h(s==null?void 0:s.color)].join("|");t.has(n)||t.set(n,{id:n,key:n,name:String(s.name||"Product").trim()||"Product",brand:String(s.brand||"").trim(),category:String(s.category||"").trim(),description:String(s.description||"").trim(),variations:[]});const o=t.get(n),r=o.variations.find(i=>i.signature===d);r?(r.stock=Number(r.stock||0)+Number(s.stock||0),!r.description&&s.description&&(r.description=String(s.description||"").trim())):o.variations.push({id:s.id,signature:d,name:String(s.name||"").trim(),brand:String(s.brand||"").trim(),category:String(s.category||"").trim(),description:String(s.description||"").trim(),color:String(s.color||"").trim(),content:String(s.content||"").trim(),sku:String(s.sku||"").trim(),price:Number(s.price||0),mrp:Number(s.mrp||0),stock:Number(s.stock||0),uom:String(s.uom||"pcs").trim(),image:Pe(s),raw:s}),!o.description&&s.description&&(o.description=String(s.description||"").trim()),!o.category&&s.category&&(o.category=String(s.category||"").trim())}),[...t.values()].map(s=>{const n=[...s.variations].sort((r,i)=>r.price!==i.price?r.price-i.price:String(r.content||"").localeCompare(String(i.content||""))),d=n.reduce((r,i)=>Math.min(r,Number(i.price||0)),1/0),o=n.reduce((r,i)=>r+Number(i.stock||0),0);return{...s,variations:n,minPrice:Number.isFinite(d)?d:0,totalStock:o}})},[Q]),te=l.useMemo(()=>F.length>0?F.map(s=>({id:s.id||s.name,name:String(s.name||"").trim()})).filter(s=>s.name):Array.from(new Set(D.map(s=>String(s.category||"").trim()).filter(Boolean))).map(s=>({id:s,name:s})),[F,D]),v=l.useMemo(()=>{const t=h(p),s=h(c);let n=D.filter(r=>{const i=h(r.category),b=r.variations.some(m=>Number(m.stock||0)>0);return s!=="all"&&i!==s||j&&!b?!1:t?[r.name,r.brand,r.category,r.description,...r.variations.map(m=>`${m.content} ${m.color} ${m.sku}`)].map(m=>h(m)).join(" ").includes(t):!0});const d={"price-asc":(r,i)=>Number(r.minPrice||0)-Number(i.minPrice||0),"price-desc":(r,i)=>Number(i.minPrice||0)-Number(r.minPrice||0),"stock-desc":(r,i)=>Number(i.totalStock||0)-Number(r.totalStock||0),newest:(r,i)=>Number(Math.max(...i.variations.map(b=>Number(b.id||0))))-Number(Math.max(...r.variations.map(b=>Number(b.id||0)))),relevance:(r,i)=>{if(!t)return String(r.name||"").localeCompare(String(i.name||""));const b=h(r.name),V=h(i.name),m=b.startsWith(t)?1:0,O=V.startsWith(t)?1:0;return m!==O?O-m:b.localeCompare(V)}},o=d[y]||d.relevance;return n=[...n].sort(o),n},[D,p,c,y,j]);l.useEffect(()=>{ee(t=>{const s={...t};let n=!1;return v.forEach(d=>{if(!d.variations.length)return;const o=s[d.id],r=d.variations.some(i=>i.id===o);(!o||!r)&&(s[d.id]=d.variations[0].id,n=!0)}),n?s:t})},[v]);const se=l.useMemo(()=>v.slice(0,R),[v,R]),Se=R<v.length,re=t=>{const s=pe[t.id];return t.variations.find(n=>n.id===s)||t.variations[0]},ne=(t,s)=>{ee(n=>({...n,[t]:s}))},T=(t,s)=>{if(!s)return;const n=Number(s.stock||0);if(n<=0){_({type:"error",message:"This variation is out of stock."});return}const d=f.find(i=>i.id===s.id);if(Number((d==null?void 0:d.quantity)||0)>=n){_({type:"error",message:"Reached max quantity available in stock."});return}let r;d?r=f.map(i=>i.id===s.id?{...i,quantity:Math.min(Number(i.quantity||0)+1,n)}:i):r=[...f,{id:s.id,name:t.name,brand:t.brand,category:s.category,content:s.content,color:s.color,image:s.image,price:Number(s.price||0),stock:n,uom:s.uom||"pcs",quantity:1}],L(r),localStorage.setItem("barman_cart",JSON.stringify(r)),a(r.reduce((i,b)=>i+Number(b.quantity||0),0)),G(i=>({...i,[s.id]:"added"})),setTimeout(()=>{G(i=>({...i,[s.id]:""}))},900)},J=t=>{if(!t)return;const s=f.find(o=>o.id===t.id);if(!s)return;const n=Math.max(0,Number(s.quantity||0)-1),d=n===0?f.filter(o=>o.id!==t.id):f.map(o=>o.id===t.id?{...o,quantity:n}:o);L(d),localStorage.setItem("barman_cart",JSON.stringify(d)),a(d.reduce((o,r)=>o+Number(r.quantity||0),0))},ie=t=>{if(g){Z(t);return}xe(s=>s===t?null:t)},$=l.useMemo(()=>v.find(t=>t.id===Y)||null,[v,Y]);return P?e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner"}),e.jsx("p",{children:"Loading products..."})]}):e.jsxs("div",{className:"products-page",children:[E&&e.jsx("div",{className:`products-notice ${E.type==="error"?"error":"info"}`,children:E.message}),e.jsxs("div",{className:"products-header fade-in-up",children:[e.jsx("h1",{children:"Our Collection"}),e.jsx("p",{children:"Discover premium products for your needs"})]}),A&&e.jsx("div",{className:"products-error",children:A}),e.jsxs("div",{className:"products-controls sticky-controls slide-in-left",children:[e.jsx("div",{className:"search-row",children:e.jsxs("div",{className:"search-input-wrap",children:[e.jsx(Fe,{size:18}),e.jsx("input",{type:"text",placeholder:"Search by name, content, color...",value:w,onChange:t=>I(t.target.value),"aria-label":"Search products"})]})}),g?e.jsxs("div",{className:"mobile-filter-launch-row",children:[e.jsxs("button",{type:"button",className:"mobile-filter-btn",onClick:()=>X(!0),children:[e.jsx(K,{size:16})," Filters & Sort"]}),e.jsxs("label",{className:"stock-only-toggle",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:t=>u(t.target.checked)}),"In-stock only"]})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-header",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"Category"})]}),e.jsxs("div",{className:"category-buttons",children:[e.jsx("button",{type:"button",className:`category-btn ${c==="all"?"active":""}`,onClick:()=>C("all"),children:"All"}),te.map(t=>e.jsx("button",{type:"button",className:`category-btn ${h(c)===h(t.name)?"active":""}`,onClick:()=>C(t.name),children:t.name},t.id))]})]}),e.jsxs("div",{className:"sort-row",children:[e.jsxs("div",{className:"sort-group",children:[e.jsx(oe,{size:16}),e.jsxs("select",{value:y,onChange:t=>q(t.target.value),"aria-label":"Sort products",children:[e.jsx("option",{value:"relevance",children:"Relevance"}),e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"price-asc",children:"Price: Low to High"}),e.jsx("option",{value:"price-desc",children:"Price: High to Low"}),e.jsx("option",{value:"stock-desc",children:"Stock: High to Low"})]})]}),e.jsxs("label",{className:"stock-only-toggle",children:[e.jsx("input",{type:"checkbox",checked:j,onChange:t=>u(t.target.checked)}),"In-stock only"]})]})]})]}),e.jsx("div",{className:"result-summary",children:e.jsxs("span",{children:["Showing ",se.length," of ",v.length," products"]})}),e.jsx("div",{className:"products-grid",children:se.map((t,s)=>{const n=re(t),d=t.variations.some(m=>Number(m.stock||0)>0),o=t.variations.reduce((m,O)=>m+Number(z[O.id]||0),0),r=!g&&be===t.id,i=Number(z[n.id]||0),b=Number(n.stock||0),V=b>0&&i>=b;return e.jsxs("div",{className:"product-card fade-in-up compact-mobile-card family-card",style:{animationDelay:`${s*.04}s`},onClick:()=>ie(t.id),onKeyDown:m=>{(m.key==="Enter"||m.key===" ")&&ie(t.id)},role:"button",tabIndex:0,children:[e.jsxs("div",{className:"product-image",children:[e.jsx("img",{src:n.image,alt:t.name,loading:"lazy",onError:m=>{m.currentTarget.onerror=null,m.currentTarget.src=me(n.raw)}}),e.jsx("div",{className:"price-corner-tag",children:t.variations.length>1?`From ${M(Number(t.minPrice||0))}`:M(Number(n.price||0))})]}),e.jsxs("div",{className:"product-info",children:[e.jsx("h3",{className:"product-name",children:t.name}),e.jsxs("div",{className:"product-footer compact",children:[e.jsxs("div",{className:"product-stock",children:[e.jsx("span",{className:d?"in-stock":"out-of-stock",children:d?`${t.variations.length} options`:"Out of stock"}),o>0&&e.jsxs("small",{className:"cart-qty-indicator",children:["In cart: ",o]})]}),i>0?e.jsxs("div",{className:"card-qty-counter",onClick:m=>m.stopPropagation(),children:[e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>J(n),children:"-"}),e.jsx("span",{className:"qty-step-value",children:i}),e.jsx("button",{type:"button",className:"qty-step-btn",onClick:()=>T(t,n),disabled:b===0||V,children:"+"})]}):e.jsxs("button",{type:"button",className:"add-to-cart-btn",onClick:m=>{m.stopPropagation(),T(t,n)},disabled:b===0,children:[e.jsx(ue,{size:14})," Add"]})]}),r&&e.jsx(de,{family:t,selectedVariationId:n.id,onSelectVariation:ne,onIncreaseQty:T,onDecreaseQty:J,cartQtyById:z,buttonStatus:U,showImage:!1})]})]},t.id)})}),Se&&e.jsx("div",{className:"load-more-wrap",children:e.jsx("button",{type:"button",className:"load-more-btn",onClick:()=>W(t=>t+le(g)),children:"Load More"})}),v.length===0&&e.jsxs("div",{className:"no-products",children:[e.jsx("p",{children:"No products matched your filters."}),e.jsx("button",{type:"button",className:"reset-filters-btn",onClick:()=>{C("all"),I(""),q("relevance"),u(!1)},children:"Reset Filters"})]}),g&&e.jsxs(ce,{open:ge,onClose:()=>X(!1),title:"Filter Products",className:"products-filter-sheet",children:[e.jsxs("div",{className:"filter-row",children:[e.jsxs("div",{className:"filter-header",children:[e.jsx(K,{size:18}),e.jsx("span",{children:"Category"})]}),e.jsxs("div",{className:"category-buttons",children:[e.jsx("button",{type:"button",className:`category-btn ${c==="all"?"active":""}`,onClick:()=>C("all"),children:"All"}),te.map(t=>e.jsx("button",{type:"button",className:`category-btn ${h(c)===h(t.name)?"active":""}`,onClick:()=>C(t.name),children:t.name},t.id))]})]}),e.jsx("div",{className:"sort-row",children:e.jsxs("div",{className:"sort-group",children:[e.jsx(oe,{size:16}),e.jsxs("select",{value:y,onChange:t=>q(t.target.value),"aria-label":"Sort products",children:[e.jsx("option",{value:"relevance",children:"Relevance"}),e.jsx("option",{value:"newest",children:"Newest"}),e.jsx("option",{value:"price-asc",children:"Price: Low to High"}),e.jsx("option",{value:"price-desc",children:"Price: High to Low"}),e.jsx("option",{value:"stock-desc",children:"Stock: High to Low"})]})]})})]}),g&&$&&e.jsx(ce,{open:!!$,onClose:()=>Z(null),title:$.name,className:"products-detail-sheet",children:e.jsx(de,{family:$,selectedVariationId:(ae=re($))==null?void 0:ae.id,onSelectVariation:ne,onIncreaseQty:T,onDecreaseQty:J,cartQtyById:z,buttonStatus:U,showImage:!0})})]})}export{De as default};
