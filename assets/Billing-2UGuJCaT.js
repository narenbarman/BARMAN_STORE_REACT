import{c as ke,d as De,z as ze,r as n,n as A,j as e,X as q,U as Ie,G as re,P as Re,O as Fe}from"./index-DzGHLpa5.js";import{F as ce,b as qe}from"./whatsapp-Bk8hIOWH.js";import{f as d}from"./formatters-C_RfwIqz.js";import{A as $}from"./alert-circle-BCZKslQ1.js";import{D as $e}from"./dollar-sign-pVbPXs6e.js";import{C as Ee}from"./check-circle-CQyckcTV.js";import{P as ie}from"./plus-O5hZR1MK.js";import{T as Me}from"./trash-2-DnurnG26.js";import{R as Te}from"./refresh-cw-CDEAC0yM.js";import{S as Le}from"./save-BTZwz_kZ.js";const Oe=ke("Calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);function ts(){const ue=De(),{billNumber:E}=ze(),[Ue,Ge]=n.useState(!1),[M,T]=n.useState(!1),[L,w]=n.useState(null),[O,U]=n.useState(null),[y,G]=n.useState(""),[Q,J]=n.useState(""),[de,W]=n.useState(""),[B,me]=n.useState({todayBills:0,todayRevenue:0,pendingBalance:0}),[b,S]=n.useState(""),[K,H]=n.useState([]),[he,_]=n.useState(!1),[c,C]=n.useState(null),k=n.useRef(null),[h,D]=n.useState(""),[z,V]=n.useState([]),[pe,f]=n.useState(!1),[xe,I]=n.useState("selecting"),[l,x]=n.useState({name:"",mrp:"",quantity:1,unit:"pcs",discount_percent:0,category:"General"}),R=n.useRef(null),[i,g]=n.useState([]),[v,X]=n.useState(0),[P,Y]=n.useState(0),[Z,ee]=n.useState(""),[se,je]=n.useState(null);n.useEffect(()=>{const s=t=>{k.current&&!k.current.contains(t.target)&&_(!1),R.current&&!R.current.contains(t.target)&&f(!1)};return document.addEventListener("mousedown",s),()=>document.removeEventListener("mousedown",s)},[]),n.useEffect(()=>{const s=localStorage.getItem("user");s&&je(JSON.parse(s)),te()},[]),n.useEffect(()=>{const s=localStorage.getItem("lastBillShare");if(s)try{const t=JSON.parse(s);Date.now()-Number(t.ts||0)<10*60*1e3&&t.text&&(G(t.text),J(t.billNumber||E||""),W(String(t.phone||"")))}catch{}},[E]);const te=async()=>{try{const s=await A.getStats();me({todayBills:s.todayBills||0,todayRevenue:s.todayRevenue||0,pendingBalance:s.pendingBalance||0})}catch(s){console.error("Error loading stats:",s)}};n.useEffect(()=>{b.length>=2?ae():b.length===0&&c?ne():(H([]),_(!1))},[b]);const ae=async()=>{try{const s=await A.searchCustomers(b);H(s),_(!0)}catch(s){console.error("Error searching customers:",s)}},be=s=>{C(s),S(s.name+" - "+s.phone),_(!1)},ne=()=>{C(null),S("")},ge=s=>{const t=s.target.value;S(t),c&&!t.includes(c.phone)&&C(null)},ve=()=>{b.length>=2&&ae()};n.useEffect(()=>{h.length>=2&&xe==="selecting"?le():h.length===0&&(V([]),f(!1))},[h]);const le=async()=>{try{const s=await A.searchProducts(h);V(s),f(!0)}catch(s){console.error("Error searching products:",s)}},ye=s=>{const t=i.findIndex(a=>a.product_id===s.id);if(t>=0){const a=[...i];a[t].quantity+=1,g(a)}else g([...i,{product_id:s.id,name:s.name,mrp:s.price,quantity:1,unit:"pcs",discount_percent:0,category:s.category||"General"}]);D(""),f(!1),I("selecting"),x({name:"",mrp:"",quantity:1,unit:"pcs",discount_percent:0,category:"General"})},fe=()=>{if(!l.name||!l.mrp){w("Please enter item name and MRP");return}g([...i,{product_id:null,name:l.name,mrp:parseFloat(l.mrp),quantity:parseFloat(l.quantity)||1,unit:l.unit,discount_percent:parseFloat(l.discount_percent)||0,isNewItem:!0,category:l.category}]),x({name:"",mrp:"",quantity:1,unit:"pcs",discount_percent:0,category:"General"}),D("")},Ne=s=>{const t=s.target.value;D(t),t.length>=2&&(z.find(r=>r.name.toLowerCase().includes(t.toLowerCase()))||I("new"))},we=()=>{h.length>=2&&le()},N=(s,t,a)=>{const r=[...i];r[s][t]=a,g(r)},Se=s=>{g(i.filter((t,a)=>a!==s))},o=n.useCallback(()=>{let s=0;i.forEach(p=>{const u=parseFloat(p.mrp)||0,m=parseFloat(p.quantity)||0,j=parseFloat(p.discount_percent)||0,F=u*m*j/100;s+=u*m-F});const t=s*P/100,a=s-t,r=a-(parseFloat(v)||0);return{subtotal:s,discountAmount:t,totalAmount:a,balanceAmount:r}},[i,P,v])(),_e=async s=>{s.preventDefault(),w(null),T(!0);try{if(!(c!=null&&c.id))throw new Error("Select an existing customer to create bill");const t={id:c.id,name:c.name,phone:c.phone||"",address:c.address||null};if(i.length===0)throw new Error("Please add at least one item to the bill");const a=i.map(u=>{const m=parseFloat(u.mrp)||0,j=parseFloat(u.quantity)||0,F=parseFloat(u.discount_percent)||0,oe=m*j*F/100,Be=m*j-oe;return{product_id:u.product_id||null,product_name:u.name,mrp:m,qty:j,unit:u.unit||"pcs",discount:oe,amount:Be}}),r=await A.createBill({customer_id:t.id,subtotal:o.subtotal,discount_amount:o.discountAmount,total_amount:o.totalAmount,paid_amount:parseFloat(v)||0,credit_amount:Math.max(0,o.balanceAmount),payment_method:"cash",payment_status:o.balanceAmount>0?"pending":"paid",bill_type:"sales",notes:Z||null,items:a});U(`Bill ${r.bill_number} created successfully!`);const p=Ce({bill_number:r.bill_number,created_at:new Date().toISOString(),customer_name:t.name,customer_phone:t.phone,customer_address:t.address,items:a,total_amount:o.totalAmount,paid_amount:parseFloat(v)||0,credit_amount:Math.max(0,o.balanceAmount),payment_status:o.balanceAmount>0?"pending":"paid"});G(p),J(r.bill_number),localStorage.setItem("lastBillShare",JSON.stringify({text:p,billNumber:r.bill_number,phone:t.phone||"",ts:Date.now()})),W(t.phone||""),setTimeout(()=>{ue(`/billing/${r.bill_number}`)},2e3),g([]),C(null),S(""),X(0),Y(0),ee(""),te()}catch(t){w(t.message)}finally{T(!1)}},Ce=s=>{const t=Array.isArray(s.items)?s.items:[],a=[`BILL #${s.bill_number||""}`,`Date: ${new Date(s.created_at||Date.now()).toLocaleString()}`,`Customer: ${s.customer_name||""}`,s.customer_phone?`Phone: ${s.customer_phone}`:null,s.customer_address?`Address: ${s.customer_address}`:null,"","Items:"];return t.length===0?a.push("- None"):t.forEach(r=>{const p=r.product_name||r.name||"Item",u=Number(r.qty||r.quantity||0),m=r.unit||"",j=Number(r.amount||0);a.push(`- ${p} ${u}${m?" "+m:""} : Rs ${j}`)}),a.push(""),a.push(`Total: Rs ${Number(s.total_amount||0)}`),a.push(`Paid: Rs ${Number(s.paid_amount||0)}`),a.push(`Credit: Rs ${Number(s.credit_amount||0)}`),a.push(`Status: ${s.payment_status||""}`),a.push(""),a.push(`Visit online: ${Fe}`),a.filter(Boolean).join(`
`)},Pe=async()=>{if(y)try{await navigator.clipboard.writeText(y),alert("Bill text copied.")}catch{alert("Failed to copy bill text.")}},Ae=()=>qe({phone:de,text:y});return!se||se.role!=="admin"?e.jsx("div",{className:"billing-page",children:e.jsxs("div",{className:"access-denied",children:[e.jsx($,{size:48}),e.jsx("h2",{children:"Access Denied"}),e.jsx("p",{children:"Only administrators can access billing."})]})}):e.jsxs("div",{className:"billing-page",children:[e.jsxs("div",{className:"billing-header fade-in-up",children:[e.jsx("h1",{children:"Bill Generation"}),e.jsx("p",{children:"Create bills and manage customer transactions"}),e.jsxs("div",{className:"stats-row",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx(ce,{size:24}),e.jsxs("div",{className:"stat-info",children:[e.jsx("span",{className:"stat-value",children:B.todayBills}),e.jsx("span",{className:"stat-label",children:"Today's Bills"})]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx($e,{size:24}),e.jsxs("div",{className:"stat-info",children:[e.jsx("span",{className:"stat-value",children:d(B.todayRevenue)}),e.jsx("span",{className:"stat-label",children:"Today's Revenue"})]})]}),e.jsxs("div",{className:"stat-card warning",children:[e.jsx($,{size:24}),e.jsxs("div",{className:"stat-info",children:[e.jsx("span",{className:"stat-value",children:d(B.pendingBalance)}),e.jsx("span",{className:"stat-label",children:"Pending Balance"})]})]})]})]}),L&&e.jsxs("div",{className:"alert error fade-in-up",children:[e.jsx($,{size:20}),e.jsx("span",{children:L}),e.jsx("button",{onClick:()=>w(null),children:e.jsx(q,{size:16})})]}),O&&e.jsxs("div",{className:"alert success fade-in-up",children:[e.jsx(Ee,{size:20}),e.jsx("span",{children:O}),e.jsx("button",{onClick:()=>U(null),children:e.jsx(q,{size:16})})]}),y&&e.jsxs("div",{className:"share-panel fade-in-up",children:[e.jsx("div",{className:"share-header",children:e.jsxs("strong",{children:["Share Bill ",Q?`#${Q}`:""]})}),e.jsx("textarea",{className:"share-text",readOnly:!0,value:y}),e.jsxs("div",{className:"share-actions",children:[e.jsx("button",{type:"button",className:"share-btn",onClick:Pe,children:"Copy"}),e.jsx("a",{className:"share-btn whatsapp",href:Ae(),target:"_blank",rel:"noreferrer",children:"WhatsApp"})]})]}),e.jsxs("form",{onSubmit:_e,className:"billing-form",children:[e.jsxs("div",{className:"billing-content",children:[e.jsxs("div",{className:"form-section fade-in-up",children:[e.jsxs("h2",{children:[e.jsx(Ie,{size:20})," Customer Information"]}),e.jsxs("div",{className:"combobox-container",ref:k,children:[e.jsx("label",{className:"combobox-label",children:c?"Selected Customer":"Customer *"}),e.jsxs("div",{className:`combobox-input-wrapper ${c?"has-selection":""}`,children:[e.jsx("input",{type:"text",className:"combobox-input",placeholder:"Search existing customer by name or phone...",value:b,onChange:ge,onFocus:ve}),c&&e.jsx("button",{type:"button",className:"clear-selection-btn",onClick:ne,title:"Clear selection",children:e.jsx(q,{size:16})}),e.jsx(re,{size:18,className:"combobox-arrow"})]}),he&&K.length>0&&e.jsx("div",{className:"combobox-dropdown",children:K.map(s=>e.jsxs("div",{className:"combobox-option",onClick:()=>be(s),children:[e.jsxs("div",{className:"combobox-option-content",children:[e.jsx("span",{className:"combobox-option-name",children:s.name}),e.jsx("span",{className:"combobox-option-detail",children:s.phone})]}),s.pending_balance>0&&e.jsxs("span",{className:"pending-badge",children:["Balance: ",d(s.pending_balance)]})]},s.id))})]})]}),e.jsxs("div",{className:"form-section fade-in-up",children:[e.jsxs("h2",{children:[e.jsx(Re,{size:20})," Bill Items"]}),e.jsxs("div",{className:"combobox-container",ref:R,children:[e.jsx("label",{className:"combobox-label",children:"Add Product"}),e.jsxs("div",{className:"combobox-input-wrapper",children:[e.jsx("input",{type:"text",className:"combobox-input",placeholder:"Search or enter product name...",value:h,onChange:Ne,onFocus:we}),e.jsx(re,{size:18,className:"combobox-arrow"})]}),pe&&z.length>0&&e.jsxs("div",{className:"combobox-dropdown",children:[z.map(s=>e.jsxs("div",{className:"combobox-option",onClick:()=>ye(s),children:[e.jsxs("div",{className:"combobox-option-content",children:[e.jsx("span",{className:"combobox-option-name",children:s.name}),e.jsx("span",{className:"combobox-option-price",children:d(s.price)})]}),s.stock!==void 0&&s.stock<10&&e.jsxs("span",{className:"stock-warning",children:["Low stock: ",s.stock]})]},s.id)),e.jsxs("div",{className:"combobox-option new-option",onClick:()=>{I("new"),f(!1),x({...l,name:h})},children:[e.jsx(ie,{size:16}),e.jsxs("span",{children:["Create new product: ",e.jsx("strong",{children:h})]})]})]})]}),e.jsxs("div",{className:"new-entry-fields",children:[e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"MRP *"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:l.mrp,onChange:s=>x({...l,mrp:s.target.value}),placeholder:"0.00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Quantity"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:l.quantity,onChange:s=>x({...l,quantity:s.target.value})})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Unit"}),e.jsxs("select",{value:l.unit,onChange:s=>x({...l,unit:s.target.value}),children:[e.jsx("option",{value:"pcs",children:"Pieces"}),e.jsx("option",{value:"kg",children:"Kilograms"}),e.jsx("option",{value:"g",children:"Grams"}),e.jsx("option",{value:"l",children:"Liters"}),e.jsx("option",{value:"ml",children:"Milliliters"}),e.jsx("option",{value:"box",children:"Box"}),e.jsx("option",{value:"dozen",children:"Dozen"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Discount %"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",value:l.discount_percent,onChange:s=>x({...l,discount_percent:s.target.value})})]})]}),e.jsxs("button",{type:"button",className:"add-btn",onClick:fe,disabled:!l.name||!l.mrp,children:[e.jsx(ie,{size:16})," Add Product"]})]})]}),i.length>0&&e.jsxs("div",{className:"form-section fade-in-up",children:[e.jsxs("h2",{children:[e.jsx(ce,{size:20})," Items in Bill (",i.length,")"]}),e.jsx("div",{className:"bill-items-table",children:e.jsxs("table",{children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Item"}),e.jsx("th",{children:"MRP"}),e.jsx("th",{children:"Qty"}),e.jsx("th",{children:"Unit"}),e.jsx("th",{children:"Discount %"}),e.jsx("th",{children:"Amount"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:i.map((s,t)=>e.jsxs("tr",{children:[e.jsx("td",{"data-label":"Item",children:e.jsx("input",{type:"text",value:s.name,onChange:a=>N(t,"name",a.target.value),className:"item-name-input"})}),e.jsx("td",{"data-label":"MRP",children:e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.mrp,onChange:a=>N(t,"mrp",a.target.value),className:"amount-input"})}),e.jsx("td",{"data-label":"Qty",children:e.jsx("input",{type:"number",step:"0.01",min:"0",value:s.quantity,onChange:a=>N(t,"quantity",a.target.value),className:"qty-input"})}),e.jsx("td",{"data-label":"Unit",children:e.jsxs("select",{value:s.unit,onChange:a=>N(t,"unit",a.target.value),children:[e.jsx("option",{value:"pcs",children:"Pcs"}),e.jsx("option",{value:"kg",children:"Kg"}),e.jsx("option",{value:"g",children:"G"}),e.jsx("option",{value:"l",children:"L"}),e.jsx("option",{value:"ml",children:"Ml"}),e.jsx("option",{value:"box",children:"Box"}),e.jsx("option",{value:"dozen",children:"Doz"})]})}),e.jsx("td",{"data-label":"Discount %",children:e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",value:s.discount_percent,onChange:a=>N(t,"discount_percent",a.target.value),className:"discount-input"})}),e.jsx("td",{className:"amount-cell","data-label":"Amount",children:d((parseFloat(s.mrp)||0)*(parseFloat(s.quantity)||0)*(1-(parseFloat(s.discount_percent)||0)/100))}),e.jsx("td",{"data-label":"Action",children:e.jsx("button",{type:"button",className:"remove-btn",onClick:()=>Se(t),children:e.jsx(Me,{size:16})})})]},t))})]})})]}),e.jsxs("div",{className:"form-section fade-in-up",children:[e.jsxs("h2",{children:[e.jsx(Oe,{size:20})," Payment Details"]}),e.jsxs("div",{className:"form-row",children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Paid Amount"}),e.jsx("input",{type:"number",step:"0.01",min:"0",value:v,onChange:s=>X(s.target.value),placeholder:"0.00"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Bill Discount %"}),e.jsx("input",{type:"number",step:"0.01",min:"0",max:"100",value:P,onChange:s=>Y(s.target.value)})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Notes (Optional)"}),e.jsx("textarea",{value:Z,onChange:s=>ee(s.target.value),placeholder:"Add any notes...",rows:3})]})]})]}),e.jsxs("div",{className:"billing-summary slide-in-left",children:[e.jsx("h3",{children:"Bill Summary"}),e.jsxs("div",{className:"summary-row",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("span",{children:d(o.subtotal)})]}),e.jsxs("div",{className:"summary-row discount",children:[e.jsx("span",{children:"Item Discounts"}),e.jsxs("span",{children:["- ",d(o.discountAmount)]})]}),e.jsxs("div",{className:"summary-row discount",children:[e.jsxs("span",{children:["Bill Discount (",P,"%)"]}),e.jsxs("span",{children:["- ",d(o.totalAmount<o.subtotal-o.discountAmount?o.subtotal-o.discountAmount-o.totalAmount:0)]})]}),e.jsxs("div",{className:"summary-row total",children:[e.jsx("span",{children:"Total Amount"}),e.jsx("span",{children:d(o.totalAmount)})]}),e.jsxs("div",{className:"summary-row paid",children:[e.jsx("span",{children:"Paid Amount"}),e.jsx("span",{children:d(parseFloat(v)||0)})]}),e.jsxs("div",{className:`summary-row balance ${o.balanceAmount>0?"pending":"paid"}`,children:[e.jsx("span",{children:"Balance"}),e.jsx("span",{children:d(o.balanceAmount)})]}),e.jsx("button",{type:"submit",className:"generate-bill-btn",disabled:M||i.length===0||!(c!=null&&c.id),children:M?e.jsxs(e.Fragment,{children:[e.jsx(Te,{size:20,className:"spinning"}),"Processing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Le,{size:20}),"Generate Bill"]})})]})]})]})}export{ts as default};
